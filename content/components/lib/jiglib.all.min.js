jigLib={};jigLib.extend=function(a,b){for(proto in b.prototype){a.prototype[proto]=b.prototype[proto];}a.prototype.Super=b;};(function(a){a.JConfig={solverType:"ACCUMULATED",boxCollisionsType:"EDGEBASE",rotationType:"DEGREES",aabbDetection:true,doShockStep:false,allowedPenetration:0.01,collToll:0.05,velThreshold:0.7,angVelThreshold:5,posThreshold:0.7,orientThreshold:0.7,deactivationTime:0.2,numPenetrationRelaxationTimesteps:50,numCollisionIterations:4,numContactIterations:8,numConstraintIterations:15};})(jigLib);(function(a){var b=function(c){this.type=c;};b.prototype.type=null;Event.EVENT="JigLibJSEvent";a.JEvent=b;})(jigLib);(function(a){var b=function(c,d){this.Super(b.COLLISION);this.collisionBody=c;this.collisionImpulse=d;};a.extend(b,a.JEvent);b.prototype.collisionBody=null;b.prototype.collisionImpulse=null;b.COLLISION="JigLibJSCollisionEvent";a.JCollisionEvent=b;})(jigLib);(function(a){var b=function(){this._listeners={};};b.prototype._listeners={};b.prototype.addEventListener=function(c,d){if(typeof d!="function"){throw new Error("Invalid argument passed to JEventDispatcher.addEventListener - listener must be a function");}if(typeof(this._listeners[c])=="undefined"||!this._listeners[c] instanceof Array){this._listeners[c]=[];}this._listeners[c].push(d);};b.prototype.removeEventListener=function(f,g){if(!this._listeners[f] instanceof Array){return;}var e=this._listeners[f];for(var d=0,c=e.length;d<c;d++){if(g===e[d]){e.splice(d,1);break;}}};b.prototype.dispatchEvent=function(f){var e=this._listeners[f.type];if(!e||e.length==0){return;}for(var d=0,c=e.length;d<c;d++){e[d].call(this,f);}};a.JEventDispatcher=b;})(jigLib);(function(a){if(typeof Float32Array!="undefined"){glMatrixArrayType=Float32Array;}else{if(typeof WebGLFloatArray!="undefined"){glMatrixArrayType=WebGLFloatArray;}else{glMatrixArrayType=Array;}}var d={};d.create=function(f){var e=new glMatrixArrayType(3);if(f){e[0]=f[0];e[1]=f[1];e[2]=f[2];}return e;};d.set=function(f,e){e[0]=f[0];e[1]=f[1];e[2]=f[2];return e;};d.add=function(f,g,e){if(!e||f==e){f[0]+=g[0];f[1]+=g[1];f[2]+=g[2];return f;}e[0]=f[0]+g[0];e[1]=f[1]+g[1];e[2]=f[2]+g[2];return e;};d.subtract=function(f,g,e){if(!e||f==e){f[0]-=g[0];f[1]-=g[1];f[2]-=g[2];return f;}e[0]=f[0]-g[0];e[1]=f[1]-g[1];e[2]=f[2]-g[2];return e;};d.negate=function(f,e){if(!e){e=f;}e[0]=-f[0];e[1]=-f[1];e[2]=-f[2];return e;};d.scale=function(f,g,e){if(!e||f==e){f[0]*=g;f[1]*=g;f[2]*=g;return f;}e[0]=f[0]*g;e[1]=f[1]*g;e[2]=f[2]*g;return e;};d.normalize=function(h,g){if(!g){g=h;}var f=h[0],j=h[1],i=h[2];var e=Math.sqrt(f*f+j*j+i*i);if(!e){g[0]=0;g[1]=0;g[2]=0;return g;}else{if(e==1){g[0]=f;g[1]=j;g[2]=i;return g;}}e=1/e;g[0]=f*e;g[1]=j*e;g[2]=i*e;return g;};d.cross=function(f,h,m){if(!m){m=f;}var l=f[0],j=f[1],i=f[2];var e=h[0],k=h[1],g=h[2];m[0]=j*g-i*k;m[1]=i*e-l*g;m[2]=l*k-j*e;return m;};d.length=function(f){var e=f[0],h=f[1],g=f[2];return Math.sqrt(e*e+h*h+g*g);};d.dot=function(e,f){return e[0]*f[0]+e[1]*f[1]+e[2]*f[2];};d.direction=function(h,i,g){if(!g){g=h;}var f=h[0]-i[0];var k=h[1]-i[1];var j=h[2]-i[2];var e=Math.sqrt(f*f+k*k+j*j);if(!e){g[0]=0;g[1]=0;g[2]=0;return g;}e=1/e;g[0]=f*e;g[1]=k*e;g[2]=j*e;return g;};d.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]";};var c={};c.create=function(f){var e=new glMatrixArrayType(9);if(f){e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[3];e[4]=f[4];e[5]=f[5];e[6]=f[6];e[7]=f[7];e[8]=f[8];e[9]=f[9];}return e;};c.set=function(f,e){e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[3];e[4]=f[4];e[5]=f[5];e[6]=f[6];e[7]=f[7];e[8]=f[8];return e;};c.identity=function(e){e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=1;e[5]=0;e[6]=0;e[7]=0;e[8]=1;return e;};c.toMat4=function(f,e){if(!e){e=b.create();}e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=0;e[4]=f[3];e[5]=f[4];e[6]=f[5];e[7]=0;e[8]=f[6];e[9]=f[7];e[10]=f[8];e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return e;};c.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+"]";};var b={};b.create=function(f){var e=new glMatrixArrayType(16);if(f){e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[3];e[4]=f[4];e[5]=f[5];e[6]=f[6];e[7]=f[7];e[8]=f[8];e[9]=f[9];e[10]=f[10];e[11]=f[11];e[12]=f[12];e[13]=f[13];e[14]=f[14];e[15]=f[15];}return e;};b.set=function(f,e){e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[3];e[4]=f[4];e[5]=f[5];e[6]=f[6];e[7]=f[7];e[8]=f[8];e[9]=f[9];e[10]=f[10];e[11]=f[11];e[12]=f[12];e[13]=f[13];e[14]=f[14];e[15]=f[15];return e;};b.identity=function(e){e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=1;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=1;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return e;};b.transpose=function(h,g){if(!g||h==g){var l=h[1],j=h[2],i=h[3];var e=h[6],k=h[7];var f=h[11];h[1]=h[4];h[2]=h[8];h[3]=h[12];h[4]=l;h[6]=h[9];h[7]=h[13];h[8]=j;h[9]=e;h[11]=h[14];h[12]=i;h[13]=k;h[14]=f;return h;}g[0]=h[0];g[1]=h[4];g[2]=h[8];g[3]=h[12];g[4]=h[1];g[5]=h[5];g[6]=h[9];g[7]=h[13];g[8]=h[2];g[9]=h[6];g[10]=h[10];g[11]=h[14];g[12]=h[3];g[13]=h[7];g[14]=h[11];g[15]=h[15];return g;};b.determinant=function(s){var l=s[0],k=s[1],i=s[2],g=s[3];var u=s[4],t=s[5],r=s[6],q=s[7];var p=s[8],o=s[9],n=s[10],m=s[11];var j=s[12],h=s[13],f=s[14],e=s[15];return j*o*r*g-p*h*r*g-j*t*n*g+u*h*n*g+p*t*f*g-u*o*f*g-j*o*i*q+p*h*i*q+j*k*n*q-l*h*n*q-p*k*f*q+l*o*f*q+j*t*i*m-u*h*i*m-j*k*r*m+l*h*r*m+u*k*f*m-l*t*f*m-p*t*i*e+u*o*i*e+p*k*r*e-l*o*r*e-u*k*n*e+l*t*n*e;};b.inverse=function(z,o){if(!o){o=z;}var G=z[0],E=z[1],D=z[2],B=z[3];var h=z[4],g=z[5],f=z[6],e=z[7];var w=z[8],v=z[9],u=z[10],t=z[11];var I=z[12],H=z[13],F=z[14],C=z[15];var s=G*g-E*h;var r=G*f-D*h;var q=G*e-B*h;var p=E*f-D*g;var n=E*e-B*g;var m=D*e-B*f;var l=w*H-v*I;var k=w*F-u*I;var j=w*C-t*I;var i=v*F-u*H;var A=v*C-t*H;var y=u*C-t*F;var x=1/(s*y-r*A+q*i+p*j-n*k+m*l);o[0]=(g*y-f*A+e*i)*x;o[1]=(-E*y+D*A-B*i)*x;o[2]=(H*m-F*n+C*p)*x;o[3]=(-v*m+u*n-t*p)*x;o[4]=(-h*y+f*j-e*k)*x;o[5]=(G*y-D*j+B*k)*x;o[6]=(-I*m+F*q-C*r)*x;o[7]=(w*m-u*q+t*r)*x;o[8]=(h*A-g*j+e*l)*x;o[9]=(-G*A+E*j-B*l)*x;o[10]=(I*n-H*q+C*s)*x;o[11]=(-w*n+v*q-t*s)*x;o[12]=(-h*i+g*k-f*l)*x;o[13]=(G*i-E*k+D*l)*x;o[14]=(-I*p+H*r-F*s)*x;o[15]=(w*p-v*r+u*s)*x;return o;};b.toRotationMat=function(f,e){if(!e){e=b.create();}e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[3];e[4]=f[4];e[5]=f[5];e[6]=f[6];e[7]=f[7];e[8]=f[8];e[9]=f[9];e[10]=f[10];e[11]=f[11];e[12]=0;e[13]=0;e[14]=0;e[15]=1;return e;};b.toMat3=function(f,e){if(!e){e=c.create();}e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[4];e[4]=f[5];e[5]=f[6];e[6]=f[8];e[7]=f[9];e[8]=f[10];return e;};b.toInverseMat3=function(r,p){var i=r[0],h=r[1],g=r[2];var t=r[4],s=r[5],q=r[6];var m=r[8],l=r[9],k=r[10];var j=k*s-q*l;var f=-k*t+q*m;var o=l*t-s*m;var n=i*j+h*f+g*o;if(!n){return null;}var e=1/n;if(!p){p=c.create();}p[0]=j*e;p[1]=(-k*h+g*l)*e;p[2]=(q*h-g*s)*e;p[3]=f*e;p[4]=(k*i-g*m)*e;p[5]=(-q*i+g*t)*e;p[6]=o*e;p[7]=(-l*i+h*m)*e;p[8]=(s*i-h*t)*e;return p;};b.multiply=function(D,m,n){if(!n){n=D;}var K=D[0],J=D[1],H=D[2],F=D[3];var l=D[4],k=D[5],j=D[6],i=D[7];var z=D[8],y=D[9],x=D[10],w=D[11];var M=D[12],L=D[13],I=D[14],G=D[15];var u=m[0],s=m[1],q=m[2],o=m[3];var E=m[4],C=m[5],B=m[6],A=m[7];var h=m[8],g=m[9],f=m[10],e=m[11];var v=m[12],t=m[13],r=m[14],p=m[15];n[0]=u*K+s*l+q*z+o*M;n[1]=u*J+s*k+q*y+o*L;n[2]=u*H+s*j+q*x+o*I;n[3]=u*F+s*i+q*w+o*G;n[4]=E*K+C*l+B*z+A*M;n[5]=E*J+C*k+B*y+A*L;n[6]=E*H+C*j+B*x+A*I;n[7]=E*F+C*i+B*w+A*G;n[8]=h*K+g*l+f*z+e*M;n[9]=h*J+g*k+f*y+e*L;n[10]=h*H+g*j+f*x+e*I;n[11]=h*F+g*i+f*w+e*G;n[12]=v*K+t*l+r*z+p*M;n[13]=v*J+t*k+r*y+p*L;n[14]=v*H+t*j+r*x+p*I;n[15]=v*F+t*i+r*w+p*G;return n;};b.multiplyVec3=function(h,g,f){if(!f){f=g;}var e=g[0],j=g[1],i=g[2];f[0]=h[0]*e+h[4]*j+h[8]*i+h[12];f[1]=h[1]*e+h[5]*j+h[9]*i+h[13];f[2]=h[2]*e+h[6]*j+h[10]*i+h[14];return f;};b.multiplyVec4=function(i,h,g){if(!g){g=h;}var e=h[0],k=h[1],j=h[2],f=h[3];g[0]=i[0]*e+i[4]*k+i[8]*j+i[12]*f;g[1]=i[1]*e+i[5]*k+i[9]*j+i[13]*f;g[2]=i[2]*e+i[6]*k+i[10]*j+i[14]*f;g[4]=i[4]*e+i[7]*k+i[11]*j+i[15]*f;return g;};b.translate=function(r,m,k){var l=m[0],j=m[1],i=m[2];if(!k||r==k){r[12]=r[0]*l+r[4]*j+r[8]*i+r[12];r[13]=r[1]*l+r[5]*j+r[9]*i+r[13];r[14]=r[2]*l+r[6]*j+r[10]*i+r[14];r[15]=r[3]*l+r[7]*j+r[11]*i+r[15];return r;}var v=r[0],u=r[1],t=r[2],s=r[3];var h=r[4],g=r[5],f=r[6],e=r[7];var q=r[8],p=r[9],o=r[10],n=r[11];k[0]=v;k[1]=u;k[2]=t;k[3]=s;k[4]=h;k[5]=g;k[6]=f;k[7]=e;k[8]=q;k[9]=p;k[10]=o;k[11]=n;k[12]=v*l+h*j+q*i+r[12];k[13]=u*l+g*j+p*i+r[13];k[14]=t*l+f*j+o*i+r[14];k[15]=s*l+e*j+n*i+r[15];return k;};b.scale=function(h,g,f){var e=g[0],j=g[1],i=g[2];if(!f||h==f){h[0]*=e;h[1]*=e;h[2]*=e;h[3]*=e;h[4]*=j;h[5]*=j;h[6]*=j;h[7]*=j;h[8]*=i;h[9]*=i;h[10]*=i;h[11]*=i;return h;}f[0]=h[0]*e;f[1]=h[1]*e;f[2]=h[2]*e;f[3]=h[3]*e;f[4]=h[4]*j;f[5]=h[5]*j;f[6]=h[6]*j;f[7]=h[7]*j;f[8]=h[8]*i;f[9]=h[9]*i;f[10]=h[10]*i;f[11]=h[11]*i;f[12]=h[12];f[13]=h[13];f[14]=h[14];f[15]=h[15];return f;};b.rotate=function(I,G,e,o){var p=e[0],n=e[1],m=e[2];var E=Math.sqrt(p*p+n*n+m*m);if(!E){return null;}if(E!=1){E=1/E;p*=E;n*=E;m*=E;}var w=Math.sin(G);var K=Math.cos(G);var v=1-K;var O=I[0],N=I[1],M=I[2],L=I[3];var l=I[4],k=I[5],j=I[6],i=I[7];var D=I[8],C=I[9],B=I[10],A=I[11];var u=p*p*v+K,r=n*p*v+m*w,q=m*p*v-n*w;var J=p*n*v-m*w,H=n*n*v+K,F=m*n*v+p*w;var h=p*m*v+n*w,g=n*m*v-p*w,f=m*m*v+K;if(!o){o=I;}else{if(I!=o){o[12]=I[12];o[13]=I[13];o[14]=I[14];o[15]=I[15];}}o[0]=O*u+l*r+D*q;o[1]=N*u+k*r+C*q;o[2]=M*u+j*r+B*q;o[3]=L*u+i*r+A*q;o[4]=O*J+l*H+D*F;o[5]=N*J+k*H+C*F;o[6]=M*J+j*H+B*F;o[7]=L*J+i*H+A*F;o[8]=O*h+l*g+D*f;o[9]=N*h+k*g+C*f;o[10]=M*h+j*g+B*f;o[11]=L*h+i*g+A*f;return o;};b.rotateX=function(n,e,l){var q=Math.sin(e);var j=Math.cos(e);var p=n[4],o=n[5],m=n[6],k=n[7];var i=n[8],h=n[9],g=n[10],f=n[11];if(!l){l=n;}else{if(n!=l){l[0]=n[0];l[1]=n[1];l[2]=n[2];l[3]=n[3];l[12]=n[12];l[13]=n[13];l[14]=n[14];l[15]=n[15];}}l[4]=p*j+i*q;l[5]=o*j+h*q;l[6]=m*j+g*q;l[7]=k*j+f*q;l[8]=p*-q+i*j;l[9]=o*-q+h*j;l[10]=m*-q+g*j;l[11]=k*-q+f*j;return l;};b.rotateY=function(p,h,o){var q=Math.sin(h);var n=Math.cos(h);var i=p[0],g=p[1],f=p[2],e=p[3];var m=p[8],l=p[9],k=p[10],j=p[11];if(!o){o=p;}else{if(p!=o){o[4]=p[4];o[5]=p[5];o[6]=p[6];o[7]=p[7];o[12]=p[12];o[13]=p[13];o[14]=p[14];o[15]=p[15];}}o[0]=i*n+m*-q;o[1]=g*n+l*-q;o[2]=f*n+k*-q;o[3]=e*n+j*-q;o[8]=i*q+m*n;o[9]=g*q+l*n;o[10]=f*q+k*n;o[11]=e*q+j*n;return o;};b.rotateZ=function(o,h,l){var q=Math.sin(h);var j=Math.cos(h);var i=o[0],g=o[1],f=o[2],e=o[3];var p=o[4],n=o[5],m=o[6],k=o[7];if(!l){l=o;}else{if(o!=l){l[8]=o[8];l[9]=o[9];l[10]=o[10];l[11]=o[11];l[12]=o[12];l[13]=o[13];l[14]=o[14];l[15]=o[15];}}l[0]=i*j+p*q;l[1]=g*j+n*q;l[2]=f*j+m*q;l[3]=e*j+k*q;l[4]=i*-q+p*j;l[5]=g*-q+n*j;l[6]=f*-q+m*j;l[7]=e*-q+k*j;return l;};b.frustum=function(f,n,e,l,i,h,m){if(!m){m=b.create();}var j=(n-f);var g=(l-e);var k=(h-i);m[0]=(i*2)/j;m[1]=0;m[2]=0;m[3]=0;m[4]=0;m[5]=(i*2)/g;m[6]=0;m[7]=0;m[8]=(n+f)/j;m[9]=(l+e)/g;m[10]=-(h+i)/k;m[11]=-1;m[12]=0;m[13]=0;m[14]=-(h*i*2)/k;m[15]=0;return m;};b.perspective=function(g,f,j,e,h){var k=j*Math.tan(g*Math.PI/360);var i=k*f;return b.frustum(-i,i,-k,k,j,e,h);};b.ortho=function(f,n,e,l,i,h,m){if(!m){m=b.create();}var j=(n-f);var g=(l-e);var k=(h-i);m[0]=2/j;m[1]=0;m[2]=0;m[3]=0;m[4]=0;m[5]=2/g;m[6]=0;m[7]=0;m[8]=0;m[9]=0;m[10]=-2/k;m[11]=0;m[12]=-(f+n)/j;m[13]=-(l+e)/g;m[14]=-(h+i)/k;m[15]=1;return m;};b.lookAt=function(z,A,l,k){if(!k){k=b.create();}var x=z[0],v=z[1],s=z[2],j=l[0],i=l[1],h=l[2],r=A[0],q=A[1],p=A[2];if(x==r&&v==q&&s==p){return b.identity(k);}var o,n,m,y,w,u,g,f,e,t;o=x-A[0];n=v-A[1];m=s-A[2];t=1/Math.sqrt(o*o+n*n+m*m);o*=t;n*=t;m*=t;y=i*m-h*n;w=h*o-j*m;u=j*n-i*o;t=Math.sqrt(y*y+w*w+u*u);if(!t){y=0;w=0;u=0;}else{t=1/t;y*=t;w*=t;u*=t;}g=n*u-m*w;f=m*y-o*u;e=o*w-n*y;t=Math.sqrt(g*g+f*f+e*e);if(!t){g=0;f=0;e=0;}else{t=1/t;g*=t;f*=t;e*=t;}k[0]=y;k[1]=g;k[2]=o;k[3]=0;k[4]=w;k[5]=f;k[6]=n;k[7]=0;k[8]=u;k[9]=e;k[10]=m;k[11]=0;k[12]=-(y*x+w*v+u*s);k[13]=-(g*x+f*v+e*s);k[14]=-(o*x+n*v+m*s);k[15]=1;return k;};b.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]";};quat4={};quat4.create=function(f){var e=new glMatrixArrayType(4);if(f){e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[3];}return e;};quat4.set=function(f,e){e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[3];return e;};quat4.calculateW=function(g,f){var e=g[0],i=g[1],h=g[2];if(!f||g==f){g[3]=-Math.sqrt(Math.abs(1-e*e-i*i-h*h));return g;}f[0]=e;f[1]=i;f[2]=h;f[3]=-Math.sqrt(Math.abs(1-e*e-i*i-h*h));return f;};quat4.inverse=function(f,e){if(!e||f==e){f[0]*=1;f[1]*=1;f[2]*=1;return f;}e[0]=-f[0];e[1]=-f[1];e[2]=-f[2];e[3]=f[3];return e;};quat4.length=function(g){var e=g[0],i=g[1],h=g[2],f=g[3];return Math.sqrt(e*e+i*i+h*h+f*f);};quat4.normalize=function(i,h){if(!h){h=i;}var f=i[0],k=i[1],j=i[2],g=i[3];var e=Math.sqrt(f*f+k*k+j*j+g*g);if(e==0){h[0]=0;h[1]=0;h[2]=0;h[3]=0;return h;}e=1/e;h[0]=f*e;h[1]=k*e;h[2]=j*e;h[3]=g*e;return h;};quat4.multiply=function(f,h,o){if(!o){o=f;}var m=f[0],l=f[1],k=f[2],n=f[3];var i=h[0],g=h[1],e=h[2],j=h[3];o[0]=m*j+n*i+l*e-k*g;o[1]=l*j+n*g+k*i-m*e;o[2]=k*j+n*e+m*g-l*i;o[3]=n*j-m*i-l*g-k*e;return o;};quat4.multiplyVec3=function(f,h,r){if(!r){r=h;}var q=h[0],p=h[1],o=h[2];var m=f[0],l=f[1],k=f[2],n=f[3];var i=n*q+l*o-k*p;var g=n*p+k*q-m*o;var e=n*o+m*p-l*q;var j=-m*q-l*p-k*o;r[0]=i*n+j*-m+g*-k-e*-l;r[1]=g*n+j*-l+e*-m-i*-k;r[2]=e*n+j*-k+i*-l-g*-m;return r;};quat4.toMat3=function(e,l){if(!l){l=c.create();}var m=e[0],k=e[1],j=e[2],n=e[3];var r=m+m;var f=k+k;var o=j+j;var i=m*r;var h=m*f;var g=m*o;var q=k*f;var p=k*o;var u=j*o;var v=n*r;var t=n*f;var s=n*o;l[0]=1-(q+u);l[1]=h-s;l[2]=g+t;l[3]=h+s;l[4]=1-(i+u);l[5]=p-v;l[6]=g-t;l[7]=p+v;l[8]=1-(i+q);return l;};quat4.toMat4=function(e,l){if(!l){l=b.create();}var m=e[0],k=e[1],j=e[2],n=e[3];var r=m+m;var f=k+k;var o=j+j;var i=m*r;var h=m*f;var g=m*o;var q=k*f;var p=k*o;var u=j*o;var v=n*r;var t=n*f;var s=n*o;l[0]=1-(q+u);l[1]=h-s;l[2]=g+t;l[3]=0;l[4]=h+s;l[5]=1-(i+u);l[6]=p-v;l[7]=0;l[8]=g-t;l[9]=p+v;l[10]=1-(i+q);l[11]=0;l[12]=0;l[13]=0;l[14]=0;l[15]=1;return l;};quat4.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]";};a.GLMatrix=b;})(jigLib);(function(a){var b=function(){throw new Error("Vector3DUtil is a utility class and should not be instantiated");};b.X_AXIS=[1,0,0,0];b.Y_AXIS=[0,1,0,0];b.Z_AXIS=[0,0,1,0];b.add=function(g,e){return[g[0]+e[0],g[1]+e[1],g[2]+e[2],g[3]+e[3]];};b.subtract=function(g,e){return[g[0]-e[0],g[1]-e[1],g[2]-e[2],g[3]-e[3]];};b.decrementBy=function(g,e){g[0]-=e[0];g[1]-=e[1];g[2]-=e[2];g[3]-=e[3];};b.IncrementBy=function(g,e){g[0]+=e[0];g[1]+=e[1];g[2]+=e[2];g[3]+=e[3];};b.distance=function(l,j){var h=Math;var g=h.pow;var e=g(l[0]-j[0],2);var k=g(l[1]-j[1],2);var i=g(l[2]-j[2],2);return h.sqrt(e+k+i);};b.dotProduct=function(g,e){return g[0]*e[0]+g[1]*e[1]+g[2]*e[2];};b.crossProduct=function(g,e){return[g[1]*e[2]-g[2]*e[1],g[2]*e[0]-g[0]*e[2],g[0]*e[1]-g[1]*e[0],0];};b.get_length=function(e){var g=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];return(g>0)?Math.pow(g,0.5):0;};b.get_lengthSquared=function(e){var g=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];return g;};b.normalize=function(e){f=b.get_length(e);e[0]/=f;e[1]/=f;e[2]/=f;return f;};b.negate=function(e){e[0]*=-1;e[1]*=-1;e[2]*=-1;return e;};b.scaleBy=function(e,g){e[0]*=g;e[1]*=g;e[2]*=g;};b.getSum=function(g){var e=Math.abs;return e(g[0])+e(g[1])+e(g[2]);};b.limitSum=function(g,h){var e=Math.abs;c=b.getSum(g);if(h>=c){return;}f=h/c;b.scaleBy(g,f);};b.project=function(e){e[0]/=e[3];e[1]/=e[3];e[2]/=e[3];e[3]=1;};b.angleBetween=function(i,g){var h=i.slice(0);var e=g.slice(0);b.normalize(h);b.normalize(e);d=b.dotProduct(h,e);if(d<-1){d=-1;}else{if(d>1){d=1;}}return Math.acos(d);};b.equals=function(h,g,e){if(!e){return(h[0]==g[0]&&h[1]==g[1]&&h[2]==g[2]);}else{return(h[0]==g[0]&&h[1]==g[1]&&h[2]==g[2]&&h[3]==g[3]);}};b.create=function(e,j,i,g){var h=[];h[0]=(e)?e:0;h[1]=(j)?j:0;h[2]=(i)?i:0;h[3]=(g)?g:0;return h;};a.Vector3DUtil=b;})(jigLib);(function(b){var c=b.Vector3DUtil;var a=b.GLMatrix;var d=function(e){if(e){this.glmatrix=a.create(e);}else{this.glmatrix=a.create([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);}};d.prototype.glmatrix=null;d.prototype.get_determinant=function(){return a.determinant(this.glmatrix);};d.prototype.prepend=function(e){a.multiply(e.glmatrix,this.glmatrix,this.glmatrix);};d.prototype.append=function(e){a.multiply(this.glmatrix,e.glmatrix);};d.prototype.angleAxis=function(s,j){var u,p,v,t,o,f,g,q,k;s=s/(3.14159*2);var n=j[0];var m=j[1];var l=j[2];var i=Math.cos(s);var h=1-i;var e=Math.sin(s);g=n*e;q=m*e;k=l*e;u=n*n;p=m*m;v=l*l;t=n*m;o=m*l;f=l*n;var r=[(h*u)+i,(h*t)-k,(h*f)+q,0,(h*t)+k,(h*p)+i,(h*o)-g,0,(h*f)-q,(h*o)+g,(h*v)+i,0,0,0,0,1];return new d(r);};d.prototype.rotate=function(g,f){var e=this.clone();a.rotate(e.glmatrix,g,f);return e;};d.prototype.translateMatrix=function(e){return new d([1,0,0,e[0],0,1,0,e[1],0,0,1,e[2],0,0,0,1]);};d.prototype.scaleMatrix=function(e){return new d([e[0],0,0,0,0,e[1],0,0,0,0,e[2],0,0,0,0,1]);};d.prototype.appendRotation=function(h,g,e){h=h/(3.14159*2);c.negate(g);if(e){var f=c.negate(e.slice(0));this.appendTranslation(f[0],f[1],f[2]);}a.rotate(this.glmatrix,h,g);if(e){this.appendTranslation(e[0],e[1],e[2]);}};d.prototype.prependRotation=function(g,f,e){if(e){this.prepend(this.translateMatrix(c.negate(e.slice(0))));}this.prepend(this.angleAxis(g,f));if(e){this.prepend(this.translateMatrix(e));}};d.prototype.appendScale=function(e,g,f){a.scale(this.glmatrix,[e,g,f]);};d.prototype.prependScale=function(e,g,f){this.prepend(this.scaleMatrix([e,g,f]));};d.prototype.appendTranslation=function(e,g,f){this.append(this.translateMatrix([e,g,f]));};d.prototype.prependTranslation=function(e,g,f){this.prepend(this.translateMatrix([e,g,f]));};d.prototype.identity=function(){a.identity(this.glmatrix);};d.prototype.transpose=function(){a.transpose(this.glmatrix);};d.prototype.invert=function(){a.inverse(this.glmatrix);};d.prototype.clone=function(){return new d(this.glmatrix);};d.prototype.transformVector=function(g){var f=g[0];var i=g[1];var h=g[2];var e=this.glmatrix;return[e[0]*f+e[1]*i+e[2]*h+e[3],e[4]*f+e[5]*i+e[6]*h+e[7],e[8]*f+e[9]*i+e[10]*h+e[11]];};b.Matrix3D=d;})(jigLib);(function(a){var c=a.Vector3DUtil;var b={};b.NUM_TINY=0.00001;b.NUM_HUGE=100000;b.getScaleVector=function(d,e){return[d[0]*e,d[1]*e,d[2]*e,d[3]];};b.getDivideVector=function(e,d){return(d)?[e[0]/d,e[1]/d,e[2]/d,0]:[0,0,0,0];};b.getNormal=function(d,f,e){return c.normalize(c.crossProduct(c.subtract(f,d),c.subtract(e,f)));};b.copyFromArray=function(e,d){if(d.length>=3){e=d.slice(0);}};b.getLimiteNumber=function(e,f,d){var g=e;if(g<f){g=f;}else{if(g>d){g=d;}}return g;};a.JNumber3D=b;})(jigLib);(function(b){var c=b.Vector3DUtil;var d=b.Matrix3D;var a={};a.getTranslationMatrix=function(e,h,g){var f=new d();f.appendTranslation(e,h,g);return f;};a.getScaleMatrix=function(e,h,g){var f=new d();f.prependScale(e,h,g);return f;};a.getRotationMatrix=function(e,j,i,g,f){var h=new d();h.appendRotation(g,c.create(e,j,i,0),f);return h;};a.getInverseMatrix=function(e){var f=e.clone();f.invert();return f;};a.getTransposeMatrix=function(e){var f=e.clone();f.transpose();return f;};a.getAppendMatrix3D=function(f,e){var g=f.clone();g.append(e);return g;};a.getPrependMatrix=function(f,e){var g=f.clone();g.prepend(e);return g;};a.getSubMatrix=function(f,e){var g=[16];for(var h=0;h<16;h++){g[h]=f.glmatrix[h]-e.glmatrix[h];}return new d(g);};a.getRotationMatrixAxis=function(f,e){var g=new d();g.appendRotation(f,e?e:c.X_AXIS);return g;};a.getCols=function(g){var e=g.glmatrix;var f=[];f[0]=c.create(e[0],e[4],e[8],0);f[1]=c.create(e[1],e[5],e[9],0);f[2]=c.create(e[2],e[6],e[10],0);return f;};a.multiplyVector=function(j,e){var h=e[0];var g=e[1];var f=e[2];if(h==0&&g==0&&f==0){return;}var i=j.glmatrix;e[0]=h*i[0]+g*i[1]+f*i[2]+i[3];e[1]=h*i[4]+g*i[5]+f*i[6]+i[7];e[2]=h*i[8]+g*i[9]+f*i[10]+i[11];};b.JMatrix3D=a;})(jigLib);(function(a){var c=a.Vector3DUtil;var b={};b.fromNormalAndPoint=function(f,d){var e=c.create(f[0],f[1],f[2],0);e[3]=-(e[0]*d[0]+e[1]*d[1]+e[2]*d[2]);return f;};b.getIntersectionLine=function(f,e,i){var h=f[0]*e[0]+f[1]*e[1]+f[2]*e[2]-f[3];var g=f[0]*i[0]+f[1]*i[1]+f[2]*i[2]-f[3];var d=g/(g-h);return[i[0]+(e[0]-i[0])*d,i[1]+(e[1]-i[1])*d,i[2]+(e[2]-i[2])*d,0];};b.getLimiteNumber=function(e,f,d){var g=e;if(g<f){g=f;}else{if(g>d){g=d;}}return g;};b.wrap=function(f,e,d){var g=d-e;if(f>g){f=f/g;f=f-Math.floor(f);f=f*g;}return f;};b.unproject=function(j,e,f,i,g){var h=(e*f)/e;var d=c.create(i/h,-g/h,e,0);return j.transformVector(d);};a.JMath3D=b;})(jigLib);(function(a){var c=a.Vector3DUtil;var d=a.RigidBody;var b=function(f,e,g){if(f==undefined){f=0;}this.frac=f;this.position=e?e:[0,0,0];this.normal=g?g:[0,0,0];};a.CollOutData=b;})(jigLib);(function(b){var c=b.Vector3DUtil;var d=b.RigidBody;var a=function(e,h,g,f){if(e==undefined){e=0;}this.Super(e,position,g);this.rigidBody=f;};b.extend(a,b.CollOutData);b.CollOutBodyData=a;})(jigLib);(function(a){var d=a.Vector3DUtil;var b=a.JAABox;var c=a.JNumber3D;var e=function(f){childCellIndices=[];triangleIndices=[];this.clear();if(f){AABox=f.clone();}else{AABox=new b();}this._points=AABox.getAllPoints();this._egdes=AABox.get_edges();};e.prototype.NUM_CHILDREN=8;e.prototype.childCellIndices=null;e.prototype.triangleIndices=null;e.prototype.AABox;e.prototype._points=null;e.prototype._egdes=null;e.prototype.isLeaf=function(){return this.childCellIndices[0]==-1;};e.prototype.clear=function(){for(var f=0;f<this.NUM_CHILDREN;f++){this.childCellIndices[f]=-1;}this.triangleIndices.splice(0,this.triangleIndices.length);};e.prototype.get_points=function(){return this._points;};e.prototype.get_egdes=function(){return this._egdes;};a.OctreeCell=e;})(jigLib);(function(b){var a=function(d,c,e){this.i0=d;this.i1=c;this.i2=e;};b.TriangleVertexIndices=a;})(jigLib);(function(a){var b=function(){};b.prototype.pair=null;b.prototype.impulse=null;a.ContactData=b;})(jigLib);(function(a){var b=function(d,c){this.ind0=d;this.ind1=c;};a.EdgeData=b;})(jigLib);(function(a){var c=a.Vector3DUtil;var b=a.JMath3D;var d=function(f,e){if(!f){f=[0,0,0];}if(!e){e=[0,1,0];}this.position=f.slice(0);this.normal=e.slice(0);this.distance=c.dotProduct(this.position,this.normal);};d.prototype.position=null;d.prototype.normal=null;d.prototype.distance=null;d.prototype.pointPlaneDistance=function(e){return c.dotProduct(this.normal,e)-this.distance;};d.prototype.setWithNormal=function(f,e){this.position=f.slice(0);this.normal=e.slice(0);this.distance=c.dotProduct(this.position,this.normal);};d.prototype.setWithPoint=function(g,f,e){this.position=g.slice(0);var j=c.subtract(f,g);var i=c.subtract(e,g);this.normal=c.crossProduct(j,i);var h=c.get_length(this.normal);if(h<b.NUM_TINY){this.normal=new Vector3D(0,1,0);this.distance=0;}else{c.scaleBy(this.normal,1/h);this.distance=c.dotProduct(g,this.normal);}};a.PlaneData=d;})(jigLib);(function(a){var b=function(){};b.prototype.min=null;b.prototype.max=null;b.prototype.flag=null;b.prototype.depth=null;a.SpanData=b;})(jigLib);(function(c){var b=c.PhysicsSystem;var a=function(d){if(d){this.speed=d;}this.inittime=(new Date()).getTime();this.physicsSystem=b.getInstance();};a.prototype.speed=5;a.prototype.inittime=null;a.prototype.physicsSystem=null;a.prototype.addBody=function(d){this.physicsSystem.addBody(d);};a.prototype.removeBody=function(d){physicsSystem.removeBody(d);};a.prototype.get_engine=function(){return this.physicsSystem;};a.prototype.step=function(){var d=(new Date()).getTime();deltaTime=((d-this.initTime)/1000)*this.speed;this.initTime=d;this.physicsSystem.integrate(deltaTime);};c.AbstractPhysics=a;})(jigLib);(function(b){var c=b.Matrix3D;function a(){this.matrix=new c();}a.prototype.matrix=null;a.prototype.get_transform=function(){return this.matrix;};a.prototype.set_transform=function(d){this.matrix=d;};b.ISkin3D=a;})(jigLib);(function(a){var b=function(){};b.prototype.get_minW=function(){};b.prototype.get_minH=function(){};b.prototype.get_maxW=function(){};b.prototype.get_maxH=function(){};b.prototype.get_dw=function(){};b.prototype.get_dh=function(){};b.prototype.get_sw=function(){};b.prototype.get_sh=function(){};b.prototype.get_heights=function(){};a.ITerrain=b;})(jigLib);(function(a){var e=a.Vector3DUtil;var c=a.JNumber3D;var d=a.EdgeData;var b=function(g,f){if(g){this._minPos=g.slice(0);this._maxPos=f.slice(0);}};b.prototype._minPos=null;b.prototype._maxPos=null;b.prototype.get_minPos=function(){return this._minPos;};b.prototype.set_minPos=function(f){this._minPos=f.slice(0);};b.prototype.get_maxPos=function(){return this._maxPos;};b.prototype.set_maxPos=function(f){this._maxPos=f.slice(0);};b.prototype.get_sideLengths=function(){var f=this._maxPos.slice(0);e.subtract(f,this._minPos);return f;};b.prototype.get_centrePos=function(){var f=this._minPos.slice(0);return c.getScaleVector(e.add(f,this._maxPos),0.5);};b.prototype.getAllPoints=function(){var f,g;var h;f=this.get_centrePos();g=this.get_sideLengths().slice(0);e.scaleBy(g,0.5);h=[];h[0]=e.add(f,[g[0],-g[1],g[2]]);h[1]=e.add(f,[g[0],g[1],g[2]]);h[2]=e.add(f,[-g[0],-g[1],g[2]]);h[3]=e.add(f,[-g[0],g[1],g[2]]);h[4]=e.add(f,[-g[0],-g[1],-g[2]]);h[5]=e.add(f,[-g[0],g[1],-g[2]]);h[6]=e.add(f,[g[0],-g[1],-g[2]]);h[7]=e.add(f,[g[0],g[1],-g[2]]);return h;};b.prototype.get_edges=function(){return[new d(0,1),new d(0,2),new d(0,6),new d(2,3),new d(2,4),new d(6,7),new d(6,4),new d(1,3),new d(1,7),new d(3,5),new d(7,5),new d(4,5)];};b.prototype.move=function(f){e.add(this._minPos,f);e.add(this._maxPos,f);};b.prototype.clear=function(){this._minPos=e.create(c.NUM_HUGE,c.NUM_HUGE,c.NUM_HUGE,0);this._maxPos=e.create(-c.NUM_HUGE,-c.NUM_HUGE,-c.NUM_HUGE,0);};b.prototype.clone=function(){return new b(this._minPos,this._maxPos);};b.prototype.addPoint=function(h){var g=this._minPos;var f=this._maxPos;if(h[0]<g[0]){g[0]=h[0]-c.NUM_TINY;}if(h[0]>f[0]){f[0]=h[0]+c.NUM_TINY;}if(h[1]<g[1]){g[1]=h[1]-c.NUM_TINY;}if(h[1]>f[1]){f[1]=h[1]+c.NUM_TINY;}if(h[2]<g[2]){g[2]=h[2]-c.NUM_TINY;}if(h[2]>f[2]){f[2]=h[2]+c.NUM_TINY;}};b.prototype.addBox=function(f){var g=f.getCornerPoints(f.get_currentState());this.addPoint(g[0]);this.addPoint(g[1]);this.addPoint(g[2]);this.addPoint(g[3]);this.addPoint(g[4]);this.addPoint(g[5]);this.addPoint(g[6]);this.addPoint(g[7]);};b.prototype.addSphere=function(f){var h=this._minPos;var g=this._maxPos;if(f.get_currentState().position[0]-f.get_radius()<h[0]){h[0]=(f.get_currentState().position[0]-f.get_radius())-c.NUM_TINY;}if(f.get_currentState().position[0]+f.get_radius()>g[0]){g[0]=(f.get_currentState().position[0]+f.get_radius())+c.NUM_TINY;}if(f.get_currentState().position[1]-f.get_radius()<h[1]){h[1]=(f.get_currentState().position[1]-f.get_radius())-c.NUM_TINY;}if(f.get_currentState().position[1]+f.get_radius()>g[1]){g[1]=(f.get_currentState().position[1]+f.get_radius())+c.NUM_TINY;}if(f.get_currentState().position[2]-f.get_radius()<h[2]){h[2]=(f.get_currentState().position[2]-f.get_radius())-c.NUM_TINY;}if(f.get_currentState().position[2]+f.get_radius()>g[2]){g[2]=(f.get_currentState().position[2]+f.get_radius())+c.NUM_TINY;}};b.prototype.addCapsule=function(g){var i=g.getBottomPos(g.get_currentState());var h=this._minPos;var f=this._maxPos;if(i[0]-g.get_radius()<h[0]){h[0]=(i[0]-g.get_radius())-c.NUM_TINY;}if(i[0]+g.get_radius()>f[0]){f[0]=(i[0]+g.get_radius())+c.NUM_TINY;}if(i[1]-g.get_radius()<h[1]){h[1]=(i[1]-g.get_radius())-c.NUM_TINY;}if(i[1]+g.get_radius()>f[1]){f[1]=(i[1]+g.get_radius())+c.NUM_TINY;}if(i[2]-g.get_radius()<h[2]){h[2]=(i[2]-g.get_radius())-c.NUM_TINY;}if(i[2]+g.get_radius()>f[2]){f[2]=(i[2]+g.get_radius())+c.NUM_TINY;}i=g.getEndPos(g.get_currentState());if(i[0]-g.get_radius()<h[0]){h[0]=(i[0]-g.get_radius())-c.NUM_TINY;}if(i[0]+g.get_radius()>f[0]){f[0]=(i[0]+g.get_radius())+c.NUM_TINY;}if(i[1]-g.get_radius()<h[1]){h[1]=(i[1]-g.get_radius())-c.NUM_TINY;}if(i[1]+g.get_radius()>f[1]){f[1]=(i[1]+g.get_radius())+c.NUM_TINY;}if(i[2]-g.get_radius()<h[2]){h[2]=(i[2]-g.get_radius())-c.NUM_TINY;}if(i[2]+g.get_radius()>f[2]){f[2]=(i[2]+g.get_radius())+c.NUM_TINY;}};b.prototype.addSegment=function(f){this.addPoint(f.origin);this.addPoint(f.getEnd());};b.prototype.overlapTest=function(h){var g=this._minPos;var f=this._maxPos;return((g[2]>=h.get_maxPos()[2])||(f[2]<=h.get_minPos()[2])||(g[1]>=h.get_maxPos()[1])||(f[1]<=h.get_minPos()[1])||(g[0]>=h.get_maxPos()[0])||(f[0]<=h.get_minPos()[0]))?false:true;};b.prototype.isPointInside=function(h){var g=this._minPos;var f=this._maxPos;return((h[0]>=g[0])&&(h[0]<=f[0])&&(h[1]>=g[1])&&(h[1]<=f[1])&&(h[2]>=g[2])&&(h[2]<=f[2]));};b.prototype.getRadiusAboutCentre=function(){return 0.5*(e.get_length(e.subtract(this._maxPos,this._minPos)));};b.prototype.toString=function(){var g=this._minPos;var f=this._maxPos;return[g[0],g[1],g[2],f[0],f[1],f[2]].toString();};a.JAABox=b;})(jigLib);(function(a){var b=function(f,e,d,c){if(f.id>e.id){this.body0=f;this.body1=e;this.r=d;}else{this.body0=e;this.body1=f;this.r=c;}};b.prototype.body0=null;b.prototype.body1=null;b.prototype.r=null;a.BodyPair=b;})(jigLib);(function(a){var b=function(d,e,c){this.normalImpulse=d;this.normalImpulseAux=e;this.frictionImpulse=c;};b.prototype.normalImpulse=null;b.prototype.normalImpulseAux=null;b.prototype.frictionImpulse=null;a.CachedImpulse=b;})(jigLib);(function(a){var b=function(c,d){if(c==null){c=0.25;}if(d==null){d=0.25;}this._restitution=c;this._friction=d;};b.prototype._restitution=null;b.prototype._friction=null;b.prototype.get_restitution=function(){return this._restitution;};b.prototype.set_restitution=function(c){this._restitution=c;};b.prototype.get_friction=function(){return this._friction;};b.prototype.set_friction=function(c){this._friction=c;};a.MaterialProperties=b;})(jigLib);(function(a){var b=function(){this._controllerEnabled=false;};b.prototype._controllerEnabled=null;b.prototype.updateController=function(c){};b.prototype.enableController=function(){if(this._controllerEnabled){return;}this._controllerEnabled=true;a.PhysicsSystem.getInstance().addController(this);};b.prototype.disableController=function(){if(!this._controllerEnabled){return;}this._controllerEnabled=false;a.PhysicsSystem.getInstance().removeController(this);};b.prototype.get_controllerEnabled=function(){return this._controllerEnabled;};a.PhysicsController=b;})(jigLib);(function(c){var d=c.Matrix3D;var b=c.JMatrix3D;var a=function(){this._orientation=new d();};a.prototype.position=[0,0,0,0];a.prototype._orientation;a.prototype.linVelocity=[0,0,0,0];a.prototype.rotVelocity=[0,0,0,0];a.prototype.orientationCols=[[0,0,0,0],[0,0,0,0],[0,0,0,0]];a.prototype.get_orientation=function(){return this._orientation;};a.prototype.set_orientation=function(f){this._orientation=f;var e=this._orientation.glmatrix;this.orientationCols[0][0]=e[0];this.orientationCols[0][1]=e[1];this.orientationCols[0][2]=e[2];this.orientationCols[1][0]=e[4];this.orientationCols[1][1]=e[5];this.orientationCols[1][2]=e[6];this.orientationCols[2][0]=e[8];this.orientationCols[2][1]=e[9];this.orientationCols[2][2]=e[10];};a.prototype.getOrientationCols=function(){return b.getCols(this._orientation);};c.PhysicsState=a;})(jigLib);(function(e){var k=e.Vector3DUtil;var h=e.JConfig;var i=e.Matrix3D;var f=e.JMatrix3D;var a=e.JNumber3D;var d=e.MaterialProperties;var b=e.PhysicsState;var g=e.PhysicsSystem;var j=e.JAABox;var c=e.JCollisionEvent;var l=function(m){e.JEventDispatcher.call(this);this._useDegrees=(h.rotationType=="DEGREES")?true:false;this._id=l.idCounter++;this._skin=m;this._material=new d();this._bodyInertia=new i();this._bodyInvInertia=f.getInverseMatrix(this._bodyInertia);this._currState=new b();this._oldState=new b();this._storeState=new b();this._invOrientation=f.getInverseMatrix(this._currState.get_orientation());this._currLinVelocityAux=[0,0,0,0];this._currRotVelocityAux=[0,0,0,0];this._force=[0,0,0,0];this._torque=[0,0,0,0];this._linVelDamping=[0.995,0.995,0.995,0];this._rotVelDamping=[0.5,0.5,0.5,0];this._maxLinVelocities=500;this._maxRotVelocities=50;this._velChanged=false;this._inactiveTime=0;this._doShockProcessing=true;this.isActive=this._activity=true;this._movable=true;this._origMovable=true;this.collisions=[];this._constraints=[];this._nonCollidables=[];this._storedPositionForActivation=[0,0,0,0];this._bodiesToBeActivatedOnMovement=[];this._lastPositionForDeactivation=this._currState.position.slice(0);this._lastOrientationForDeactivation=this._currState.get_orientation().clone();this._type="Object3D";this._boundingSphere=0;this._boundingBox=new j([0,0,0,0],[0,0,0,0]);this._boundingBox.clear();};e.extend(l,e.JEventDispatcher);l.idCounter=0;l.prototype._id=null;l.prototype._skin=null;l.prototype._type=null;l.prototype._boundingSphere=null;l.prototype._boundingBox=null;l.prototype._currState=null;l.prototype._oldState=null;l.prototype._storeState=null;l.prototype._invOrientation=null;l.prototype._currLinVelocityAux=null;l.prototype._currRotVelocityAux=null;l.prototype._mass=null;l.prototype._invMass=null;l.prototype._bodyInertia=null;l.prototype._bodyInvInertia=null;l.prototype._worldInertia=null;l.prototype._worldInvInertia=null;l.prototype._force=null;l.prototype._torque=null;l.prototype._linVelDamping=null;l.prototype._rotVelDamping=null;l.prototype._maxLinVelocities=null;l.prototype._maxRotVelocities=null;l.prototype._velChanged=null;l.prototype._activity=null;l.prototype._movable=null;l.prototype._origMovable=null;l.prototype._inactiveTime=null;l.prototype._doShockProcessing=null;l.prototype._bodiesToBeActivatedOnMovement=null;l.prototype._storedPositionForActivation=null;l.prototype._lastPositionForDeactivation=null;l.prototype._lastOrientationForDeactivation=null;l.prototype._material=null;l.prototype._rotationX=0;l.prototype._rotationY=0;l.prototype._rotationZ=0;l.prototype._useDegrees=null;l.prototype._nonCollidables=null;l.prototype._constraints=null;l.prototype.collisions=null;l.prototype.isActive=null;l.prototype.minImpulseForCollisionEvent=1;l.prototype.dispatchCollisionEvent=function(m,n){if(k.getSum(n)<this.minImpulseForCollisionEvent){return;}this.dispatchEvent(new c(m,n));};l.prototype.radiansToDegrees=function(m){return m*180/Math.PI;};l.prototype.degreesToRadians=function(m){return m*Math.PI/180;};l.prototype.get_rotationX=function(){return this._rotationX;};l.prototype.get_rotationY=function(){return this._rotationY;};l.prototype.get_rotationZ=function(){return this._rotationZ;};l.prototype.set_rotationX=function(m){this._rotationX=m;this.setOrientation(this.createRotationMatrix());};l.prototype.set_rotationY=function(m){this._rotationY=m;this.setOrientation(this.createRotationMatrix());};l.prototype.set_rotationZ=function(m){this._rotationZ=m;this.setOrientation(this.createRotationMatrix());};l.prototype.setRotation=function(m){this._rotationX=m[0];this._rotationY=m[1];this._rotationZ=m[2];this.setOrientation(this.createRotationMatrix());};l.prototype.pitch=function(m){this.setOrientation(f.getAppendMatrix3D(this.get_currentState().orientation,f.getRotationMatrixAxis(m,k.X_AXIS)));};l.prototype.yaw=function(m){this.setOrientation(f.getAppendMatrix3D(this.get_currentState().orientation,f.getRotationMatrixAxis(m,k.Y_AXIS)));};l.prototype.roll=function(m){this.setOrientation(f.getAppendMatrix3D(this.get_currentState().orientation,f.getRotationMatrixAxis(m,k.Z_AXIS)));};l.prototype.createRotationMatrix=function(){var m=new i();m.appendRotation(this._rotationX,k.X_AXIS);m.appendRotation(this._rotationY,k.Y_AXIS);m.appendRotation(this._rotationZ,k.Z_AXIS);return m;};l.prototype.setOrientation=function(m){this._currState.set_orientation(m.clone());this.updateInertia();this.updateState();};l.prototype.get_position=function(){return this._currState.position;};l.prototype.get_x=function(){return this._currState.position[0];};l.prototype.get_y=function(){return this._currState.position[1];};l.prototype.get_z=function(){return this._currState.position[2];};l.prototype.set_x=function(m){this._currState.position[0]=m;this.updateState();};l.prototype.set_y=function(m){this._currState.position[1]=m;this.updateState();};l.prototype.set_z=function(m){this._currState.position[2]=m;this.updateState();};l.prototype.moveTo=function(m){this._currState.position=m.slice(0);this.updateState();};l.prototype.updateState=function(){this._currState.linVelocity=[0,0,0,0];this._currState.rotVelocity=[0,0,0,0];this.copyCurrentStateToOld();this.updateBoundingBox();};l.prototype.setVelocity=function(m){this._currState.linVelocity=m.slice(0);};l.prototype.setAngVel=function(m){this._currState.rotVelocity=m.slice(0);};l.prototype.setVelocityAux=function(m){this._currLinVelocityAux=m.slice(0);};l.prototype.setAngVelAux=function(m){this._currRotVelocityAux=m.slice(0);};l.prototype.addGravity=function(){if(!this._movable){return;}this._force=k.add(this._force,a.getScaleVector(e.PhysicsSystem.getInstance().get_gravity(),this._mass));this._velChanged=true;};l.prototype.addExternalForces=function(m){this.addGravity();};l.prototype.addWorldTorque=function(m){if(!this._movable){return;}this._torque=k.add(this._torque,m);this._velChanged=true;this.setActive();};l.prototype.addBodyTorque=function(m){if(!this._movable){return;}f.multiplyVector(this._currState.get_orientation(),m);this.addWorldTorque(m);};l.prototype.addWorldForce=function(m,n){if(!this._movable){return;}this._force=k.add(this._force,m);this.addWorldTorque(k.crossProduct(k.subtract(n,this._currState.position),m));this._velChanged=true;this.setActive();};l.prototype.addBodyForce=function(m,n){if(!this._movable){return;}f.multiplyVector(this._currState.get_orientation(),m);f.multiplyVector(this._currState.get_orientation(),n);this.addWorldForce(m,k.add(this._currState.position,n));};l.prototype.clearForces=function(){this._force=[0,0,0,0];this._torque=[0,0,0,0];};l.prototype.applyWorldImpulse=function(n,o){if(!this._movable){return;}this._currState.linVelocity=k.add(this._currState.linVelocity,a.getScaleVector(n,this._invMass));var m=k.crossProduct(k.subtract(o,this._currState.position),n);f.multiplyVector(this._worldInvInertia,m);this._currState.rotVelocity=k.add(this._currState.rotVelocity,m);this._velChanged=true;};l.prototype.applyWorldImpulseAux=function(n,o){if(!this._movable){return;}this._currLinVelocityAux=k.add(this._currLinVelocityAux,a.getScaleVector(n,this._invMass));var m=k.crossProduct(k.subtract(o,this._currState.position),n);f.multiplyVector(this._worldInvInertia,m);this._currRotVelocityAux=k.add(this._currRotVelocityAux,m);this._velChanged=true;};l.prototype.applyBodyWorldImpulse=function(n,o){if(!this._movable){return;}this._currState.linVelocity=k.add(this._currState.linVelocity,a.getScaleVector(n,this._invMass));var m=k.crossProduct(o,n);f.multiplyVector(this._worldInvInertia,m);this._currState.rotVelocity=k.add(this._currState.rotVelocity,m);this._velChanged=true;};l.prototype.applyBodyWorldImpulseAux=function(n,o){if(!this._movable){return;}this._currLinVelocityAux=k.add(this._currLinVelocityAux,a.getScaleVector(n,this._invMass));var m=k.crossProduct(o,n);f.multiplyVector(this._worldInvInertia,m);this._currRotVelocityAux=k.add(this._currRotVelocityAux,m);this._velChanged=true;};l.prototype.addConstraint=function(m){if(!this.findConstraint(m)){this._constraints.push(m);}};l.prototype.removeConstraint=function(m){if(this.findConstraint(m)){this._constraints.splice(this._constraints.indexOf(m),1);}};l.prototype.removeAllConstraints=function(){this._constraints=[];};l.prototype.findConstraint=function(o){for(var n=0,m=this._constraints.length;n<m;n++){if(o==this._constraints[n]){return true;}}return false;};l.prototype.updateVelocity=function(n){if(!this._movable||!this._activity){return;}this._currState.linVelocity=k.add(this._currState.linVelocity,a.getScaleVector(this._force,this._invMass*n));var m=a.getScaleVector(this._torque,n);f.multiplyVector(this._worldInvInertia,m);this._currState.rotVelocity=k.add(this._currState.rotVelocity,m);};l.prototype.updatePositionWithAux=function(r){if(!this._movable||!this._activity){this._currLinVelocityAux=[0,0,0,0];this._currRotVelocityAux=[0,0,0,0];return;}var s=e.PhysicsSystem.getInstance().get_gravityAxis();if(s!=-1){var m=this._currLinVelocityAux.slice(0);m[(s+1)%3]*=0.1;m[(s+2)%3]*=0.1;a.copyFromArray(this._currLinVelocityAux,m);}var o=this._currState.rotVelocity.slice(0);f.multiplyVector(this._worldInertia,o);this._currState.position=k.add(this._currState.position,a.getScaleVector(k.add(this._currState.linVelocity,this._currLinVelocityAux),r));var q=k.add(this._currState.rotVelocity,this._currRotVelocityAux);var p=k.get_length(q)*180/Math.PI;if(p>0){k.normalize(q);p*=r;var n=f.getRotationMatrix(q[0],q[1],q[2],p);this._currState.set_orientation(f.getAppendMatrix3D(this._currState.get_orientation(),n));this.updateInertia();}this._currLinVelocityAux=[0,0,0,0];this._currRotVelocityAux=[0,0,0,0];f.multiplyVector(this._worldInvInertia,o);this._currState.rotVelocity=o.slice(0);this.updateBoundingBox();};l.prototype.postPhysics=function(m){};l.prototype.tryToFreeze=function(n){if(!this._movable||!this._activity){return;}if(k.get_length(k.subtract(this._currState.position,this._lastPositionForDeactivation))>h.posThreshold){this._lastPositionForDeactivation=this._currState.position.slice(0);this._inactiveTime=0;return;}var m=h.orientThreshold;var p=f.getSubMatrix(this._currState.get_orientation(),this._lastOrientationForDeactivation);var o=f.getCols(p);if(k.get_length(o[0])>m||k.get_length(o[1])>m||k.get_length(o[2])>m){this._lastOrientationForDeactivation=this._currState.get_orientation().clone();this._inactiveTime=0;return;}if(this.getShouldBeActive()){return;}this._inactiveTime+=n;if(this._inactiveTime>h.deactivationTime){this._lastPositionForDeactivation=this._currState.position.slice(0);this._lastOrientationForDeactivation=this._currState.get_orientation().clone();this.setInactive();}};l.prototype.set_mass=function(n){this._mass=n;this._invMass=1/n;this.setInertia(this.getInertiaProperties(n));};l.prototype.setInertia=function(m){this._bodyInertia=m.clone();this._bodyInvInertia=f.getInverseMatrix(this._bodyInertia.clone());this.updateInertia();};l.prototype.updateInertia=function(){this._invOrientation=f.getTransposeMatrix(this._currState.get_orientation());this._worldInertia=f.getAppendMatrix3D(this._invOrientation,f.getAppendMatrix3D(this._currState.get_orientation(),this._bodyInertia));this._worldInvInertia=f.getAppendMatrix3D(this._invOrientation,f.getAppendMatrix3D(this._currState.get_orientation(),this._bodyInvInertia));};l.prototype.get_movable=function(){return this._movable;};l.prototype.set_movable=function(m){if(this._type=="PLANE"||this._type=="TERRAIN"){return;}this._movable=m;this.isActive=this._activity=m;this._origMovable=m;};l.prototype.internalSetImmovable=function(){if(this._type=="PLANE"||this._type=="TERRAIN"){return;}this._origMovable=this._movable;this._movable=false;};l.prototype.internalRestoreImmovable=function(){if(this._type=="PLANE"||this._type=="TERRAIN"){return;}this._movable=this._origMovable;};l.prototype.getVelChanged=function(){return this._velChanged;};l.prototype.clearVelChanged=function(){this._velChanged=false;};l.prototype.setActive=function(m){if(!m){m=1;}if(this._movable){this.isActive=this._activity=true;this._inactiveTime=(1-m)*h.deactivationTime;}};l.prototype.setInactive=function(){if(this._movable){this.isActive=this._activity=false;}};l.prototype.getVelocity=function(m){return k.add(this._currState.linVelocity,k.crossProduct(this._currState.rotVelocity,m));};l.prototype.getVelocityAux=function(m){return k.add(this._currLinVelocityAux,k.crossProduct(this._currRotVelocityAux,m));};l.prototype.getShouldBeActive=function(){return((k.get_length(this._currState.linVelocity)>h.velThreshold)||(k.get_length(this._currState.rotVelocity)>h.angVelThreshold));};l.prototype.getShouldBeActiveAux=function(){return((k.get_length(this._currLinVelocityAux)>h.velThreshold)||(k.get_length(this._currRotVelocityAux)>h.angVelThreshold));};l.prototype.dampForDeactivation=function(){this._currState.linVelocity[0]*=this._linVelDamping[0];this._currState.linVelocity[1]*=this._linVelDamping[1];this._currState.linVelocity[2]*=this._linVelDamping[2];this._currState.rotVelocity[0]*=this._rotVelDamping[0];this._currState.rotVelocity[1]*=this._rotVelDamping[1];this._currState.rotVelocity[2]*=this._rotVelDamping[2];this._currLinVelocityAux[0]*=this._linVelDamping[0];this._currLinVelocityAux[1]*=this._linVelDamping[1];this._currLinVelocityAux[2]*=this._linVelDamping[2];this._currRotVelocityAux[0]*=this._rotVelDamping[0];this._currRotVelocityAux[1]*=this._rotVelDamping[1];this._currRotVelocityAux[2]*=this._rotVelDamping[2];var n=0.5;var m=this._inactiveTime/h.deactivationTime;if(m<n){return;}var o=1-((m-n)/(1-n));if(o<0){o=0;}else{if(o>1){o=1;}}this._currState.linVelocity=a.getScaleVector(this._currState.linVelocity,o);this._currState.rotVelocity=a.getScaleVector(this._currState.rotVelocity,o);};l.prototype.doMovementActivations=function(){var m=this._bodiesToBeActivatedOnMovement.length;if(m==0||k.get_length(k.subtract(this._currState.position,this._storedPositionForActivation))<h.posThreshold){return;}for(var n=0;n<m;n++){e.PhysicsSystem.getInstance().activateObject(this._bodiesToBeActivatedOnMovement[n]);}this._bodiesToBeActivatedOnMovement=[];};l.prototype.addMovementActivation=function(p,o){var m=this._bodiesToBeActivatedOnMovement.length;for(var n=0;n<m;n++){if(this._bodiesToBeActivatedOnMovement[n]==o){return;}}if(this._bodiesToBeActivatedOnMovement.length==0){this._storedPositionForActivation=p;}this._bodiesToBeActivatedOnMovement.push(o);};l.prototype.setConstraintsAndCollisionsUnsatisfied=function(){for(var n=0,m=this._constraints.length;n<m;n++){this._constraints[n].set_satisfied(false);}for(var n=0,o=this.collisions.length;n<o;n++){this.collisions[n].satisfied=false;}};l.prototype.segmentIntersect=function(n,m,o){return false;};l.prototype.getInertiaProperties=function(n){return new i();};l.prototype.updateBoundingBox=function(){};l.prototype.hitTestObject3D=function(m){var o=k.get_length(k.subtract(this._currState.position,m.get_currentState().position));var n=this._boundingSphere+m.get_boundingSphere();if(o<=n){return true;}return false;};l.prototype.findNonCollidablesBody=function(m){for(var o=0,n=this._nonCollidables.length;o<n;o++){if(m==this._nonCollidables[o]){return true;}}return false;};l.prototype.disableCollisions=function(m){if(!this.findNonCollidablesBody(m)){this._nonCollidables.push(m);}};l.prototype.enableCollisions=function(m){if(this.findNonCollidablesBody(m)){this._nonCollidables.splice(this._nonCollidables.indexOf(m),1);}};l.prototype.copyCurrentStateToOld=function(){this._oldState.position=this._currState.position.slice(0);this._oldState.set_orientation(this._currState.get_orientation().clone());this._oldState.linVelocity=this._currState.linVelocity.slice(0);this._oldState.rotVelocity=this._currState.rotVelocity.slice(0);};l.prototype.storeState=function(){this._storeState.position=this._currState.position.slice(0);this._storeState.set_orientation(this._currState.get_orientation().clone());this._storeState.linVelocity=this._currState.linVelocity.slice(0);this._storeState.rotVelocity=this._currState.rotVelocity.slice(0);
};l.prototype.restoreState=function(){this._currState.position=this._storeState.position.slice(0);this._currState.set_orientation(this._storeState.get_orientation().clone());this._currState.linVelocity=this._storeState.linVelocity.slice(0);this._currState.rotVelocity=this._storeState.rotVelocity.slice(0);};l.prototype.get_currentState=function(){return this._currState;};l.prototype.get_oldState=function(){return this._oldState;};l.prototype.get_id=function(){return this._id;};l.prototype.get_type=function(){return this._type;};l.prototype.get_skin=function(){return this._skin;};l.prototype.get_boundingSphere=function(){return this._boundingSphere;};l.prototype.get_boundingBox=function(){return this._boundingBox;};l.prototype.get_force=function(){return this._force;};l.prototype.get_mass=function(){return this._mass;};l.prototype.get_invMass=function(){return this._invMass;};l.prototype.get_worldInertia=function(){return this._worldInertia;};l.prototype.get_worldInvInertia=function(){return this._worldInvInertia;};l.prototype.get_nonCollidables=function(){return this._nonCollidables;};l.prototype.get_doShockProcessing=function(){return this._doShockProcessing;};l.prototype.set_doShockProcessing=function(m){this._doShockProcessing=m;};l.prototype.set_linVelocityDamping=function(m){this._linVelDamping[0]=a.getLimiteNumber(m[0],0,1);this._linVelDamping[1]=a.getLimiteNumber(m[1],0,1);this._linVelDamping[2]=a.getLimiteNumber(m[2],0,1);};l.prototype.get_linVelocityDamping=function(){return this._linVelDamping;};l.prototype.set_rotVelocityDamping=function(m){this._rotVelDamping[0]=a.getLimiteNumber(m[0],0,1);this._rotVelDamping[1]=a.getLimiteNumber(m[1],0,1);this._rotVelDamping[2]=a.getLimiteNumber(m[2],0,1);};l.prototype.get_rotVelocityDamping=function(){return this._rotVelDamping;};l.prototype.set_maxLinVelocities=function(m){this._maxLinVelocities=a.getLimiteNumber(Math.abs(m),0,500);};l.prototype.get_maxLinVelocities=function(){return this._maxLinVelocities;};l.prototype.set_maxRotVelocities=function(m){this._maxRotVelocities=a.getLimiteNumber(Math.abs(m),a.NUM_TINY,50);};l.prototype.get_maxRotVelocities=function(){return this._maxRotVelocities;};l.prototype.limitVel=function(){this._currState.linVelocity[0]=a.getLimiteNumber(this._currState.linVelocity[0],-this._maxLinVelocities,this._maxLinVelocities);this._currState.linVelocity[1]=a.getLimiteNumber(this._currState.linVelocity[1],-this._maxLinVelocities,this._maxLinVelocities);this._currState.linVelocity[2]=a.getLimiteNumber(this._currState.linVelocity[2],-this._maxLinVelocities,this._maxLinVelocities);};l.prototype.limitAngVel=function(){var o=Math.abs(this._currState.rotVelocity[0])/this._maxRotVelocities;var n=Math.abs(this._currState.rotVelocity[1])/this._maxRotVelocities;var m=Math.abs(this._currState.rotVelocity[2])/this._maxRotVelocities;var p=Math.max(o,n,m);if(p>1){this._currState.rotVelocity=a.getDivideVector(this._currState.rotVelocity,p);}};l.prototype.getTransform=function(){if(this._skin!=null){return this._skin.get_transform();}else{return null;}};l.prototype.updateObject3D=function(){if(this._skin!=null){this._skin.set_transform(f.getAppendMatrix3D(this._currState.get_orientation(),f.getTranslationMatrix(this._currState.position[0],this._currState.position[1],this._currState.position[2])));}};l.prototype.get_material=function(){return this._material;};l.prototype.get_restitution=function(){return this._material.get_restitution();};l.prototype.set_restitution=function(m){this._material.set_restitution(a.getLimiteNumber(m,0,1));};l.prototype.get_friction=function(){return this._material.get_friction();};l.prototype.set_friction=function(m){this._material.set_friction(a.getLimiteNumber(m,0,1));};e.RigidBody=l;})(jigLib);(function(a){var b=function(){this._effectEnabled=true;};b.prototype._effectEnabled=false;b.prototype.__defineGetter__("enabled",function(){return this._effectEnabled;});b.prototype.__defineSetter__("enabled",function(c){if(c==this._effectEnabled){return;}this._effectEnabled=c;if(c){a.PhysicsSystem.getInstance().addEffect(this);}else{a.PhysicsSystem.getInstance().removeEffect(this);}});b.prototype.Apply=function(){return;};a.JEffect=b;})(jigLib);(function(a){var b=a.Vector3DUtil;var c=function(e,f,d,h,g){this.Super();this.location=e;this.radius=f;this.force=d;if(h){this.parent=h;}if(h&&g){this.relativity=true;}this.enabled=false;};a.extend(c,a.JEffect);c.prototype.location=null;c.prototype.radius=null;c.prototype.force=null;c.prototype.parent=null;c.prototype.relativity=false;c.prototype.explode=function(){this.enabled=true;};c.prototype.Apply=function(){this.enabled=false;var g=a.PhysicsSystem.getInstance();var e=g.get_bodies();var f=e.length;var l,k,h,j;var d=[0,0,0,0];if(this.parent){this.location=this.parent.get_position();}this._affectedBodies=[];while(f--){l=e[f];if(this.parent&&l==this.parent){continue;}if(l._type!="PLANE"){k=b.distance(l.get_position(),this.location);if(k<this.radius){j=b.subtract(l.get_position(),this.location);h=(1-(k/this.radius))*this.force;b.scaleBy(j,h);if(this.relativity){d=b.add(j,d);}if(l.get_movable()){g.activateObject(l);l.addWorldForce(j,this.location);}}}else{if(this.relativity){k=l.pointPlaneDistance(this.location);if(k<this.radius){j=b.negate(l.get_normal().slice(0));h=(1-(k/this.radius))*(this.force*2);b.scaleBy(j,h);d=b.add(j,d);}}}}if(this.relativity){b.limitSum(d,this.force);b.negate(d);g.activateObject(this.parent);this.parent.applyWorldImpulse(d,this.location);}};a.Explosion=c;})(jigLib);(function(a){var c=a.Vector3DUtil;var b=function(e,f,d,g){this.Super();this.location=e;this.radius=f;this.force=d;if(g){this.parent=g;}};a.extend(b,a.JEffect);b.prototype.location=null;b.prototype.radius=null;b.prototype.force=null;b.prototype.parent=null;b.prototype.Apply=function(){var f=a.PhysicsSystem.getInstance();var d=f.get_bodies();var e=d.length-1;var k,j,g,h;if(this.parent){this.location=this.parent.get_position();}this._affectedBodies=[];do{k=d[e];if(!k.get_movable()||(this.parent&&k==this.parent)){continue;}j=c.distance(k.get_position(),this.location);if(j<this.radius){h=c.subtract(k.get_position(),this.location);g=(1-(j/this.radius))*this.force;c.scaleBy(h,g);c.negate(h);f.activateObject(k);k.applyWorldImpulse(h,this.location);}}while(e--);};a.GravityField=b;})(jigLib);(function(a){var b=a.Vector3DUtil;var c=function(d,e){this.Super();this.direction=d;if(e){this.exclusions=e;}};a.extend(c,a.JEffect);c.prototype.direction=null;c.prototype.exclusions=[];c.prototype.isExcluded=function(d){var e=this.exclusions.length;while(e--){if(this.exclusions[e]==d){return true;}}return false;};c.prototype.Apply=function(){var f=a.PhysicsSystem.getInstance();var d=f.get_bodies();var e=d.length;var g;this._affectedBodies=[];while(e--){g=d[e];if(!g.get_movable()||this.isExcluded(g)){continue;}f.activateObject(g);g.applyWorldImpulse(this.direction,g.get_position());}};a.Wind=c;})(jigLib);(function(b){var d=b.Vector3DUtil;var c=b.JNumber3D;var e=b.PlaneData;var a=function(){counter=0;this._vertexIndices=[];this._vertexIndices[0]=-1;this._vertexIndices[1]=-1;this._vertexIndices[2]=-1;this._plane=new e();this._boundingBox=new JAABox();};a.prototype.counter=0;a.prototype.setVertexIndices=function(h,g,f,i){this._vertexIndices[0]=h;this._vertexIndices[1]=g;this._vertexIndices[2]=f;this._plane.setWithPoint(i[h],i[g],i[f]);this._boundingBox.clear();this._boundingBox.addPoint(i[h]);this._boundingBox.addPoint(i[g]);this._boundingBox.addPoint(i[f]);};a.prototype.updateVertexIndices=function(i){var h;var g;var f;h=this._vertexIndices[0];g=this._vertexIndices[1];f=this._vertexIndices[2];this._plane.setWithPoint(i[h],i[g],i[f]);this._boundingBox.clear();this._boundingBox.addPoint(i[h]);this._boundingBox.addPoint(i[g]);this._boundingBox.addPoint(i[f]);};a.prototype.get_vertexIndices=function(){return this._vertexIndices;};a.prototype.getVertexIndex=function(f){return this._vertexIndices[f];};a.prototype.get_plane=function(){return _plane;};a.prototype.get_boundingBox=function(){return this._boundingBox;};b.JIndexedTriangle=a;})(jigLib);(function(b){var e=b.Vector3DUtil;var c=b.JNumber3D;var d=b.EdgeData;var g=b.OctreeCell;var a=b.TriangleVertexIndices;var f=function(){this._testCounter=0;this._cells=[];this._vertices=[];this._triangles=[];this._cellsToTest=[];this._boundingBox=[];};f.prototype.get_trianglesData=function(){return this._triangles;};f.prototype.getTriangle=function(h){return this._triangles[h];};f.prototype.get_verticesData=function(){return this._vertices;};f.prototype.getVertex=function(h){return this._vertices[h];};f.prototype.boundingBox=function(){return this._boundingBox;};f.prototype.clear=function(){this._cells=[];this._vertices=[];this._triangles=[];};f.prototype.addTriangles=function(s,t,q,j){this.clear();this._vertices.concat(s);var l,h=c.NUM_TINY;var o,n,m;var v,u,r;var k;for(var p=0;p<q.length;p++){var w=q[p];o=w.i0;n=w.i1;m=w.i2;v=e.subtract(s[n],s[o]);u=e.subtract(s[m],s[o]);r=e.crossProduct(v,u);l=e.get_length(r);if(l>h){k=new JIndexedTriangle();k.setVertexIndices(o,n,m,this._vertices);this._triangles.push(k);}}};f.prototype.buildOctree=function(q,k){this._boundingBox.clear();for(var m=0;m<this._vertices.length;m++){var r=this._vertices[m];this._boundingBox.addPoint(r);}this._cells=[];this._cells.push(new g(this._boundingBox));var h=this._triangles.length;for(var m=0;m<h;m++){this._cells[0].triangleIndices[m]=m;}var s=[];s.push(0);var o;var p;var n;while(s.length!=0){p=s.pop();if(this._cells[p].triangleIndices.length<=q||this._cells[p].AABox.getRadiusAboutCentre()<k){continue;}for(m=0;m<g.NUM_CHILDREN;m++){this._cells[p].childCellIndices[m]=this._cells.length;s.push(this._cells.length);this._cells.push(new g(this.createAABox(this._cells[p].AABox,m)));n=this._cells[this._cells.length-1];h=this._cells[p].triangleIndices.length;for(var l=0;l<h;l++){o=this._cells[p].triangleIndices[l];if(this.doesTriangleIntersectCell(this._triangles[o],n)){n.triangleIndices.push(o);}}}this._cells[p].triangleIndices=[];}};f.prototype.updateTriangles=function(h){this._vertices.concat(h);for(var j=0;j<this._triangles.length;j++){var k=this._triangles[j];k.updateVertexIndices(this._vertices);}};f.prototype.getTrianglesIntersectingtAABox=function(n,j){if(this._cells.length==0){return 0;}this._cellsToTest=[];this._cellsToTest.push(0);this.incrementTestCounter();var l,k,h,o;while(this._cellsToTest.length!=0){l=this._cellsToTest.pop();h=this._cells[l];if(!j.overlapTest(h.AABox)){continue;}if(h.isLeaf()){k=h.triangleIndices.length;for(var m=0;m<k;m++){o=this.getTriangle(h.triangleIndices[m]);if(o.counter!=this._testCounter){o.counter=this._testCounter;if(j.overlapTest(o.get_boundingBox())){n.push(h.triangleIndices[m]);}}}}else{for(m=0;m<g.NUM_CHILDREN;m++){this._cellsToTest.push(h.childCellIndices[m]);}}}return n.length;};f.prototype.dumpStats=function(){var j=0,m,k,h;var n=[];n.push(0);while(n.length!=0){k=n.pop();h=h[k];if(h.isLeaf()){m=h.triangleIndices.length;if(m>j){j=m;}}else{for(var l=0;l<g.NUM_CHILDREN;l++){if((h.childCellIndices[l]>=0)&&(h.childCellIndices[l]<this._cells.length)){n.push(h.childCellIndices[l]);}}}}};f.prototype.createAABox=function(i,j){var l=c.getScaleVector(e.subtract(i.maxPos,i.minPos),0.5);var k;switch(j){case 0:k=[1,1,1];break;case 1:k=[1,1,0];break;case 2:k=[1,0,1];break;case 3:k=[1,0,0];break;case 4:k=[0,1,1];break;case 5:k=[0,1,0];break;case 6:k=[0,0,1];break;case 7:k=[0,0,0];break;default:k=[0,0,0];break;}var h=new JAABox();h.minPos=e.add(i.minPos,[k.x*l.x,k.y*l.y,k.z*l.z]);h.maxPos=e.add(h.minPos,l);e.scaleBy(l,0.00001);h.minPos=e.subtract(h.minPos,l);h.maxPos=e.subtract(h.maxPos,l);return h;};f.prototype.doesTriangleIntersectCell=function(m,o){if(!m.get_boundingBox().overlapTest(o.AABox)){return false;}if(o.AABox.isPointInside(this.getVertex(m.getVertexIndex(0)))||o.AABox.isPointInside(this.getVertex(m.getVertexIndex(1)))||o.AABox.isPointInside(this.getVertex(m.getVertexIndex(2)))){return true;}var q=new JTriangle(this.getVertex(m.getVertexIndex(0)),this.getVertex(m.getVertexIndex(1)),this.getVertex(m.getVertexIndex(2)));var h;var k;var j=o.egdes;var r=o.points;for(var l=0;l<12;l++){h=j[l];k=new JSegment(r[h.ind0],e.subtract(r[h.ind1],r[h.ind0]));if(q.segmentTriangleIntersection(null,k)){return true;}}var p;var n;for(l=0;l<3;l++){p=q.getVertex(l);n=q.getVertex((l+1)%3);if(o.AABox.segmentAABoxOverlap(new JSegment(p,e.subtract(n,p)))){return true;}}return false;};f.prototype.incrementTestCounter=function(){++this._testCounter;if(this._testCounter==0){var j=this._triangles.length;for(var h=0;h<j;h++){this._triangles[h].counter=0;}this._testCounter=1;}};b.JOctree=f;})(jigLib);(function(a){var f=a.Vector3DUtil;var c=a.JNumber3D;var e=a.CollOutData;var g=a.PlaneData;var d=a.SpanData;var b=function(j,i,h){origin=f.clone(j);edge0=f.subtract(i,j);edge1=f.subtract(h,j);};b.prototype.get_edge2=function(){return f.subtract(edge1,edge0);};b.prototype.get_normal=function(){var h=f.crossProduct(edge0,edge1);f.normalize(h);return h;};b.prototype.get_plane=function(){var h=new g();h.setWithNormal(origin,normal);return h;};b.prototype.getPoint=function(j,h){var k,i;k=f.crossProduct(edge0);i=f.crossProduct(edge1);f.scaleBy(k,j);f.scaleBy(i,h);return f.add(f.add(origin,k),i);};b.prototype.getCentre=function(){var h=f.add(edge0,edge1);f.scaleBy(h,0.333333);return f.add(origin,h);};b.prototype.getVertex=function(h){switch(h){case 1:return f.add(origin,edge0);case 2:return f.add(origin,edge1);default:return origin;}};b.prototype.getSpan=function(i){var l,k,j;l=f.dotProduct(this.getVertex(0),i);k=f.dotProduct(this.getVertex(1),i);j=f.dotProduct(this.getVertex(2),i);var h=new d();h.min=Math.min(l,k,j);h.max=Math.max(l,k,j);return h;};b.prototype.segmentTriangleIntersection=function(j,k){var o,n,r,m,l;var i,w,h;i=f.crossProduct(k.delta,edge1);m=f.dotProduct(edge0,i);if(m>-c.NUM_TINY&&m<c.NUM_TINY){return false;}l=1/m;w=f.subtract(k.origin,origin);o=l*w.dotProduct(i);if(o<0||o>1){return false;}h=f.crossProduct(w,edge0);n=l*f.dotProduct(k.delta,h);if(n<0||(o+n)>1){return false;}r=l*f.dotProduct(edge1,h);if(r<0||r>1){return false;}if(j){j.frac=r;}return true;};b.prototype.pointTriangleDistanceSq=function(p,n){var m,l,s,w,v,k,o,y,x,i;var r=f.subtract(origin,n);m=f.get_lengthSquared(edge0);l=f.dotProduct(edge0,edge1);s=f.get_lengthSquared(edge1);w=f.dotProduct(r,edge0);v=f.dotProduct(r,edge1);k=f.get_lengthSquared(r);o=Math.abs(m*s-l*l);y=l*v-s*w;x=l*w-m*v;if(y+x<=o){if(y<0){if(x<0){if(w<0){x=0;if(-w>=m){y=1;i=m+2*w+k;}else{y=-w/m;i=w*y+k;}}else{y=0;if(v>=0){x=0;i=k;}else{if(-v>=s){x=1;i=s+2*v+k;}else{x=-v/s;i=v*x+k;}}}}else{y=0;if(v>=0){x=0;i=k;}else{if(-v>=s){x=1;i=s+2*v+k;}else{x=-v/s;i=v*x+k;}}}}else{if(x<0){x=0;if(w>=0){y=0;i=k;}else{if(-w>=m){y=1;i=m+2*w+k;}else{y=-w/m;i=w*y+k;}}}else{var h=1/o;y*=h;x*=h;i=y*(m*y+l*x+2*w)+x*(l*y+s*x+2*v)+k;}}}else{var u;var t;var j;var q;if(y<0){u=l+w;t=s+v;if(t>u){j=t-u;q=m-2*l+s;if(j>=q){y=1;x=0;i=m+2*w+k;}else{y=j/q;x=1-y;i=y*(m*y+l*x+2*w)+x*(l*y+s*x+2*v)+k;}}else{y=0;if(t<=0){x=1;i=s+2*v+k;}else{if(v>=0){x=0;i=k;}else{x=-v/s;i=v*x+k;}}}}else{if(x<0){u=l+v;t=m+w;if(t>u){j=t-u;q=m-2*l+s;if(j>=q){x=1;y=0;i=s+2*v+k;}else{x=j/q;y=1-x;i=y*(m*y+l*x+2*w)+x*(l*y+s*x+2*v)+k;}}else{x=0;if(t<=0){y=1;i=m+2*w+k;}else{if(w>=0){y=0;i=k;}else{y=-w/m;i=w*y+k;}}}}else{j=s+v-l-w;if(j<=0){y=0;x=1;i=s+2*v+k;}else{q=m-2*l+s;if(j>=q){y=1;x=0;i=m+2*w+k;}else{y=j/q;x=1-y;i=y*(m*y+l*x+2*w)+x*(l*y+s*x+2*v)+k;}}}}}p[0]=y;p[1]=x;return Math.abs(i);};a.JTriangle=b;})(jigLib);(function(d){var h=d.Vector3DUtil;var a=d.JNumber3D;var e=d.Matrix3D;var g=d.CollOutData;var i=d.TriangleVertexIndices;var b=d.PhysicsState;var l=d.RigidBody;var f=d.ISkin3D;var c=function(q,o,n,p,m){if(p==undefined){p=10;}if(m==undefined){m=10;}this.Super(q);this.get_currentState().position=h.clone(o);this.get_currentState().set_orientation(h.clone(n));this._maxTrianglesPerCell=p;this._minCellSize=m;this.set_movable(false);if(q){this._skinVertices=q.vertices;this.createMesh(this._skinVertices,q.indices);this._boundingBox=this._octree.boundingBox().clone();this._boundingSphere=this._boundingBox.getRadiusAboutCentre();}this._type="TRIANGLEMESH";};d.extend(c,d.RigidBody);c.prototype.createMesh=function(p,t){var m=p.length;var s=[];var o=JMatrix3D.getTranslationMatrix(this.get_currentState().position[0],this.get_currentState().position[1],this.get_currentState().position[2]);o=JMatrix3D.getAppendMatrix3D(this.get_currentState().get_orientation(),o);var q=0;for(var n=0;n<p.length;n++){var r=p[n];s[q++]=this.transform.transformVector(r);}this._octree=new JOctree();this._octree.addTriangles(s,s.length,t,t.length);this._octree.buildOctree(this._maxTrianglesPerCell,_minCellSize);};c.prototype.get_octree=function(){return this._octree;};c.prototype.segmentIntersect=function(p,q,m){var n=new JAABox();n.addSegment(q);var o=[];var u=this._octree.getTrianglesIntersectingtAABox(o,n);var t=a.NUM_HUGE;var v;var r;for(var s=0;s<numTriangles;s++){r=this._octree.getTriangle(o[s]);v=new JTriangle(this._octree.getVertex(r.getVertexIndex(0)),this._octree.getVertex(r.getVertexIndex(1)),this._octree.getVertex(r.getVertexIndex(2)));if(v.segmentTriangleIntersection(p,q)){if(p.frac<t){t=p.frac;p.position=q.getPoint(t);p.normal=r.plane.normal;}}}p.frac=t;if(t<a.NUM_HUGE){return true;}else{return false;}};c.prototype.updateState=function(){this.Super.updateState();var m=this._skinVertices.length;var q=[];var n=JMatrix3D.getTranslationMatrix(this.get_currentState().position[0],this.get_currentState().position[1],this.get_currentState().position[2]);n=JMatrix3D.getAppendMatrix3D(this.get_currentState().get_orientation(),n);var o=0;for(k=0;j<this._skinVertices.length;j++){var p=this._skinVertices[j];q[o++]=n.transformVector(p);}this._octree.updateTriangles(q);this._octree.buildOctree(this._maxTrianglesPerCell,this._minCellSize);this._boundingBox=this._octree.boundingBox().clone();};d.JTriangleMesh=c;})(jigLib);(function(c){var g=c.Vector3DUtil;var b=c.JMatrix3D;var d=c.JNumber3D;var h=c.RigidBody;var f=c.EdgeData;var e=c.SpanData;var a=function(k,j,l,i){c.RigidBody.call(this);this._edges=[new f(0,1),new f(3,1),new f(2,3),new f(2,0),new f(4,5),new f(5,7),new f(6,7),new f(4,6),new f(7,1),new f(5,3),new f(4,2),new f(6,0)];this._faces=[[6,7,1,0],[5,4,2,3],[3,1,7,5],[4,6,0,2],[1,3,2,0],[7,6,4,5]];this._type="BOX";this._sideLengths=g.create(j,i,l,0);this._boundingSphere=0.5*g.get_length(this._sideLengths);this.initPoints();this.set_mass(1);this.updateBoundingBox();};c.extend(a,c.RigidBody);a.prototype._sideLengths=null;a.prototype._points=null;a.prototype._edges=null;a.prototype._faces=null;a.prototype.initPoints=function(){var i=this.getHalfSideLengths();this._points=[];this._points[0]=g.create(i[0],-i[1],i[2],0);this._points[1]=g.create(i[0],i[1],i[2],0);this._points[2]=g.create(-i[0],-i[1],i[2],0);this._points[3]=g.create(-i[0],i[1],i[2],0);this._points[4]=g.create(-i[0],-i[1],-i[2],0);this._points[5]=g.create(-i[0],i[1],-i[2],0);this._points[6]=g.create(i[0],-i[1],-i[2],0);this._points[7]=g.create(i[0],i[1],-i[2],0);};a.prototype.set_sideLengths=function(i){this._sideLengths=i.slice(0);this._boundingSphere=0.5*g.get_length(this._sideLengths);this.initPoints();this.setInertia(this.getInertiaProperties(this.get_mass()));this.setActive();this.updateBoundingBox();};a.prototype.get_sideLengths=function(){return this._sideLengths;};a.prototype.get_edges=function(){return this._edges;};a.prototype.getVolume=function(){return(this._sideLengths[0]*this._sideLengths[1]*this._sideLengths[2]);};a.prototype.getSurfaceArea=function(){return 2*(this._sideLengths[0]*this._sideLengths[1]+this._sideLengths[0]*this._sideLengths[2]+this._sideLengths[1]*this._sideLengths[2]);};a.prototype.getHalfSideLengths=function(){return d.getScaleVector(this._sideLengths,0.5);};a.prototype.getSpan=function(k){var o=this.get_currentState().getOrientationCols();var n=new e();var j=Math.abs(g.dotProduct(k,o[0]))*(0.5*this._sideLengths[0]);var i=Math.abs(g.dotProduct(k,o[1]))*(0.5*this._sideLengths[1]);var q=Math.abs(g.dotProduct(k,o[2]))*(0.5*this._sideLengths[2]);var l=j+i+q;var m=g.dotProduct(this.get_currentState().position,k);n.min=m-l;n.max=m+l;return n;};a.prototype.getCornerPoints=function(p){var o;var j=[];var k=b.getTranslationMatrix(p.position[0],p.position[1],p.position[2]);k=b.getAppendMatrix3D(p.get_orientation(),k);for(var l=0,m=this._points.length;l<m;l++){var n=this._points[l];o=g.create(n[0],n[1],n[2],0);b.multiplyVector(k,o);j.push(o);}return j;};a.prototype.getCornerPointsInBoxSpace=function(l,p){var k=b.getTransposeMatrix(p.get_orientation());var q=g.subtract(l.position,p.position);b.multiplyVector(k,q);var n=b.getAppendMatrix3D(l.get_orientation(),k);var j=[];var m=b.getTranslationMatrix(q[0],q[1],q[2]);m=b.getAppendMatrix3D(n,m);for(var o=0;o<this._points.length;o++){_point=this._points[o].slice(0);b.multiplyVector(m,_point);j[o]=_point;}return j;};a.prototype.getSqDistanceToPoint=function(m,k,j){k.pos=g.subtract(j,m.position);b.multiplyVector(b.getTransposeMatrix(m.get_orientation()),k.pos);var n=0;var l=0;var i=this.getHalfSideLengths();if(k.pos[0]<-i[0]){n=k.pos[0]+i[0];l+=(n*n);k.pos[0]=-i[0];}else{if(k.pos[0]>i[0]){n=k.pos[0]-i[0];l+=(n*n);k.pos[0]=i[0];}}if(k.pos[1]<-i[1]){n=k.pos[1]+i[1];l+=(n*n);k.pos[1]=-i[1];}else{if(k.pos[1]>i[1]){n=k.pos[1]-i[1];l+=(n*n);k.pos[1]=i[1];}}if(k.pos[2]<-i[2]){n=k.pos[2]+i[2];l+=(n*n);k.pos[2]=-i[2];}else{if(k.pos[2]>i[2]){n=(k.pos[2]-i[2]);l+=(n*n);k.pos[2]=i[2];}}b.multiplyVector(m.get_orientation(),k.pos);k.pos=g.add(m.position,k.pos);return l;};a.prototype.getDistanceToPoint=function(k,j,i){return Math.sqrt(this.getSqDistanceToPoint(k,j,i));};a.prototype.pointIntersect=function(n){var m=g.subtract(n,this.get_currentState().position);var k=d.getScaleVector(this._sideLengths,0.5);var j;var l=this.get_currentState().getOrientationCols();for(var i;i<3;i++){j=l[i].slice(0);g.normalize(j);if(Math.abs(g.dotProduct(j,m))>k[i]+d.NUM_TINY){return false;}}return true;};a.prototype.getSupportVertices=function(p){var v=[];var w=[1,1,1];var x;var y=this.get_currentState().getOrientationCols();g.normalize(y[0]);g.normalize(y[1]);g.normalize(y[2]);for(var s=0;s<3;s++){w[s]=g.dotProduct(p,y[s]);if(Math.abs(w[s])>1-0.001){var u=(w[s]<0)?(s*2):(s*2)+1;for(var r=0;r<4;r++){x=this._points[this._faces[u][r]];var z=v[r]=this.get_currentState().position.slice(0);z=g.add(z,d.getScaleVector(y[0],x[0]));z=g.add(z,d.getScaleVector(y[1],x[1]));z=g.add(z,d.getScaleVector(y[2],x[2]));}return v;}}for(s=0;s<3;s++){if(Math.abs(w[s])<0.005){var q;var o=(s+1)%3;var l=(s+2)%3;x=this.get_currentState().position.slice(0);q=(w[o]>0)?-1:1;x=g.add(x,d.getScaleVector(y[o],q*this._sideLengths[o]/2));q=(w[l]>0)?-1:1;x=g.add(x,d.getScaleVector(y[l],q*this._sideLengths[l]/2));v[0]=g.add(x,d.getScaleVector(y[s],this._sideLengths[s]/2));v[1]=g.add(x,d.getScaleVector(y[s],-this._sideLengths[s]/2));return v;}}var t=v[0]=this.get_currentState().position.slice(0);q=(w[0]>0)?-1:1;v[0]=g.add(t,d.getScaleVector(y[0],q*this._sideLengths[0]/2));q=(w[1]>0)?-1:1;v[0]=g.add(t,d.getScaleVector(y[1],q*this._sideLengths[1]/2));q=(w[2]>0)?-1:1;v[0]=g.add(t,d.getScaleVector(y[2],q*this._sideLengths[2]/2));return v;};a.prototype.segmentIntersect=function(x,z,k){x.fracOut=0;x.posOut=[0,0,0,0];x.normalOut=[0,0,0,0];var j=d.NUM_HUGE;var v=-d.NUM_HUGE;var w=d.NUM_HUGE;var C=0;var i=0;var u=0;var s=g.subtract(k.position,z.origin);var y=d.getScaleVector(this._sideLengths,0.5);var B;var A;var q;var n;var m;var o=k.getOrientationCols();var r=y.slice(0);var l;for(u=0;u<3;u++){l=r[u];B=g.dotProduct(o[u],s);A=g.dotProduct(o[u],z.delta);if(Math.abs(A)>d.NUM_TINY){n=(B+l)/A;m=(B-l)/A;if(n>m){q=n;n=m;m=q;}if(n>v){v=n;C=u;}if(m<w){w=m;i=u;}if(v>w){return false;}if(w<0){return false;}}else{if(-B-l>0||-B+l<0){return false;}}}if(v>0){u=C;j=v;}else{u=i;j=w;}if(j<0){j=0;}if(j>1-d.NUM_TINY){return false;}x.fracOut=j;x.posOut=z.getPoint(j);if(g.dotProduct(o[u],z.delta)<0){x.normalOut=d.getScaleVector(o[u],-1);}else{x.normalOut=o[u];}return true;};a.prototype.getInertiaProperties=function(i){return b.getScaleMatrix((i/12)*(this._sideLengths[1]*this._sideLengths[1]+this._sideLengths[2]*this._sideLengths[2]),(i/12)*(this._sideLengths[0]*this._sideLengths[0]+this._sideLengths[2]*this._sideLengths[2]),(i/12)*(this._sideLengths[0]*this._sideLengths[0]+this._sideLengths[1]*this._sideLengths[1]));};a.prototype.updateBoundingBox=function(){this._boundingBox.clear();this._boundingBox.addBox(this);};c.JBox=a;})(jigLib);(function(c){var f=c.Vector3DUtil;var b=c.JMatrix3D;var d=c.JNumber3D;var g=c.RigidBody;var h=c.JSegment;var e=function(k,j,i){this.Super(k);this._type="CAPSULE";this._radius=j;this._length=i;this._boundingSphere=this.getBoundingSphere(j,i);this.set_mass(1);this.updateBoundingBox();};c.extend(e,c.RigidBody);e.prototype._length=null;e.prototype._radius=null;e.prototype.set_radius=function(i){this._radius=i;this._boundingSphere=getBoundingSphere(this._radius,this._length);this.setInertia(this.getInertiaProperties(this.get_mass()));this.updateBoundingBox();this.setActive();};e.prototype.get_radius=function(){return this._radius;};e.prototype.set_length=function(i){this._length=i;this._boundingSphere=getBoundingSphere(this._radius,this._length);this.setInertia(this.getInertiaProperties(this.get_mass()));this.updateBoundingBox();this.setActive();};e.prototype.get_length=function(){return this._length;};e.prototype.getBottomPos=function(j){var i=j.getOrientationCols()[1];return f.add(j.position,d.getScaleVector(i,-this._length/2-this._radius));};e.prototype.getEndPos=function(j){var i=j.getOrientationCols()[1];return f.add(j.position,d.getScaleVector(i,this._length/2+this._radius));};e.prototype.segmentIntersect=function(y,A,n){y.fracOut=0;y.posOut=[0,0,0,0];y.normalOut=[0,0,0,0];var j=A.delta;var C=f.dotProduct(j,j);var x=this._radius*this._radius;var u=n.getOrientationCols();var p=new h(getBottomPos(n),u[1]);var r=p.delta;var o=f.subtract(p.origin,A.origin);var s=f.dotProduct(r,r);if(Math.abs(s)<d.NUM_TINY){return false;}var k=f.dotProduct(r,j);var z=f.dotProduct(o,j);var q=f.dotProduct(r,o);var i=f.dotProduct(o,o);var m=f.get_lengthSquared(f.subtract(o,d.getDivideVector(d.getScaleVector(r,q),s)));if(m<x){y.fracOut=0;y.posOut=A.origin.slice(0);y.normalOut=f.subtract(y.posOut,getBottomPos(n));y.normalOut=f.subtract(y.normalOut,d.getScaleVector(u[1],f.dotProduct(y.normalOut,u[1])));f.normalize(y.normalOut);return true;}var w=s*C-(k*k);if(Math.abs(a)<d.NUM_TINY){return false;}var D=2*(q*k-s*z);var B=s*(i-x)-(q*q);var l=(D*D)-4*a*B;if(l<0){return false;}var v=(-D-Math.sqrt(l))/(2*a);if(v<0||v>1){return false;}y.fracOut=v;y.posOut=A.getPoint(v);y.normalOut=f.subtract(y.posOut,getBottomPos(n));y.normalOut=f.subtract(y.normalOut,d.getScaleVector(u[1],f.dotProduct(y.normalOut,u[1])));f.normalize(y.normalOut);return true;};e.prototype.getInertiaProperties=function(i){var l=i*Math.PI*this._radius*this._radius*this._length/this.getVolume();var j=0.25*l*this._radius*this._radius+(1/12)*l*this._length*this._length;var k=0.5*l*this._radius*this._radius;var n=j;var o=i-l;j+=(0.4*o*this._radius*this._radius+o*Math.pow(0.5*this._length,2));k+=(0.2*o*this._radius*this._radius);n+=(0.4*o*this._radius*this._radius+o*Math.pow(0.5*this._length,2));return b.getScaleMatrix(j,k,n);};e.prototype.updateBoundingBox=function(){this._boundingBox.clear();this._boundingBox.addCapsule(this);};e.prototype.getBoundingSphere=function(j,i){return Math.sqrt(Math.pow(i/2,2)+j*j)+j;};e.prototype.getVolume=function(){return(4/3)*Math.PI*this._radius*this._radius*this._radius+this._length*Math.PI*this._radius*this._radius;};c.JCapsule=e;})(jigLib);(function(a){var b=function(f,d,c,g){this._img=new Image();this._img.src=f;var f=new Image();var e=this;f.onload=function(j){var h=document.createElement("canvas");var i=h.getContext("2d");h.width=this.width;h.height=this.height;i.drawImage(this,0,0);e._heightData=i.getImageData(0,0,this.width,this.height).data;};f.src=imageURL;this._height=c;this._width=d;this._depth=g;this._minW=-d+d/2;this._maxW=d/2;this._minH=-c+c/2;this._maxH=c/2;};a.extend(b,a.ITerrain);b.prototype._img=null;b.prototype._width=null;b.prototype._height=null;b.prototype._depth=null;b.prototype._minW=null;b.prototype._minH=null;b.prototype._maxW=null;b.prototype._maxH=null;b.prototype._heightData=null;b.prototype.get_minW=function(){return this._minW;};b.prototype.get_minH=function(){return this._minH;};b.prototype.get_maxW=function(){return this._maxW;};b.prototype.get_maxH=function(){return this._maxH;};b.prototype.get_dw=function(){return this._width/this._img.width;};b.prototype.get_dh=function(){return this._height/this._img.height;};b.prototype.get_sw=function(){return this._img.width;};b.prototype.get_sh=function(){return this._img.height;};b.prototype.get_heights=function(d,c){if(this._heightData){return(this._heightData[(this._img.width*(d|0)+(c|0))*4])/255*this._depth;}else{return this._depth;}};a.JImageTerrain=b;})(jigLib);(function(c){var e=c.Vector3DUtil;var b=c.JMatrix3D;var d=c.JNumber3D;var f=c.RigidBody;var a=function(g,h){this.Super(g);if(h==undefined){this._initNormal=[0,0,-1,0];this._normal=this._initNormal.slice(0);}else{this._initNormal=h.slice(0);this._normal=this._initNormal.slice(0);}this._distance=0;this._type="PLANE";this._movable=false;};c.extend(a,c.RigidBody);a.prototype._initNormal=null;a.prototype._normal=null;a.prototype._distance=null;a.prototype.get_normal=function(){return this._normal;};a.prototype.get_distance=function(){return this._distance;};a.prototype.pointPlaneDistance=function(g){return e.dotProduct(this._normal,g)-this._distance;};a.prototype.segmentIntersect=function(j,g,l){j.fracOut=0;j.posOut=[0,0,0,0];j.normalOut=[0,0,0,0];var i=0;var k;var h=e.dotProduct(this._normal,g.delta);if(Math.abs(h)>d.NUM_TINY){k=-1*(e.dotProduct(this._normal,g.origin)-this._distance)/h;if(k<0||k>1){return false;}else{i=k;j.fracOut=i;j.posOut=g.getPoint(i);j.normalOut=this._normal.slice(0);e.normalize(j.normalOut);return true;}}else{return false;}};a.prototype.updateState=function(){this.Super.prototype.updateState.call(this);this._normal=this._initNormal.slice(0);b.multiplyVector(this._currState._orientation,this._normal);this._distance=e.dotProduct(this._currState.position,this._normal);};c.JPlane=a;})(jigLib);(function(a){var d=a.Vector3DUtil;var b=a.JNumber3D;var c=function(f,e){this.origin=f;this.dir=e;};c.prototype.origin=null;c.prototype.dir=null;c.prototype.getOrigin=function(e){return d.add(this.origin,b.getScaleVector(this.dir,e));};a.JRay=c;})(jigLib);(function(a){var d=a.Vector3DUtil;var b=a.JNumber3D;var c=a.JRay;var e=function(g,f){this.origin=g;this.delta=f;};e.prototype.origin=null;e.prototype.delta=null;e.prototype.getPoint=function(f){return d.add(this.origin,b.getScaleVector(this.delta,f));};e.prototype.getEnd=function(){return d.add(this.origin,this.delta);};e.prototype.clone=function(){return new e(this.origin,this.delta);};e.prototype.segmentSegmentDistanceSq=function(j,k){j.t0=0;j.t1=0;var r=d.subtract(this.origin,k.origin);var o=d.get_lengthSquared(this.delta);var n=-d.dotProduct(this.delta,k.delta);var i=d.get_lengthSquared(k.delta);var h=d.dotProduct(r,this.delta);var m=d.get_lengthSquared(r);var t=Math.abs(o*i-n*n);var g;var s;var q;var l;var p;if(t>=b.NUM_TINY){g=-d.dotProduct(r,k.delta);s=n*g-i*h;q=n*h-o*g;if(s>=0){if(s<=t){if(q>=0){if(q<=t){var f=1/t;s*=f;q*=f;l=s*(o*s+n*q+2*h)+q*(n*s+i*q+2*g)+m;}else{q=1;p=n+h;if(p>=0){s=0;l=i+2*g+m;}else{if(-p>=o){s=1;l=o+i+m+2*(g+p);}else{s=-p/o;l=p*s+i+2*g+m;}}}}else{q=0;if(h>=0){s=0;l=m;}else{if(-h>=o){s=1;l=o+2*h+m;}else{s=-h/o;l=h*s+m;}}}}else{if(q>=0){if(q<=t){s=1;p=n+g;if(p>=0){q=0;l=o+2*h+m;}else{if(-p>=i){q=1;l=o+i+m+2*(h+p);}else{q=-p/i;l=p*q+o+2*h+m;}}}else{p=n+h;if(-p<=o){q=1;if(p>=0){s=0;l=i+2*g+m;}else{s=-p/o;l=p*s+i+2*g+m;}}else{s=1;p=n+g;if(p>=0){q=0;l=o+2*h+m;}else{if(-p>=i){q=1;l=o+i+m+2*(h+p);}else{q=-p/i;l=p*q+o+2*h+m;}}}}}else{if(-h<o){q=0;if(h>=0){s=0;l=m;}else{s=-h/o;l=h*s+m;}}else{s=1;p=n+g;if(p>=0){q=0;l=o+2*h+m;}else{if(-p>=i){q=1;l=o+i+m+2*(h+p);}else{q=-p/i;l=p*q+o+2*h+m;}}}}}}else{if(q>=0){if(q<=t){s=0;if(g>=0){q=0;l=m;}else{if(-g>=i){q=1;l=i+2*g+m;}else{q=-g/i;l=g*q+m;}}}else{p=n+h;if(p<0){q=1;if(-p>=o){s=1;l=o+i+m+2*(g+p);}else{s=-p/o;l=p*s+i+2*g+m;}}else{s=0;if(g>=0){q=0;l=m;}else{if(-g>=i){q=1;l=i+2*g+m;}else{q=-g/i;l=g*q+m;}}}}}else{if(h<0){q=0;if(-h>=o){s=1;l=o+2*h+m;}else{s=-h/o;l=h*s+m;}}else{s=0;if(g>=0){q=0;l=m;}else{if(-g>=i){q=1;l=i+2*g+m;}else{q=-g/i;l=g*q+m;}}}}}}else{if(n>0){if(h>=0){s=0;q=0;l=m;}else{if(-h<=o){s=-h/o;q=0;l=h*s+m;}else{g=-d.dotProduct(r,k.delta);s=1;p=o+h;if(-p>=n){q=1;l=o+i+m+2*(n+h+g);}else{q=-p/n;l=o+2*h+m+q*(i*q+2*(n+g));}}}}else{if(-h>=o){s=1;q=0;l=o+2*h+m;}else{if(h<=0){s=-h/o;q=0;l=h*s+m;}else{g=-d.dotProduct(r,k.delta);s=0;if(h>=-n){q=1;l=i+2*g+m;}else{q=-h/n;l=m+q*(2*g+i*q);}}}}}j.t0=s;j.t1=q;return Math.abs(l);};e.prototype.pointSegmentDistanceSq=function(g,h){g.t=0;var j=d.subtract(h,this.origin);var i=d.dotProduct(j,this.delta);if(i<=0){i=0;}else{var f=d.get_lengthSquared(this._delta);if(i>=f){i=1;j=d.subtract(j,this._delta);}else{i/=f;j=d.subtract(j,b.getScaleVector(this._delta,i));}}g.t=i;return d.get_lengthSquared(j);};e.prototype.segmentBoxDistanceSq=function(g,f,k){g.pfLParam=0;g.pfLParam0=0;g.pfLParam1=0;g.pfLParam2=0;var j={};var i=new c(this.origin,this.delta);var h=this.sqrDistanceLine(j,i,f,k);if(j.num>=0){if(j.num<=1){g.pfLParam=j.num;g.pfLParam0=j.num0;g.pfLParam1=j.num1;g.pfLParam2=j.num2;return Math.max(h,0);}else{h=this.sqrDistancePoint(g,d.add(this.origin,this.delta),f,k);g.pfLParam=1;return Math.max(h,0);}}else{h=this.sqrDistancePoint(g,this.origin,f,k);g.pfLParam=0;return Math.max(h,0);}};e.prototype.sqrDistanceLine=function(l,s,q,o){var h=o.getOrientationCols();l.num=0;l.num0=0;l.num1=0;l.num2=0;var r=d.subtract(s.origin,o.position);var f=d.create(d.dotProduct(r,h[0]),d.dotProduct(r,h[1]),d.dotProduct(r,h[2]),0);var k=d.create(d.dotProduct(s.dir,h[0]),d.dotProduct(s.dir,h[1]),d.dotProduct(s.dir,h[2]),0);var j=f.slice(0);var p=k.slice(0);var g=[1,1,1,0];for(var n=0;n<3;n++){if(p[n]<0){j[n]=-j[n];p[n]=-p[n];g[n]=true;}else{g[n]=false;}}b.copyFromArray(f,j);b.copyFromArray(k,p);var m={};m.rkPnt=f.slice(0);m.pfLParam=0;m.rfSqrDistance=0;if(k[0]>0){if(k[1]>0){if(k[2]>0){this.caseNoZeros(m,k,q);l.num=m.pfLParam;}else{this.case0(m,0,1,2,k,q);l.num=m.pfLParam;}}else{if(k[2]>0){this.case0(m,0,2,1,k,q);l.num=m.pfLParam;}else{this.case00(m,0,1,2,k,q);l.num=m.pfLParam;}}}else{if(k[1]>0){if(k[2]>0){this.case0(m,1,2,0,k,q);l.num=m.pfLParam;}else{this.case00(m,1,0,2,k,q);l.num=m.pfLParam;}}else{if(k[2]>0){this.case00(m,2,0,1,k,q);l.num=m.pfLParam;}else{this.case000(m,q);l.num=0;}}}j=m.rkPnt.slice(0);for(n=0;n<3;n++){if(g[n]){j[n]=-j[n];}}b.copyFromArray(m.rkPnt,j);l.num0=m.rkPnt[0];l.num1=m.rkPnt[1];l.num2=m.rkPnt[2];return Math.max(m.rfSqrDistance,0);};e.prototype.sqrDistancePoint=function(h,g,k,i){var m=i.getOrientationCols();var n=d.subtract(g,i.position);var j=d.create(d.dotProduct(n,m[0]),d.dotProduct(n,m[1]),d.dotProduct(n,m[2]),0);var f=0;var o;var l=k.getHalfSideLengths();if(j[0]<-l[0]){o=j[0]+l[0];f+=(o*o);j[0]=-l[0];}else{if(j[0]>l[0]){o=j[0]-l[0];f+=(o*o);j[0]=l[0];}}if(j[1]<-l[1]){o=j[1]+l[1];f+=(o*o);j[1]=-l[1];}else{if(j[1]>l[1]){o=j[1]-l[1];f+=(o*o);j[1]=l[1];}}if(j[2]<-l[2]){o=j[2]+l[2];f+=(o*o);j[2]=-l[2];}else{if(j[2]>l[2]){o=j[2]-l[2];f+=(o*o);j[2]=l[2];}}h.pfLParam0=j[0];h.pfLParam1=j[1];h.pfLParam2=j[2];return Math.max(f,0);};e.prototype.face=function(w,t,s,r,j,f,h){var x=[0,0,0,0];var k;var o;var m;var g;var y;var q;var v=f.getHalfSideLengths();var u=v;var i=w.rkPnt;var l=j;var n=x;var p=h;n[s]=i[s]+u[s];n[r]=i[r]+u[r];b.copyFromArray(h,n);if(l[t]*n[s]>=l[s]*p[t]){if(l[t]*n[r]>=l[r]*p[t]){i[t]=u[t];o=1/l[t];i[s]-=(l[s]*p[t]*o);i[r]-=(l[r]*p[t]*o);w.pfLParam=-p[t]*o;b.copyFromArray(w.rkPnt,i);}else{k=l[t]*l[t]+l[r]*l[r];m=k*n[s]-l[s]*(l[t]*p[t]+l[r]*n[r]);if(m<=2*k*u[s]){y=m/k;k+=(l[s]*l[s]);m=n[s]-y;q=l[t]*p[t]+l[s]*m+l[r]*n[r];g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+m*m+n[r]*n[r]+q*g);w.pfLParam=g;i[t]=u[t];i[s]=y-u[s];i[r]=-u[r];b.copyFromArray(w.rkPnt,i);}else{k+=(l[s]*l[s]);q=l[t]*p[t]+l[s]*p[s]+l[r]*n[r];g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+p[s]*p[s]+n[r]*n[r]+q*g);w.pfLParam=g;i[t]=u[t];i[s]=u[s];i[r]=-u[r];b.copyFromArray(w.rkPnt,i);}}}else{if(l[t]*n[r]>=l[r]*p[t]){k=l[t]*l[t]+l[s]*l[s];m=k*n[r]-l[r]*(l[t]*p[t]+l[s]*n[s]);if(m<=2*k*u[r]){y=m/k;k+=(l[r]*l[r]);m=n[r]-y;q=l[t]*p[t]+l[s]*n[s]+l[r]*m;g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+n[s]*n[s]+m*m+q*g);w.pfLParam=g;i[t]=u[t];i[s]=-u[s];i[r]=y-u[r];b.copyFromArray(w.rkPnt,i);}else{k+=(l[r]*l[r]);q=l[t]*p[t]+l[s]*n[s]+l[r]*p[r];g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+n[s]*n[s]+p[r]*p[r]+q*g);w.pfLParam=g;i[t]=u[t];i[s]=-u[s];i[r]=u[r];b.copyFromArray(w.rkPnt,i);}}else{k=l[t]*l[t]+l[r]*l[r];m=k*n[s]-l[s]*(l[t]*p[t]+l[r]*n[r]);if(m>=0){if(m<=2*k*u[s]){y=m/k;k+=(l[s]*l[s]);m=n[s]-y;q=l[t]*p[t]+l[s]*m+l[r]*n[r];g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+m*m+n[r]*n[r]+q*g);w.pfLParam=g;i[t]=u[t];i[s]=y-u[s];i[r]=-u[r];b.copyFromArray(w.rkPnt,i);}else{k+=(l[s]*l[s]);q=l[t]*p[t]+l[s]*p[s]+l[r]*n[r];g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+p[s]*p[s]+n[r]*n[r]+q*g);w.pfLParam=g;i[t]=u[t];i[s]=u[s];i[r]=-u[r];b.copyFromArray(w.rkPnt,i);}return;}k=l[t]*l[t]+l[s]*l[s];m=k*n[r]-l[r]*(l[t]*p[t]+l[s]*n[s]);if(m>=0){if(m<=2*k*u[r]){y=m/k;k+=(l[r]*l[r]);m=n[r]-y;q=l[t]*p[t]+l[s]*n[s]+l[r]*m;g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+n[s]*n[s]+m*m+q*g);w.pfLParam=g;i[t]=u[t];i[s]=-u[s];i[r]=y-u[r];b.copyFromArray(w.rkPnt,i);}else{k+=(l[r]*l[r]);q=l[t]*p[t]+l[s]*n[s]+l[r]*p[r];g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+n[s]*n[s]+p[r]*p[r]+q*g);w.pfLParam=g;i[t]=u[t];i[s]=-u[s];i[r]=u[r];b.copyFromArray(w.rkPnt,i);}return;}k+=(l[r]*l[r]);q=l[t]*p[t]+l[s]*n[s]+l[r]*n[r];g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+n[s]*n[s]+n[r]*n[r]+q*g);w.pfLParam=g;i[t]=u[t];i[s]=-u[s];i[r]=-u[r];b.copyFromArray(w.rkPnt,i);}}};e.prototype.caseNoZeros=function(i,k,o){var p=o.getHalfSideLengths();var l=d.create(i.rkPnt[0]-p[0],i.rkPnt[1]-p[1],i.rkPnt[2]-p[2],0);var g=k[0]*l[1];var j=k[1]*l[0];var n;var f;var m;var h;if(j>=g){n=k[2]*l[0];f=k[0]*l[2];if(n>=f){this.face(i,0,1,2,k,o,l);}else{this.face(i,2,0,1,k,o,l);}}else{m=k[2]*l[1];h=k[1]*l[2];if(m>=h){this.face(i,1,2,0,k,o,l);}else{this.face(i,2,0,1,k,o,l);}}};e.prototype.case0=function(x,u,t,s,i,f){var w=f.getHalfSideLengths();var v=w.slice(0);var h=x.rkPnt.slice(0);var m=i.slice(0);var q=h[u]-v[u];var p=h[t]-v[t];var j=m[t]*q;var g=m[u]*p;var r;var n;var o;if(j>=g){h[u]=v[u];var k=h[t]+v[t];r=j-m[u]*k;if(r>=0){n=1/(m[u]*m[u]+m[t]*m[t]);x.rfSqrDistance+=(r*r*n);h[t]=-v[t];x.pfLParam=-(m[u]*q+m[t]*k)*n;}else{o=1/m[u];h[t]-=(j*o);x.pfLParam=-q*o;}b.copyFromArray(x.rkPnt,h);}else{h[t]=v[t];var l=h[u]+v[u];r=g-m[t]*l;if(r>=0){n=1/(m[u]*m[u]+m[t]*m[t]);x.rfSqrDistance+=(r*r*n);h[u]=-v[u];x.pfLParam=-(m[u]*l+m[t]*p)*n;}else{o=1/m[t];h[u]-=(g*o);x.pfLParam=-p*o;}b.copyFromArray(x.rkPnt,h);}if(h[s]<-v[s]){r=h[s]+v[s];x.rfSqrDistance+=(r*r);h[s]=-v[s];}else{if(h[s]>v[s]){r=h[s]-v[s];x.rfSqrDistance+=(r*r);h[s]=v[s];}}b.copyFromArray(x.rkPnt,h);};e.prototype.case00=function(j,i,h,g,k,m){var o=0;var n=m.getHalfSideLengths();var f=n.slice(0);var l=j.rkPnt.slice(0);var p=k.slice(0);j.pfLParam=(f[i]-l[i])/p[i];l[i]=f[i];if(l[h]<-f[h]){o=l[h]+f[h];j.rfSqrDistance+=(o*o);l[h]=-f[h];}else{if(l[h]>f[h]){o=l[h]-f[h];j.rfSqrDistance+=(o*o);l[h]=f[h];}}if(l[g]<-f[g]){o=l[g]+f[g];j.rfSqrDistance+=(o*o);l[g]=-f[g];}else{if(l[g]>f[g]){o=l[g]-f[g];j.rfSqrDistance+=(o*o);l[g]=f[g];}}b.copyFromArray(j.rkPnt,l);};e.prototype.case000=function(g,f){var h=0;var i=f.getHalfSideLengths();if(g.rkPnt[0]<-i[0]){h=g.rkPnt[0]+i[0];g.rfSqrDistance+=(h*h);g.rkPnt[0]=-i[0];}else{if(g.rkPnt[0]>i[0]){h=g.rkPnt[0]-i[0];g.rfSqrDistance+=(h*h);g.rkPnt[0]=i[0];}}if(g.rkPnt[1]<-i[1]){h=g.rkPnt[1]+i[1];g.rfSqrDistance+=(h*h);g.rkPnt[1]=-i[1];}else{if(g.rkPnt[1]>i[1]){h=g.rkPnt[1]-i[1];g.rfSqrDistance+=(h*h);g.rkPnt[1]=i[1];}}if(g.rkPnt[2]<-i[2]){h=g.rkPnt[2]+i[2];g.rfSqrDistance+=(h*h);g.rkPnt[2]=-i[2];}else{if(g.rkPnt[2]>i[2]){h=g.rkPnt[2]-i[2];g.rfSqrDistance+=(h*h);g.rkPnt[2]=i[2];}}};a.JSegment=e;})(jigLib);(function(c){var d=c.Vector3DUtil;var b=c.JMatrix3D;var e=c.RigidBody;var a=function(g,f){this.Super(g);this._type="SPHERE";this._radius=f;this._boundingSphere=this._radius;this.set_mass(1);this.updateBoundingBox();};c.extend(a,c.RigidBody);a.prototype.name=null;a.prototype._radius=null;a.prototype.set_radius=function(f){this._radius=f;this._boundingSphere=this._radius;this.setInertia(this.getInertiaProperties(this.get_mass()));this.setActive();this.updateBoundingBox();};a.prototype.get_radius=function(){return this._radius;};a.prototype.segmentIntersect=function(m,n,i){m.fracOut=0;m.posOut=[0,0,0,0];m.normalOut=[0,0,0,0];var j=0;var g=n.delta;var t=d.subtract(n.origin,i.position);var l=this._radius*this._radius;var u=d.get_lengthSquared(g);if(u<l){m.fracOut=0;m.posOut=n.origin.slice(0);m.normalOut=d.subtract(m.posOut,i.position);d.normalize(m.normalOut);return true;}var h=d.dotProduct(t,g);var k=d.get_lengthSquared(t);var o=h*h-u*(k-l);if(o<0){return false;}var q=Math.sqrt(o);var f=(-h-q)/u;var p=(-h+q)/u;if(f>1||p<0){return false;}j=Math.max(f,0);m.fracOut=j;m.posOut=n.getPoint(j);m.normalOut=d.subtract(m.posOut,i.position);d.normalize(m.normalOut);return true;};a.prototype.getInertiaProperties=function(f){var g=0.4*f*this._radius*this._radius;return b.getScaleMatrix(g,g,g);};a.prototype.updateBoundingBox=function(){this._boundingBox.clear();this._boundingBox.addSphere(this);};c.JSphere=a;})(jigLib);(function(a){var c=a.Vector3DUtil;var b=a.JNumber3D;var d=a.RigidBody;var e=function(f){this.Super(null);this._terrain=f;this.set_movable(false);this._type="TERRAIN";};a.extend(e,a.RigidBody);e.prototype._terrain=null;e.prototype.get_terrainMesh=function(){return this._terrain;};e.prototype.getHeightByIndex=function(g,f){g=this.limiteInt(g,0,_terrain.get_sw());f=this.limiteInt(f,0,_terrain.get_sh());return _terrain.get_heights(g,f);};e.prototype.getHeightAndNormalByPoint=function(t){var s=this.limiteInt(t[0],this._terrain.get_minW(),this._terrain.get_maxW());var o=this.limiteInt(t[2],this._terrain.get_minH(),this._terrain.get_maxH());var k=((s-this._terrain.get_minW())/this._terrain.get_dw())|0;var f=((o-this._terrain.get_minH())/this._terrain.get_dh())|0;k=this.limiteInt(k,0,this._terrain.get_sw());f=this.limiteInt(f,0,this._terrain.get_sh());var i=k+1;var u=f+1;i=this.limiteInt(i,0,this._terrain.get_sw());u=this.limiteInt(u,0,this._terrain.get_sh());var j=1-(s-(k*this._terrain.get_dw()+this._terrain.get_minW()))/this._terrain.get_dw();var g=(o-(f*this._terrain.get_dh()+this._terrain.get_minH()))/this._terrain.get_dh();j=b.getLimiteNumber(j,0,1);g=b.getLimiteNumber(g,0,1);var r=this._terrain.get_heights(k,f);var q=this._terrain.get_heights(k,u);var n=this._terrain.get_heights(i,f);var m=this._terrain.get_heights(i,u);var l={};l.height=0;l.normal=[0,0,0,0];var p;if(j<g||k==i||f==u){l.normal=c.crossProduct([0,m-n,this._terrain.get_dh(),0],[this._terrain.get_dw(),m-q,0,0]);c.normalize(l.normal);p=new PlaneData([(i*this._terrain.get_dw()+this._terrain.get_minW()),m,(u*this._terrain.get_dh()+this._terrain.get_minH()),0],l.normal);l.height=p.pointPlaneDistance(t);}else{l.normal=c.crossProduct([0,q-r,this._terrain.get_dh(),0],[this._terrain.get_dw(),n-r,0,0]);c.normalize(l.normal);p=new PlaneData([(k*this._terrain.get_dw()+this._terrain.get_minW()),r,(f*this._terrain.get_dh()+this._terrain.get_minH()),0],l.normal);l.height=p.pointPlaneDistance(t);}return l;};e.prototype.getHeightByPoint=function(f){return this.getHeightAndNormalByPoint(f).height;};e.prototype.getNormalByPoint=function(f){return this.getHeightAndNormalByPoint(f).normal;};e.prototype.getSurfacePosByPoint=function(f){return[f[0],this.getHeightAndNormalByPoint(f).height,f[2],0];};e.prototype.segmentIntersect=function(i,f,j){i.fracOut=0;i.posOut=[0,0,0,0];i.normalOut=[0,0,0,0];if(f.delta[1]>-b.NUM_TINY){return false;}var m=this.getHeightAndNormalByPoint(f.origin);if(m.height<0){return false;}var l=getHeightAndNormalByPoint(f.getEnd());if(l.height>0){return false;}var h=-l.height;var g=1/(b.NUM_TINY+m.height);var k=1/(b.NUM_TINY+l.height);c.scaleBy(m.normal,g);c.scaleBy(l.normal,k);i.normalOut=c.add(m.normal,l.normal);c.scaleBy(i.normalOut,1/(g+k));i.fracOut=m.height/(m.height+h+b.NUM_TINY);i.posOut=f.getPoint(i.fracOut);return true;};e.prototype.limiteInt=function(g,h,f){var i=g;if(i<h){i=h;}else{if(i>f){i=f;}}return i;};a.JTerrain=e;})(jigLib);(function(a){var b=function(){this.accumulatedFrictionImpulse=[0,0,0,0];};b.prototype.initialPenetration=null;b.prototype.r0;b.prototype.r1;b.prototype.position;b.prototype.minSeparationVel=0;b.prototype.denominator=0;b.prototype.accumulatedNormalImpulse=0;b.prototype.accumulatedNormalImpulseAux=0;b.prototype.accumulatedFrictionImpulse=null;a.CollPointInfo=b;})(jigLib);(function(a){var c=a.MaterialProperties;var b=function(){this.mat=new c();this.pointInfo=[];};b.prototype.mat=null;b.prototype.objInfo=null;b.prototype.dirToBody=null;b.prototype.pointInfo=null;b.prototype.satisfied=null;a.CollisionInfo=b;})(jigLib);(function(a){var b=function(){};b.prototype.body0=null;b.prototype.body1=null;a.CollDetectInfo=b;})(jigLib);(function(a){var b=function(){};b.prototype.name=null;b.prototype.type0=null;b.prototype.type1=null;b.prototype.collDetect=function(d,c){};a.CollDetectFunctor=b;})(jigLib);(function(d){var m=d.Vector3DUtil;var b=d.JNumber3D;var f=d.JMatrix3D;var i=d.JConstraint;var o=d.JSegment;var g=d.JConfig;var h=d.JSphere;var c=d.MaterialProperties;var a=d.PhysicsState;var e=d.EdgeData;var j=d.SpanData;var k=d.CollPointInfo;var n=d.CollisionInfo;var l=function(){this.name="BoxBox";this.type0="BOX";this.type1="BOX";};d.extend(l,d.CollDetectFunctor);l.prototype.combinationDist=null;l.prototype.disjoint=function(u,r,x,w){var t=x.getSpan(r);var s=w.getSpan(r);var p=t.min;var v=t.max;var y=s.min;var q=s.max;var z=Math.min;if(p>(q+g.collToll+b.NUM_TINY)||y>(v+g.collToll+b.NUM_TINY)){u.flag=true;return true;}if((v>q)&&(y>p)){u.depth=z(v-y,q-p);}else{if((q>v)&&(p>y)){u.depth=z(q-p,v-y);}else{u.depth=(v<q)?v:q;u.depth-=(p>y)?p:y;}}u.flag=false;return false;};l.prototype.addPoint=function(t,s,p){for(var r=0,q=t.length;r<q;r++){var u=t[r];if(m.get_lengthSquared(m.subtract(u,s))<p){u=b.getDivideVector(m.add(u,s),2);return false;}}t.push(s);return true;};l.prototype.getSupportPoint=function(v,t){var r=v.get_currentState().getOrientationCols();var u=m.dotProduct(t,r[0]);var q=m.dotProduct(t,r[1]);var x=m.dotProduct(t,r[2]);var w=v.get_currentState().position.slice(0);var s=v.get_sideLengths();if(u<-b.NUM_TINY){w=m.add(w,b.getScaleVector(r[0],0.5*s[0]));}else{if(u>=b.NUM_TINY){w=m.subtract(w,b.getScaleVector(r[0],0.5*s[0]));}}if(q<-b.NUM_TINY){w=m.add(w,b.getScaleVector(r[1],0.5*s[1]));}else{if(q>b.NUM_TINY){w=m.subtract(w,b.getScaleVector(r[1],0.5*s[1]));}}if(x<-b.NUM_TINY){w=m.add(w,b.getScaleVector(r[2],0.5*s[2]));}else{if(x>b.NUM_TINY){w=m.subtract(w,b.getScaleVector(r[2],0.5*s[2]));}}return w;};l.prototype.getAABox2EdgeIntersectionPoints=function(t,x,H,J,I){var E;var G;var w;var u;var p;var s=0;var C;var q=m.subtract(I,J);m.normalize(q);var F=[];var r=[];var y=J;var D=I;var A=q;var B=b.getScaleVector(x,0.5);for(var z=2;z>=0;z--){if(Math.abs(A[z])<0.1){continue;}E=(z+1)%3;G=(z+2)%3;r=[-B[z],B[z]];for(var v=1;v>=0;v--){w=y[z]-r[v];u=D[z]-r[v];p=-1;if(w*u<-b.NUM_TINY){p=-w/(u-w);}else{if(Math.abs(w)<b.NUM_TINY){p=0;}else{if(Math.abs(u)<b.NUM_TINY){p=1;}}}if(p>=0){C=m.add(b.getScaleVector(J,1-p),b.getScaleVector(I,p));F=C;if((F[E]>-B[E]-b.NUM_TINY)&&(F[E]<B[E]+b.NUM_TINY)&&(F[G]>-B[G]-b.NUM_TINY)&&(F[G]<B[G]+b.NUM_TINY)){C=C.splice(0);f.multiplyVector(H.get_orientation(),C);C=m.add(C,H.position);this.addPoint(t,C,combinationDist);if(++s==2){return s;}}}}}return s;};l.prototype.getBox2BoxEdgesIntersectionPoints=function(x,B,z,t){var y=0;var u;var C=(t)?B.get_currentState():B.get_oldState();var s=(t)?z.get_currentState():z.get_oldState();var q=z.getCornerPointsInBoxSpace(s,C);var A=z.get_edges();var r;var p;for(var w=0;w<A.length;w++){var v=A[w];r=q[v.ind0];p=q[v.ind1];y+=this.getAABox2EdgeIntersectionPoints(x,B.get_sideLengths(),C,r,p);if(y>=8){return y;}}return y;};l.prototype.getBoxBoxIntersectionPoints=function(s,q,p,r){this.getBox2BoxEdgesIntersectionPoints(s,q,p,r);this.getBox2BoxEdgesIntersectionPoints(s,p,q,r);return m.get_length(s);};l.prototype.collDetect=function(ac,D){var R=ac.body0;var P=ac.body1;if(!R.hitTestObject3D(P)){return;}if(g.aabbDetection&&!R.get_boundingBox().overlapTest(P.get_boundingBox())){return;}var aj=b.NUM_TINY;var v=b.NUM_HUGE;var z=R.get_currentState().getOrientationCols();var M=P.get_currentState().getOrientationCols();var U=[z[0],z[1],z[2],M[0],M[1],M[2],m.crossProduct(z[0],M[0]),m.crossProduct(z[1],M[0]),m.crossProduct(z[2],M[0]),m.crossProduct(z[0],M[1]),m.crossProduct(z[1],M[1]),m.crossProduct(z[2],M[1]),m.crossProduct(z[0],M[2]),m.crossProduct(z[1],M[2]),m.crossProduct(z[2],M[2])];var y;var ab=[];var Z=0;var A=U.length;for(Z=0;Z<A;Z++){var ad=ab[Z]=new j();ad.depth=v;y=m.get_lengthSquared(U[Z]);if(y<aj){continue;}var q=U[Z].slice(0);m.normalize(q);if(this.disjoint(ab[Z],q,R,P)){return;}}var I=v;var O=-1;A=U.length;for(Z=0;Z<A;Z++){y=m.get_lengthSquared(U[Z]);if(y<aj){continue;}if(ab[Z].depth<I){I=ab[Z].depth;O=Z;}}if(O==-1){return;}var w=U[O].splice(0);if(m.dotProduct(m.subtract(P.get_currentState().position,R.get_currentState().position),w)>0){w=b.getScaleVector(w,-1);}var ag=true;var aa=[];var S=R.get_sideLengths();var X=P.get_sideLengths();combinationDist=0.05*Math.min(Math.min(S[0],S[1],S[2]),Math.min(X[0],X[1],X[2]));combinationDist+=(g.collToll*3.464);combinationDist*=combinationDist;if(I>-b.NUM_TINY){this.getBoxBoxIntersectionPoints(aa,R,P,false);}if(aa.length==0){ag=false;this.getBoxBoxIntersectionPoints(aa,R,P,true);}var K=m.subtract(m.subtract(R.get_currentState().position,R.get_oldState().position),m.subtract(P.get_currentState().position,P.get_oldState().position));var p=m.dotProduct(K,w);var J=I+p;var F=[];switch(O){case 0:case 1:case 2:F=this.getSupportPoint(P,b.getScaleVector(w,-1));break;case 3:case 4:case 5:F=this.getSupportPoint(R,w);break;case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:Z=O-6;var T=(Z/3)|0;var Q=Z-T*3;var E=this.getSupportPoint(R,w);var C=this.getSupportPoint(P,b.getScaleVector(w,-1));var V=m.crossProduct(w,M[Q]);var L=m.dotProduct(V,C);var ae=m.dotProduct(z[T],V);if(Math.abs(ae)<b.NUM_TINY){return;}var W=(L-m.dotProduct(E,V))/ae;E=m.add(E,b.getScaleVector(z[T],W));F=m.add(E,b.getScaleVector(w,0.5*I));break;}var ai;if(aa.length>0){ai=[];var B=b.NUM_HUGE;var H=-b.NUM_HUGE;var r;var u;var af;var x;var s;for(var Y=0;Y<aa.length;Y++){s=aa[Y];r=m.get_length(m.subtract(s,F));if(r<B){B=r;}if(r>H){H=r;}}if(H<B+b.NUM_TINY){H=B+b.NUM_TINY;}Z=0;for(var Y=0;Y<aa.length;Y++){s=aa[Y];r=m.get_length(m.subtract(s,F));af=(r-B)/(H-B);u=(1-af)*J;x=new k();if(ag){x.r0=m.subtract(s,R.get_oldState().position);x.r1=m.subtract(s,P.get_oldState().position);}else{x.r0=m.subtract(s,R.get_currentState().position);x.r1=m.subtract(s,P.get_currentState().position);}x.initialPenetration=u;ai[Z++]=x;}}else{x=new k();x.r0=m.subtract(F,R.get_currentState().position);x.r1=m.subtract(F,P.get_currentState().position);x.initialPenetration=J;ai=[];ai[0]=x;}var ah=new n();ah.objInfo=ac;ah.dirToBody=w;ah.pointInfo=ai;var G=new c();G.set_restitution(Math.sqrt(R.get_material().get_restitution()*P.get_material().get_restitution()));G.set_friction(Math.sqrt(R.get_material().get_friction()*P.get_material().get_friction()));ah.mat=G;D.push(ah);ac.body0.collisions.push(ah);ac.body1.collisions.push(ah);};d.CollDetectBoxBox=l;})(jigLib);(function(r){var j=r.Vector3DUtil;var h=r.JNumber3D;var s=r.JConstraint;var b=r.JConfig;var i=r.JSphere;var l=r.MaterialProperties;var k=r.RigidBody;var p=r.CollPointInfo;var a=r.CollisionInfo;var q=r.JBox;var e=r.JIndexedTriangle;var n=r.JSegment;var g=r.JTriangle;var f=r.JTriangleMesh;var o=r.CollOutData;var c=r.EdgeData;var d=r.SpanDatadot;var d=r.SpanData;var m=function(){this.name="BoxMesh";this.type0="BOX";this.type1="TRIANGLEMESH";};r.extend(m,r.CollDetectFunctor);m.prototype.disjoint=function(z,w,C,B){var y=C.getSpan(w);var x=B.getSpan(w);var u=y.min,A=y.max,D=x.min,v=x.max,t=h.NUM_TINY;if(u>(v+b.collToll+t)||D>(A+b.collToll+t)){z.flag=true;return true;}if((A>v)&&(D>u)){z.depth=Math.min(A-D,v-u);}else{if((v>A)&&(u>D)){z.depth=Math.min(v-u,A-D);}else{z.depth=Math.min(A,v);z.depth-=Math.max(u,D);}}z.flag=false;return false;};m.prototype.addPoint=function(w,v,t){for(var u=0;u<w.length;u++){var x=w[u];if(j.get_lengthSquared(j.subtract(x,v))<t){x=j.add(x,v);j.scaleBy(x,0.5);return false;}}w.push(v);return true;};m.prototype.getBoxTriangleIntersectionPoints=function(E,A,z,D){var w=A.get_edges();var t=A.getCornerPoints(A.get_currentState());var y;var u;var v;for(var x=0;x<12;x++){u=w[x];y=new o();v=new n(t[u.ind0],j.subtract(t[u.ind1],t[u.ind0]));if(z.segmentTriangleIntersection(y,v)){this.addPoint(E,v.getPoint(y.frac),D);if(E.length>8){return E.length;}}}var C,B;for(x=0;x<3;x++){C=z.getVertex(x);B=z.getVertex((x+1)%3);y=new o();if(A.segmentIntersect(y,new n(C,j.subtract(B,C)),A.get_currentState())){this.addPoint(E,y.position,D);if(E.length>8){return E.length;}}if(A.segmentIntersect(y,new n(B,j.subtract(C,B)),A.get_currentState())){this.addPoint(E,y.position,D);if(E.length>8){return E.length;}}}return E.length;};m.prototype.doOverlapBoxTriangleTest=function(B,S,t,X,T){var P,K,J,W,H,y,C,Z,V,ab;var F=B.get_currentState().getOrientationCols();var O=new g(t.get_octree().getVertex(S.getVertexIndex(0)),t.get_octree().getVertex(S.getVertexIndex(1)),t.get_octree().getVertex(S.getVertexIndex(2)));P=j.subtract(O.getVertex(1),O.getVertex(0));j.normalize(P);K=j.subtract(O.getVertex(2),O.getVertex(1));j.normalize(K);J=j.subtract(O.getVertex(0),O.getVertex(2));j.normalize(J);var W=S.get_plane().normal.slice(0);var E=13;var R=[W,F[0],F[1],F[2],j.crossProduct(F[0],P),j.crossProduct(F[0],K),j.crossProduct(F[0],J),j.crossProduct(F[1],P),j.crossProduct(F[1],K),j.crossProduct(F[1],J),j.crossProduct(F[2],P),j.crossProduct(F[2],K),j.crossProduct(F[2],J)];var A=[];for(var Q=0;Q<E;Q++){A[Q]=new d();if(this.disjoint(A[Q],R[Q],B,O)){return false;}}var G=-1;var w=h.NUM_TINY,Y=h.NUM_HUGE,I,z,ac,u,aa;for(Q=0;Q<E;Q++){I=j.get_lengthSquared(R[Q]);if(I<w){continue;}z=1/Math.sqrt(I);j.scaleBy(R[Q],z);A[Q].depth*=z;if(A[Q].depth<Y){Y=A[Q].depth;G=Q;}}if(G==-1){return false;}H=j.subtract(B.get_currentState().position,O.getCentre());y=R[G];ac=A[G].depth;if(j.dotProduct(H,y)<0){j.negate(y);}C=B.get_oldState().position;Z=B.get_currentState().position;V=t.get_currentState().position;var ad=[];u=ac+0.05;this.getBoxTriangleIntersectionPoints(ad,B,O,u*u);ab=j.subtract(Z,C);aa=ac+j.dotProduct(ab,y);var v=ad.length;var M=[];if(v>0){var x;for(Q=0;Q<v;Q++){x=new p();x.r0=j.subtract(ad[Q],Z);x.r1=j.subtract(ad[Q],V);x.initialPenetration=aa;M[Q]=x;}var L=new a();L.objInfo=X;L.dirToBody=y;L.pointInfo=M;var U=new l();U.set_restitution(0.5*(B.get_material().get_restitution()+t.get_material().get_restitution()));U.set_friction(0.5*(B.get_material().get_friction()+t.get_material().get_friction()));L.mat=U;T.push(L);X.body0.collisions.push(L);X.body1.collisions.push(L);return true;}else{return false;}};m.prototype.collDetectBoxStaticMeshOverlap=function(x,E,u,B){var v=x.get_boundingSphere();var D=x.get_currentState().position;var w=[];var t=E.get_octree().getTrianglesIntersectingtAABox(w,x.get_boundingBox());var C=false;var z;var y;for(var A=0;A<t;++A){y=E.get_octree().getTriangle(w[A]);z=y.get_plane().pointPlaneDistance(D);if(z>v||z<0){continue;}if(this.doOverlapBoxTriangleTest(x,y,E,u,B)){C=true;}}return C;};m.prototype.collDetect=function(w,v){var t;if(w.body0.type=="TRIANGLEMESH"){t=w.body0;w.body0=w.body1;w.body1=t;}var u=w.body0;var x=w.body1;this.collDetectBoxStaticMeshOverlap(u,x,w,v);};r.CollDetectBoxMesh=m;})(jigLib);(function(e){var i=e.Vector3DUtil;var a=e.JNumber3D;var g=e.JConstraint;var f=e.JConfig;var b=e.JPlane;var k=e.JSegment;var d=e.JBox;var c=e.MaterialProperties;var l=e.RigidBody;var h=e.CollPointInfo;var j=e.CollisionInfo;var m=function(){this.name="BoxPlane";this.type0="BOX";this.type1="PLANE";};e.extend(m,e.CollDetectFunctor);m.prototype.collDetect=function(q,A){var v;if(q.body0.get_type()=="PLANE"){v=q.body0;q.body0=q.body1;q.body1=v;}var t=q.body0;var u=q.body1;var B=u.pointPlaneDistance(t.get_currentState().position);if(B>t.get_boundingSphere()+f.collToll){return;}var D=t.getCornerPoints(t.get_currentState());var w=t.getCornerPoints(t.get_oldState());var r=[];var p;var o;var n;var z;var x;for(var s=0;s<8;s++){o=D[s];n=w[s];z=-1*u.pointPlaneDistance(o);x=-1*u.pointPlaneDistance(n);if(Math.max(z,x)>-f.collToll){p=new h();p.r0=i.subtract(n,t.get_oldState().position);p.r1=i.subtract(n,u.get_oldState().position);p.initialPenetration=x;r.push(p);}}if(r.length>0){var y=new j();y.objInfo=q;y.dirToBody=u.get_normal();y.pointInfo=r;var C=new c();C.set_restitution(Math.sqrt(t.get_material().get_restitution()*u.get_material().get_restitution()));C.set_friction(Math.sqrt(t.get_material().get_friction()*u.get_material().get_friction()));y.mat=C;A.push(y);q.body0.collisions.push(y);q.body1.collisions.push(y);}};e.CollDetectBoxPlane=m;})(jigLib);(function(e){var i=e.Vector3DUtil;var a=e.JNumber3D;var h=e.JConstraint;var g=e.JConfig;var f=e.JTerrain;var d=e.JBox;var c=e.MaterialProperties;var j=e.RigidBody;var b=function(){this.name="BoxTerrain";this.type0="BOX";this.type1="TERRAIN";};e.extend(b,e.CollDetectFunctor);b.prototype.collDetect=function(o,y){var t;if(o.body0.type=="TERRAIN"){t=o.body0;o.body0=o.body1;o.body1=t;}var s=o.body0;var m=o.body1;var v=s.getCornerPoints(s.oldState);var A=s.getCornerPoints(s.currentState);var u=[0,0,0,0];var r;var x;var l;var k;var p=[];var n;for(var q=0;q<8;q++){l=A[q];r=m.getHeightAndNormalByPoint(l);if(r.height<g.collToll){k=v[q];x=m.getHeightByPoint(k);u=i.add(u,r.normal);n=new CollPointInfo();n.r0=i.subtract(k,s.oldState.position);n.r1=i.subtract(k,m.oldState.position);n.initialPenetration=-x;p.push(n);}}if(p.length>0){i.normalize(u);var w=new CollisionInfo();w.objInfo=o;w.dirToBody=u;w.pointInfo=p;var z=new c();z.restitution=Math.sqrt(s.material.restitution*m.material.restitution);z.friction=Math.sqrt(s.material.friction*m.material.friction);w.mat=z;y.push(w);o.body0.collisions.push(w);o.body1.collisions.push(w);}};e.CollDetectBoxTerrain=b;})(jigLib);(function(e){var k=e.Vector3DUtil;var f=e.JMatrix3D;var a=e.JNumber3D;var h=e.JConstraint;var g=e.JConfig;var i=e.JCapsule;var m=e.JSegment;var d=e.JBox;var b=e.MaterialProperties;var n=e.RigidBody;var j=e.CollPointInfo;var l=e.CollisionInfo;var c=function(){this.name="CapsuleBox";this.type0="CAPSULE";this.type1="BOX";};e.extend(c,e.CollDetectFunctor);c.prototype.collDetect=function(G,E){var y;if(G.body0.get_type()=="BOX"){y=G.body0;G.body0=G.body1;G.body1=y;}var x=G.body0;var w=G.body1;if(!x.hitTestObject3D(w)){return;}if(g.aabbDetection&&!x.get_boundingBox().overlapTest(w.get_boundingBox())){return;}var D=[];var t;var o=[0,0,0,0];var r=new m(x.getEndPos(x.get_oldState()),a.getScaleVector(x.get_oldState().getOrientationCols()[1],-k.get_length(x)));var A=new m(x.getEndPos(x.get_currentState()),a.getScaleVector(x.get_currentState().getOrientationCols()[1],-k.get_length(x)));var q=x.get_radius();var J={};var I=r.segmentBoxDistanceSq(J,w,w.get_oldState());var u={};var s=A.segmentBoxDistanceSq(u,w,w.get_currentState());var p=w.get_oldState().getOrientationCols();if(Math.min(I,s)<Math.pow(q+g.collToll,2)){var v=r.getPoint(Number(J.pfLParam));var H=w.get_oldState().position.slice(0);H=k.add(H,a.getScaleVector(p[0],J.pfLParam0));H=k.add(H,a.getScaleVector(p[1],J.pfLParam1));H=k.add(H,a.getScaleVector(p[2],J.pfLParam2));var B=Math.sqrt(I);var K=q-B;var z;if(B>a.NUM_TINY){z=k.subtract(v,H);k.normalize(z);}else{if(k.get_length(k.subtract(v,w.get_oldState().position))>a.NUM_TINY){z=k.subtract(v,w.get_oldState().position);k.normalize(z);}else{z=k.Y_AXIS;f.multiplyVector(f.getRotationMatrix(0,0,1,360*Math.random()),z);}}o=k.add(o,z);t=new j();t.r0=k.subtract(H,x.get_oldState().position);t.r1=k.subtract(H,w.get_oldState().position);t.initialPenetration=K;D.push(t);}r=new m(x.getBottomPos(x.get_oldState()),a.getScaleVector(x.get_oldState().getOrientationCols()[1],k.get_length(x)));A=new m(x.getBottomPos(x.get_currentState()),a.getScaleVector(x.get_currentState().getOrientationCols()[1],k.get_length(x)));J={};I=r.segmentBoxDistanceSq(J,w,w.get_oldState());u={};s=A.segmentBoxDistanceSq(u,w,w.get_currentState());if(Math.min(I,s)<Math.pow(q+g.collToll,2)){v=r.getPoint(Number(J.pfLParam));H=w.get_oldState().position.slice(0);H=k.add(H,a.getScaleVector(p[0],J.pfLParam0));H=k.add(H,a.getScaleVector(p[1],J.pfLParam1));H=k.add(H,a.getScaleVector(p[2],J.pfLParam2));B=Math.sqrt(I);K=q-B;if(B>a.NUM_TINY){z=k.subtract(v,H);k.normalize(z);}else{if(k.get_length(k.subtract(v,w.get_oldState().position))>a.NUM_TINY){z=k.subtract(v,w.get_oldState().position);k.normalize(z);}else{z=k.Y_AXIS;f.multiplyVector(f.getRotationMatrix(0,0,1,360*Math.random()),z);}}o=k.add(o,z);t=new j();t.r0=k.subtract(H,x.get_oldState().position);t.r1=k.subtract(H,w.get_oldState().position);t.initialPenetration=K;D.push(t);}if(D.length>0){o.normalize();var C=new l();C.objInfo=G;C.dirToBody=o;C.pointInfo=D;var F=new b();F.set_restitution(Math.sqrt(x.get_material().get_restitution()*w.get_material().get_restitution()));F.set_friction(Math.sqrt(x.get_material().get_friction()*w.get_material().get_friction()));C.mat=F;E.push(C);G.body0.collisions.push(C);G.body1.collisions.push(C);}};e.CollDetectCapsuleBox=c;})(jigLib);(function(d){var j=d.Vector3DUtil;var e=d.JMatrix3D;var a=d.JNumber3D;var g=d.JConstraint;var f=d.JConfig;var h=d.JCapsule;var l=d.JSegment;var c=d.MaterialProperties;var m=d.RigidBody;var i=d.CollPointInfo;var k=d.CollisionInfo;var b=function(){this.name="CapsuleCapsule";this.type0="CAPSULE";this.type1="CAPSULE";};d.extend(b,d.CollDetectFunctor);b.prototype.collDetect=function(E,C){var H=E.body0;var G=E.body1;if(!H.hitTestObject3D(G)){return;}if(f.aabbDetection&&!H.get_boundingBox().overlapTest(G.get_boundingBox())){return;}var B=[];var u;var n=[0,0,0,0];var p=new l(H.getEndPos(H.get_oldState()),a.getScaleVector(H.get_oldState().getOrientationCols()[1],-j.get_length(H)));var y=new l(H.getEndPos(H.get_currentState()),a.getScaleVector(H.get_currentState().getOrientationCols()[1],-j.get_length(H)));var o=new l(G.getEndPos(G.get_oldState()),a.getScaleVector(G.get_oldState().getOrientationCols()[1],-j.get_length(G)));var x=new l(G.getEndPos(G.get_currentState()),a.getScaleVector(G.get_currentState().getOrientationCols()[1],-j.get_length(G)));var q=H.get_radius()+G.get_radius();var J={};var I=p.segmentSegmentDistanceSq(J,o);var v={};var t=y.segmentSegmentDistanceSq(J,x);if(Math.min(I,t)<Math.pow(q+f.collToll,2)){var s=p.getPoint(J.t0);var r=o.getPoint(J.t1);var F=j.subtract(s,r);var z=Math.sqrt(I);var K=q-z;if(z>a.NUM_TINY){F=a.getDivideVector(F,z);}else{F=j.Y_AXIS;e.multiplyVector(e.getRotationMatrix(0,0,1,360*Math.random()),F);}var w=j.add(r,a.getScaleVector(F,G.get_radius()-0.5*K));n=j.add(n,F);u=new i();u.r0=j.subtract(w,H.get_oldState().position);u.r1=j.subtract(w,G.get_oldState().position);u.initialPenetration=K;B.push(u);}p=new l(H.getBottomPos(H.get_oldState()),a.getScaleVector(H.get_oldState().getOrientationCols()[1],j.get_length(H)));y=new l(H.getBottomPos(H.get_currentState()),a.getScaleVector(H.get_currentState().getOrientationCols()[1],j.get_length(H)));o=new l(G.getBottomPos(G.get_oldState()),a.getScaleVector(G.get_oldState().getOrientationCols()[1],j.get_length(G)));x=new l(G.getBottomPos(G.get_currentState()),a.getScaleVector(G.get_currentState().getOrientationCols()[1],j.get_length(G)));J={};I=p.segmentSegmentDistanceSq(J,o);v={};t=y.segmentSegmentDistanceSq(J,x);if(Math.min(I,t)<Math.pow(q+f.collToll,2)){s=p.getPoint(J.t0);r=o.getPoint(J.t1);F=j.subtract(s,r);z=Math.sqrt(I);K=q-z;if(z>a.NUM_TINY){F=a.getDivideVector(F,z);}else{F=j.Y_AXIS;e.multiplyVector(e.getRotationMatrix(0,0,1,360*Math.random()),F);}w=j.add(r,a.getScaleVector(F,G.get_radius()-0.5*K));n=j.add(n,F);u=new i();u.r0=j.subtract(w,H.get_oldState().position);u.r1=j.subtract(w,G.get_oldState().position);u.initialPenetration=K;B.push(u);}if(B.length>0){j.normalize(n);var A=new k();A.objInfo=E;A.dirToBody=n;A.pointInfo=B;var D=new c();D.set_restitution(Math.sqrt(H.get_material().get_restitution()*G.get_material().get_restitution()));D.set_friction(Math.sqrt(H.get_material().get_friction()*G.get_material().get_friction()));A.mat=D;C.push(A);E.body0.collisions.push(A);E.body1.collisions.push(A);}};d.CollDetectCapsuleCapsule=b;})(jigLib);(function(c){var j=c.Vector3DUtil;var a=c.JNumber3D;var g=c.JConstraint;var e=c.JConfig;var h=c.JCapsule;var d=c.JPlane;var b=c.MaterialProperties;var l=c.RigidBody;var i=c.CollPointInfo;var k=c.CollisionInfo;var f=function(){this.name="CapsulePlane";this.type0="CAPSULE";this.type1="PLANE";};c.extend(f,c.CollDetectFunctor);f.prototype.collDetect=function(m,z){var u;if(m.body0.get_type()=="PLANE"){u=m.body0;m.body0=m.body1;m.body1=u;}var r=m.body0;var t=m.body1;var q=[];var n;var s=r.getBottomPos(r.get_oldState());var y=t.pointPlaneDistance(s);var x=r.getBottomPos(r.get_currentState());var p=t.pointPlaneDistance(x);if(Math.min(y,p)<r.get_radius()+e.collToll){var v=r.get_radius()-y;var o=j.subtract(s,a.getScaleVector(t.get_normal(),r.get_radius()));n=new i();n.r0=j.subtract(o,r.get_oldState().position);n.r1=j.subtract(o,t.get_oldState().position);n.initialPenetration=v;q.push(n);}s=r.getEndPos(r.get_oldState());x=r.getEndPos(r.get_currentState());y=t.pointPlaneDistance(s);p=t.pointPlaneDistance(x);if(Math.min(y,p)<r.get_radius()+e.collToll){v=r.get_radius()-y;o=j.subtract(s,a.getScaleVector(t.get_normal(),r.get_radius()));n=new i();n.r0=j.subtract(o,r.get_oldState().position);n.r1=j.subtract(o,t.get_oldState().position);n.initialPenetration=v;q.push(n);}if(q.length>0){var w=new k();w.objInfo=m;w.dirToBody=t.get_normal();w.pointInfo=q;var A=new b();A.set_restitution(Math.sqrt(r.get_material().get_restitution()*t.get_material().get_restitution()));A.set_friction(Math.sqrt(r.get_material().get_friction()*t.get_material().get_friction()));w.mat=A;z.push(w);m.body0.collisions.push(w);m.body1.collisions.push(w);}};c.CollDetectCapsulePlane=f;})(jigLib);(function(c){var h=c.Vector3DUtil;var a=c.JNumber3D;var f=c.JConstraint;var e=c.JConfig;var g=c.JCapsule;var d=c.JTerrain;var b=c.MaterialProperties;var j=c.RigidBody;var i=function(){this.name="BoxTerrain";this.type0="CAPSULE";this.type1="TERRAIN";};c.extend(i,c.CollDetectFunctor);i.prototype.collDetect=function(l,w){var s;if(l.body0.type=="TERRAIN"){s=l.body0;l.body0=l.body1;l.body1=s;}var p=l.body0;var k=l.body1;var o=[];var m;var y=[0,0,0,0];var x=p.getBottomPos(p.oldState);var v=p.getBottomPos(p.currentState);var r=k.getHeightAndNormalByPoint(x);var q=k.getHeightAndNormalByPoint(v);if(Math.min(r.height,q.height)<e.collToll+p.radius){var t=p.radius-r.height;var n=h.subtract(x,a.getScaleVector(q.normal,p.radius));m=new CollPointInfo();m.r0=h.subtract(n,p.oldState.position);m.r1=h.subtract(n,k.oldState.position);m.initialPenetration=t;o.push(m);y=h.add(y,q.normal);}x=p.getEndPos(p.oldState);v=p.getEndPos(p.currentState);r=k.getHeightAndNormalByPoint(x);q=k.getHeightAndNormalByPoint(v);if(Math.min(r.height,q.height)<e.collToll+p.radius){t=p.radius-r.height;n=h.subtract(x,a.getScaleVector(q.normal,p.radius));m=new CollPointInfo();m.r0=h.subtract(n,p.oldState.position);m.r1=h.subtract(n,k.oldState.position);m.initialPenetration=t;o.push(m);y=h.add(y,q.normal);}if(o.length>0){h.normalize(y);var u=new CollisionInfo();u.objInfo=l;u.dirToBody=y;u.pointInfo=o;var z=new b();z.restitution=Math.sqrt(p.material.restitution*k.material.restitution);z.friction=Math.sqrt(p.material.friction*k.material.friction);u.mat=z;w.push(u);l.body0.collisions.push(u);l.body1.collisions.push(u);}};c.CollDetectCapsuleTerrain=i;})(jigLib);(function(a){var b=function(){};b.prototype.name=null;b.prototype.type0=null;b.prototype.type1=null;b.prototype.collDetect=function(d,c){};a.CollDetectFunctor=b;})(jigLib);(function(a){var b=function(){};b.prototype.body0=null;b.prototype.body1=null;a.CollDetectInfo=b;})(jigLib);(function(b){var f=b.Vector3DUtil;var e=b.JNumber3D;var a=b.JConfig;var h=b.MaterialProperties;var c=b.CollPointInfo;var d=b.CollisionInfo;var g=function(){this.name="SphereBox";this.type0="SPHERE";this.type1="BOX";};b.extend(g,b.CollDetectFunctor);g.prototype.collDetect=function(j,u){var q;if(j.body0.get_type()=="BOX"){q=j.body0;j.body0=j.body1;j.body1=q;}var n=j.body0;var o=j.body1;if(!n.hitTestObject3D(o)){return;}if(a.aabbDetection&&!n.get_boundingBox().overlapTest(o.get_boundingBox())){return;}var p={};var x={};var v=o.getDistanceToPoint(o.get_oldState(),p,n.get_oldState().position);var m=o.getDistanceToPoint(o.get_currentState(),x,n.get_currentState().position);var r=n.get_radius()-v;var t=n.get_radius()-m;if(Math.max(r,t)>-a.collToll){var l;var k=[];if(v<-e.NUM_TINY){l=f.subtract(f.subtract(p.pos,n.get_oldState().position),p.pos);f.normalize(l);}else{if(v>e.NUM_TINY){l=f.subtract(n.get_oldState().position,p.pos);f.normalize(l);}else{l=f.subtract(n.get_oldState().position,o.get_oldState().position);f.normalize(l);}}var i=new c();i.r0=f.subtract(p.pos,n.get_oldState().position);i.r1=f.subtract(p.pos,o.get_oldState().position);i.initialPenetration=r;k.push(i);var s=new d();s.objInfo=j;s.dirToBody=l;s.pointInfo=k;var w=new h();w.set_restitution(Math.sqrt(n.get_material().get_restitution()*o.get_material().get_restitution()));w.set_friction(Math.sqrt(n.get_material().get_friction()*o.get_material().get_friction()));s.mat=w;u.push(s);j.body0.collisions.push(s);j.body1.collisions.push(s);}};b.CollDetectSphereBox=g;})(jigLib);(function(c){var i=c.Vector3DUtil;var d=c.JMatrix3D;var a=c.JNumber3D;var g=c.JConstraint;var e=c.JConfig;var f=c.JSphere;var k=c.JSegment;var b=c.MaterialProperties;var m=c.RigidBody;var h=c.CollPointInfo;var j=c.CollisionInfo;var l=function(){this.name="SphereCapsule";this.type0="SPHERE";this.type1="CAPSULE";};c.extend(l,c.CollDetectFunctor);l.prototype.collDetect=function(D,B){var w;if(D.body0.get_type()=="CAPSULE"){w=D.body0;D.body0=D.body1;D.body1=w;}var p=D.body0;var v=D.body1;if(!p.hitTestObject3D(v)){return;}if(e.aabbDetection&&!p.get_boundingBox().overlapTest(v.get_boundingBox())){return;}var o=new k(v.getBottomPos(v.get_oldState()),a.getScaleVector(v.get_oldState().getOrientationCols()[1],i.get_length(v)+2*v.get_radius()));var x=new k(v.getBottomPos(v.get_currentState()),a.getScaleVector(v.get_currentState().getOrientationCols()[1],i.get_length(v)+2*v.get_radius()));var n=p.get_radius()+v.get_radius();var G={};var F=o.pointSegmentDistanceSq(G,p.get_oldState().position);var s={};var q=x.pointSegmentDistanceSq(s,p.get_currentState().position);if(Math.min(F,q)<Math.pow(n+e.collToll,2)){var u=o.getPoint(G.t);var E=i.subtract(p.get_oldState().position,u);var y=Math.sqrt(F);var H=n-y;if(y>a.NUM_TINY){E=a.getDivideVector(E,y);}else{E=i.Y_AXIS;d.multiplyVector(d.getRotationMatrix(0,0,1,360*Math.random()),E);}var t=i.add(u,a.getScaleVector(E,v.get_radius()-0.5*H));var A=[];var r=new h();r.r0=i.subtract(t,p.get_oldState().position);r.r1=i.subtract(t,v.get_oldState().position);r.initialPenetration=H;A.push(r);var z=new j();z.objInfo=D;z.dirToBody=E;z.pointInfo=A;var C=new b();C.set_restitution(Math.sqrt(p.get_material().get_restitution()*v.get_material().get_restitution()));C.set_friction(Math.sqrt(p.get_material().get_friction()*v.get_material().get_friction()));z.mat=C;B.push(z);D.body0.collisions.push(z);D.body1.collisions.push(z);}};c.CollDetectSphereCapsule=l;})(jigLib);(function(d){var j=d.Vector3DUtil;var f=d.JConfig;var k=d.JIndexedTriangle;var g=d.JSphere;var e=d.JTriangle;var c=d.JTriangleMesh;var a=d.JNumber3D;var b=d.MaterialProperties;var l=d.RigidBody;var h=d.CollPointInfo;var i=function(){this.name="SphereMesh";this.type0="SPHERE";this.type1="TRIANGLEMESH";};d.extend(i,d.CollDetectFunctor);i.prototype.collDetectSphereStaticMeshOverlap=function(u,o,K,x,G){var L=K.body0.get_oldState().position;var p=K.body1.get_oldState().position;var q=x+u.get_radius();var D=q*q;var H=[0,0,0];var C=[];var y=[];var s=o.get_octree().getTrianglesIntersectingtAABox(y,u.get_boundingBox());var I,r,O,A,N,t=a.NUM_TINY;var m;var w;var n;var F;for(var E=0;E<s;++E){m=o.get_octree().getTriangle(y[E]);r=m.get_plane().pointPlaneDistance(u.get_currentState().position);if(r<=0){continue;}if(r>=q){continue;}w=m.get_vertexIndices();F=new e(o.get_octree().getVertex(w[0]),o.get_octree().getVertex(w[1]),o.get_octree().getVertex(w[2]));n=[];I=F.pointTriangleDistanceSq(n,u.get_currentState().position);if(I<D){O=F.pointTriangleDistanceSq(n,u.get_oldState().position);A=Math.sqrt(O);N=u.get_radius()-A;var M=(A>t)?(j.subtract(u.get_oldState().position,F.getPoint(n[0],n[1]))):F.normal.slice(0);j.normalize(M);var z=j.subtract(u.get_oldState().position,a.getScaleVector(M,u.get_radius()));var v=new h();v.r0=j.subtract(z,L);v.r1=j.subtract(z,p);v.initialPenetration=N;C.push(v);H=j.add(H,M);j.normalize(H);}}var B=new d.CollisionInfo();B.objInfo=K;B.dirToBody=H;B.pointInfo=C;var J=new b();J.set_restitution(0.5*(u.get_material().get_restitution()+o.get_material().get_restitution()));J.set_friction(0.5*(u.get_material().get_friction()+o.get_material().get_friction()));B.mat=J;G.push(B);K.body0.collisions.push(B);K.body1.collisions.push(B);};i.prototype.collDetect=function(p,o){var m;if(p.body0._type=="TRIANGLEMESH"){m=p.body0;p.body0=p.body1;p.body1=m;}var n=p.body0;var q=p.body1;this.collDetectSphereStaticMeshOverlap(n,q,p,f.collToll,o);};d.CollDetectSphereMesh=i;})(jigLib);(function(d){var i=d.Vector3DUtil;var a=d.JNumber3D;var g=d.JConstraint;var e=d.JConfig;var f=d.JSphere;var c=d.MaterialProperties;var k=d.RigidBody;var h=d.CollPointInfo;var j=d.CollisionInfo;var b=function(){this.name="SpherePlane";this.type0="SPHERE";this.type1="PLANE";};d.extend(b,d.CollDetectFunctor);b.prototype.collDetect=function(m,v){var t;if(m.body0.get_type()=="PLANE"){t=m.body0;m.body0=m.body1;m.body1=t;}var q=m.body0;var s=m.body1;var w=s.pointPlaneDistance(q.get_oldState().position);var o=s.pointPlaneDistance(q.get_currentState().position);if(Math.min(o,w)>q.get_boundingSphere()+e.collToll){return;}var p=[];var l;var r=q.get_radius()-w;var n=i.subtract(q.get_oldState().position,a.getScaleVector(s.get_normal(),q.get_radius()));l=new h();l.r0=i.subtract(n,q.get_oldState().position);l.r1=i.subtract(n,s.get_oldState().position);l.initialPenetration=r;p.push(l);var u=new j();u.objInfo=m;u.dirToBody=s.get_normal();u.pointInfo=p;var x=new c();x.set_restitution(Math.sqrt(q.get_material().get_restitution()*s.get_material().get_restitution()));x.set_friction(Math.sqrt(q.get_material().get_friction()*s.get_material().get_friction()));u.mat=x;v.push(u);m.body0.collisions.push(u);m.body1.collisions.push(u);};d.CollDetectSpherePlane=b;})(jigLib);(function(d){var j=d.Vector3DUtil;var e=d.JMatrix3D;var a=d.JNumber3D;var h=d.JConstraint;var f=d.JConfig;var g=d.JSphere;var b=d.MaterialProperties;var i=d.CollPointInfo;var k=d.CollisionInfo;var c=function(){this.name="SphereSphere";this.type0="SPHERE";this.type1="SPHERE";};d.extend(c,d.CollDetectFunctor);c.prototype.collDetect=function(r,x){var m=r.body0;var A=r.body1;var n=j.subtract(m.get_oldState().position,A.get_oldState().position);var p=j.subtract(m.get_currentState().position,A.get_currentState().position);var z=j.get_lengthSquared(n);var o=j.get_lengthSquared(p);var l=m.get_radius()+A.get_radius();if(Math.min(z,o)<Math.pow(l+f.collToll,2)){var w=Math.sqrt(z);var u=l-w;if(w>a.NUM_TINY){n=a.getDivideVector(n,w);}else{n=j.Y_AXIS;e.multiplyVector(e.getRotationMatrix(0,0,1,360*Math.random()),n);}var t=j.add(A.get_oldState().position,a.getScaleVector(n,A.get_radius()-0.5*u));var s=[];var q=new i();q.r0=j.subtract(t,m.get_oldState().position);q.r1=j.subtract(t,A.get_oldState().position);q.initialPenetration=u;s.push(q);var v=new k();v.objInfo=r;v.dirToBody=n;v.pointInfo=s;var y=new b();y.set_restitution(Math.sqrt(m.get_material().get_restitution()*A.get_material().get_restitution()));y.set_friction(Math.sqrt(m.get_material().get_friction()*A.get_material().get_friction()));v.mat=y;x.push(v);r.body0.collisions.push(v);r.body1.collisions.push(v);}};d.CollDetectSphereSphere=c;})(jigLib);(function(c){var i=c.Vector3DUtil;var a=c.JNumber3D;var g=c.JConstraint;var e=c.JConfig;var f=c.JSphere;var d=c.JTerrain;var b=c.MaterialProperties;var j=c.RigidBody;var h=function(){this.name="SphereTerrain";this.type0="SPHERE";this.type1="TERRAIN";};c.extend(h,c.CollDetectFunctor);h.prototype.collDetect=function(n,v){var s;if(n.body0.type=="TERRAIN"){s=n.body0;n.body0=n.body1;n.body1=s;}var p=n.body0;var k=n.body1;var r=k.getHeightAndNormalByPoint(p.currentState.position);if(r.height<e.collToll+p.radius){var u=k.getHeightByPoint(p.oldState.position);var q=p.radius-u;var l=i.subtract(p.oldState.position,a.getScaleVector(r.normal,p.radius));var o=[];var m=new CollPointInfo();m.r0=i.subtract(l,p.oldState.position);m.r1=i.subtract(l,k.oldState.position);m.initialPenetration=q;o.push(m);var t=new CollisionInfo();t.objInfo=n;t.dirToBody=r.normal;t.pointInfo=o;var w=new b();w.restitution=Math.sqrt(p.material.restitution*k.material.restitution);w.friction=Math.sqrt(p.material.friction*k.material.friction);t.mat=w;v.push(t);n.body0.collisions.push(t);n.body1.collisions.push(t);}};c.CollDetectSphereTerrain=h;})(jigLib);(function(p){var l=p.JSegment;var i=p.RigidBody;var g=p.Vector3DUtil;var f=p.JNumber3D;var s=p.JConstraint;var t=p.CollDetectBoxBox;var o=p.CollDetectBoxPlane;var h=p.CollDetectBoxTerrain;var c=p.CollDetectCapsuleBox;var k=p.CollDetectCapsuleCapsule;var e=p.CollDetectCapsulePlane;var d=p.CollDetectCapsuleTerrain;var r=p.CollDetectSphereBox;var b=p.CollDetectSphereCapsule;var n=p.CollDetectSpherePlane;var m=p.CollDetectSphereSphere;var q=p.CollDetectSphereTerrain;var a=p.CollDetectInfo;var j=function(){this.collBody=[];detectionFunctors=[];detectionFunctors["BOX"]=[];detectionFunctors["BOX"]["BOX"]=new t();detectionFunctors["BOX"]["SPHERE"]=new r();detectionFunctors["BOX"]["CAPSULE"]=new c();detectionFunctors["BOX"]["PLANE"]=new o();detectionFunctors["BOX"]["TERRAIN"]=new h();detectionFunctors["SPHERE"]=[];detectionFunctors["SPHERE"]["BOX"]=new r();detectionFunctors["SPHERE"]["SPHERE"]=new m();detectionFunctors["SPHERE"]["CAPSULE"]=new b();detectionFunctors["SPHERE"]["PLANE"]=new n();detectionFunctors["SPHERE"]["TERRAIN"]=new q();detectionFunctors["CAPSULE"]=[];detectionFunctors["CAPSULE"]["CAPSULE"]=new k();detectionFunctors["CAPSULE"]["BOX"]=new c();detectionFunctors["CAPSULE"]["SPHERE"]=new b();detectionFunctors["CAPSULE"]["PLANE"]=new e();detectionFunctors["CAPSULE"]["TERRAIN"]=new d();detectionFunctors["PLANE"]=[];detectionFunctors["PLANE"]["BOX"]=new o();detectionFunctors["PLANE"]["SPHERE"]=new n();detectionFunctors["PLANE"]["CAPSULE"]=new e();detectionFunctors["TERRAIN"]=[];detectionFunctors["TERRAIN"]["SPHERE"]=new q();detectionFunctors["TERRAIN"]["BOX"]=new h();detectionFunctors["TERRAIN"]["CAPSULE"]=new d();this.detectionFunctors=detectionFunctors;};j.prototype.detectionFunctors=null;j.prototype.collBody=null;j.prototype.addCollisionBody=function(u){if(!this.findBody(u)){this.collBody.push(u);}};j.prototype.removeCollisionBody=function(u){if(this.findBody(u)){this.collBody.splice(this.collBody.indexOf(u),1);}};j.prototype.removeAllCollisionBodies=function(){this.collBody=[];};j.prototype.detectCollisions=function(u,x){if(!u.isActive){return;}var y;var z;for(var w=0,A=this.collBody.length;w<A;w++){var v=this.collBody[w];if(u!=v&&this.checkCollidables(u,v)&&this.detectionFunctors[u.get_type()][v.get_type()]!=undefined){y=new a();y.body0=u;y.body1=v;z=detectionFunctors[y.body0.get_type()][y.body1.get_type()];z.collDetect(y,x);}}};j.prototype.detectAllCollisions=function(u,D){var x;var B;var z;var E;for(var C=0,w=u.length;C<w;C++){var y=u[C];z=y.id;E=y.get_type();for(var A=0;A<this.collBody.length;A++){var v=this.collBody[A];if(y==v){continue;}if(v.isActive&&z>v.id){continue;}if(this.checkCollidables(y,v)&&this.detectionFunctors[E][v.get_type()]!=undefined){x=new a();x.body0=y;x.body1=v;B=detectionFunctors[x.body0.get_type()][x.body1.get_type()];B.collDetect(x,D);}}}};j.prototype.segmentIntersect=function(x,u,w){x.fracOut=f.NUM_HUGE;x.posOut=[0,0,0,0];x.normalOut=[0,0,0,0];var z={};for(var y=0,A=this.collBody.length;y<A;y++){var v=this.collBody[y];if(v!=w&&this.segmentBounding(u,v)){if(v.segmentIntersect(z,u,v.get_currentState())){if(z.fracOut<x.fracOut){x.posOut=z.posOut;x.normalOut=z.normalOut;x.fracOut=z.fracOut;x.bodyOut=v;}}}}if(x.fracOut>1){return false;}if(x.fracOut<0){x.fracOut=0;}else{if(x.fracOut>1){x.fracOut=1;}}return true;};j.prototype.segmentBounding=function(u,y){var z=u.getPoint(0.5);var v=g.get_length(u.delta)/2;if(y.get_type()!="PLANE"&&y.get_type()!="TERRAIN"){var x=g.get_length(g.subtract(z,y.get_currentState().position));var w=v+y.get_boundingSphere();if(x<=w){return true;}else{return false;}}else{return true;}};j.prototype.findBody=function(u){for(var w=0,x=this.collBody.length;w<x;w++){var v=this.collBody[w];if(u==v){return true;}}return false;};j.prototype.checkCollidables=function(y,w){if(y.get_nonCollidables().length==0&&w.get_nonCollidables().length==0){return true;}var v=y.get_nonCollidables();for(var x=0,u=v.length;x<u;x++){var A=v[x];if(w==A){return false;}}v=w.get_nonCollidables();for(var x=0,u=v.length;x<u;x++){var z=v[x];if(y==z){return false;}}return true;};p.CollisionSystem=j;})(jigLib);(function(b){var d=b.Vector3DUtil;var a=b.CollOutBodyData;var h=b.JSegment;var c=b.JNumber3D;var f=b.RigidBody;var g=b.CollDetectInfo;var e=function(){this.collBody=[];this.detectionFunctors={};this.detectionFunctors["BOX_BOX"]=new b.CollDetectBoxBox();this.detectionFunctors["BOX_SPHERE"]=new b.CollDetectSphereBox();this.detectionFunctors["BOX_CAPSULE"]=new b.CollDetectCapsuleBox();this.detectionFunctors["BOX_PLANE"]=new b.CollDetectBoxPlane();this.detectionFunctors["BOX_TERRAIN"]=new b.CollDetectBoxTerrain();this.detectionFunctors["BOX_TRIANGLEMESH"]=new b.CollDetectBoxMesh();this.detectionFunctors["SPHERE_BOX"]=new b.CollDetectSphereBox();this.detectionFunctors["SPHERE_SPHERE"]=new b.CollDetectSphereSphere();this.detectionFunctors["SPHERE_CAPSULE"]=new b.CollDetectSphereCapsule();this.detectionFunctors["SPHERE_PLANE"]=new b.CollDetectSpherePlane();this.detectionFunctors["SPHERE_TERRAIN"]=new b.CollDetectSphereTerrain();this.detectionFunctors["SPHERE_TRIANGLEMESH"]=new b.CollDetectSphereMesh();this.detectionFunctors["CAPSULE_CAPSULE"]=new b.CollDetectCapsuleCapsule();this.detectionFunctors["CAPSULE_BOX"]=new b.CollDetectCapsuleBox();this.detectionFunctors["CAPSULE_SPHERE"]=new b.CollDetectSphereCapsule();this.detectionFunctors["CAPSULE_PLANE"]=new b.CollDetectCapsulePlane();this.detectionFunctors["CAPSULE_TERRAIN"]=new b.CollDetectCapsuleTerrain();this.detectionFunctors["PLANE_BOX"]=new b.CollDetectBoxPlane();this.detectionFunctors["PLANE_SPHERE"]=new b.CollDetectSpherePlane();this.detectionFunctors["PLANE_CAPSULE"]=new b.CollDetectCapsulePlane();this.detectionFunctors["TERRAIN_SPHERE"]=new b.CollDetectSphereTerrain();this.detectionFunctors["TERRAIN_BOX"]=new b.CollDetectBoxTerrain();this.detectionFunctors["TERRAIN_CAPSULE"]=new b.CollDetectCapsuleTerrain();this.detectionFunctors["TRIANGLEMESH_SPHERE"]=new b.CollDetectSphereMesh();this.detectionFunctors["TRIANGLEMESH_BOX"]=new b.CollDetectBoxMesh();};e.prototype.detectionFunctors={};e.prototype.collBody=null;e.prototype._numCollisionsChecks=0;e.prototype.addCollisionBody=function(i){if(!this.findBody(i)){this.collBody.push(i);}};e.prototype.removeCollisionBody=function(i){if(this.findBody(i)){this.collBody.splice(this.collBody.indexOf(i),1);}};e.prototype.removeAllCollisionBodies=function(){this.collBody=[];};e.prototype.detectCollisions=function(i,m){if(!i.isActive){return;}var n;var o;for(var l=0;l<this.collBody.length;l++){var k=this.collBody[l];if(i==k){continue;}if(this.checkCollidables(i,k)&&this.detectionFunctors[i.get_type()+"_"+k.get_type()]!=undefined){n=new g();n.body0=i;n.body1=k;o=this.detectionFunctors[n.body0.get_type()+"_"+n.body1.get_type()];o.collDetect(n,m);}}};e.prototype.detectAllCollisions=function(i,k){};e.prototype.collisionSkinMoved=function(i){};e.prototype.segmentIntersect=function(m,i,l){m.frac=c.NUM_HUGE;m.position=[];m.normal=[];var n=new a();for(j=0;j<this.collBody.length;j++){var k=this.collBody[j];if(k!=l&&this.segmentBounding(i,k)){if(k.segmentIntersect(n,i,k.get_currentState())){if(n.frac<m.frac){m.position=n.position;m.normal=n.normal;m.frac=n.frac;m.rigidBody=k;}}}}if(m.frac>1){return false;}if(m.frac<0){m.frac=0;}else{if(m.frac>1){m.frac=1;}}return true;};e.prototype.segmentBounding=function(i,n){var o=i.getPoint(0.5);var k=d.get_length(i.delta)/2;var m=d.get_length(d.subtract(o,n.get_currentState().position));var l=k+n.boundingSphere;if(m<=l){return true;}else{return false;}};e.prototype.get_numCollisionsChecks=function(){return this._numCollisionsChecks;};e.prototype.findBody=function(i){return this.collBody.indexOf(i)>-1;};e.prototype.checkCollidables=function(k,i){if(k.get_nonCollidables().length==0&&i.get_nonCollidables().length==0){return true;}if(k.nonCollidables.indexOf(i)>-1){return false;}if(i.nonCollidables.indexOf(k)>-1){return false;}return true;};b.CollisionSystemAbstract=e;})(jigLib);(function(a){var c=a.Vector3DUtil;var d=a.RigidBody;var e=a.CollDetectInfo;var b=function(){this.Super();};a.extend(b,a.CollisionSystemAbstract);b.prototype.detectAllCollisions=function(g,l){var m;var o;var i;var h;this._numCollisionsChecks=0;for(j=0;j<g.length;j++){var n=g[j];if(!n.isActive){continue;}i=n.id;h=n.get_type();for(k=0;k<this.collBody.length;k++){var f=this.collBody[k];if(n==f){continue;}if(f&&f.isActive&&i>f.id){continue;}if(this.checkCollidables(n,f)&&this.detectionFunctors[h+"_"+f.get_type()]!=undefined){m=new e();m.body0=n;m.body1=f;o=this.detectionFunctors[m.body0.get_type()+"_"+m.body1.get_type()];o.collDetect(m,l);this._numCollisionsChecks+=1;}}}};a.CollisionSystemBrute=b;})(jigLib);(function(c){var g=c.Vector3DUtil;var e=c.CollOutBodyData;var f=c.JAABox;var h=c.JSegment;var i=c.JMath3D;var a=c.JNumber3D;var j=c.RigidBody;var b=c.CollisionSystemGridEntry;var d=c.CollDetectInfo;var k=function(t,s,r,p,o,n,w,v,u){this.Super();if(t==undefined){t=0;}if(s==undefined){s=0;}if(r==undefined){r=0;}if(p==undefined){p=20;}if(o==undefined){o=20;}if(n==undefined){n=20;}if(w==undefined){w=200;}if(v==undefined){v=200;}if(u==undefined){u=200;}this.nx=p;this.ny=o;this.nz=n;this.dx=w;this.dy=v;this.dz=u;this.sizeX=p*w;this.sizeY=o*v;this.sizeZ=n*u;this.minDelta=Math.min(w,v,u);this.startpoint=[t,s,r];this.gridEntries=[];var q=this.gridEntries.length;for(var m=0;m<q;++m){var l=new b(null);l.gridIndex=m;this.gridEntries[m]=l;}this.overflowEntries=new b(null);this.overflowEntries.gridIndex=-1;};c.extend(k,c.CollisionSystemAbstract);k.prototype.gridEntries=null;k.prototype.overflowEntries=null;k.prototype.nx=0;k.prototype.ny=0;k.prototype.nz=0;k.prototype.dx=0;k.prototype.dy=0;k.prototype.dz=0;k.prototype.sizeX=0;k.prototype.sizeY=0;k.prototype.sizeZ=0;k.prototype.minDelta=0;k.prototype.calcIndex=function(n,m,l){var q=n%this.nx;var p=m%this.ny;var o=l%this.nz;return(q+this.nx*p+(this.nx+this.ny)*o);};k.prototype.calcGridForSkin3=function(m){var p;var n;var l;var q=m.get_boundingBox().get_sideLengths();if((q[0]>this.dx)||(q[1]>this.dy)||(q[2]>this.dz)){p=n=l=-1;return[p,n,l];}var o=m.get_boundingBox().get_minPos();o[0]=i.wrap(o[0],this.startpoint[0],this.startpoint[0]+this.sizeX);o[1]=i.wrap(o[1],this.startpoint[1],this.startpoint[1]+this.sizeY);o[2]=i.wrap(o[2],this.startpoint[2],this.startpoint[2]+this.sizeZ);p=(((o[0]-this.startpoint[0])/this.dx)%this.nx)|0;n=(((o[1]-this.startpoint[1])/this.dy)%this.ny)|0;l=(((o[2]-this.startpoint[2])/this.dz)%this.nz)|0;return[p,n,l];};k.prototype.calcGridForSkin6=function(m){var r={};var q;var p;var n;var u;var t;var s;var l=m.get_boundingBox().get_sideLengths();if((l[0]>this.dx)||(l[1]>this.dy)||(l[2]>this.dz)){q=p=n=-1;u=t=s=0;r.i=q;r.j=p;r.k=n;r.fi=u;r.fj=t;r.fk=s;return r;}var o=m.get_boundingBox().get_minPos();o[0]=i.getLimiteNumber(o[0],this.startpoint[0],this.startpoint[0]+this.sizeX);o[1]=i.getLimiteNumber(o[1],this.startpoint[1],this.startpoint[1]+this.sizeY);o[2]=i.getLimiteNumber(o[2],this.startpoint[2],this.startpoint[2]+this.sizeZ);u=(o[0]-this.startpoint[0])/this.dx;t=(o[1]-this.startpoint[1])/this.dy;s=(o[2]-this.startpoint[2])/this.dz;q=u;p=t;n=s;if(q<0){q=0;u=0;}else{if(q>=this.nx){q=0;u=0;}else{u-=q;}}if(p<0){p=0;t=0;}else{if(p>=this.ny){p=0;t=0;}else{t-=p;}}if(n<0){n=0;s=0;}else{if(n>=this.nz){n=0;s=0;}else{s-=n;}}r.i=q;r.j=p;r.k=n;r.fi=u;r.fj=t;r.fk=s;return r;};k.prototype.calcGridIndexForBody=function(m){var l=this.calcGridForSkin3(m);if(l.x==-1){return -1;}return this.calcIndex(l[0],l[1],l[2]);};k.prototype.addCollisionBody=function(l){if(!this.findBody(l)){this.collBody.push(l);}l.collisionSystem=this;var m=new b(l);l.externalData=m;b.insertGridEntryAfter(m,this.overflowEntries);this.collisionSkinMoved(l);};k.prototype.removeCollisionBody=function(l){if(l.externalData!=null){l.externalData.collisionBody=null;b.removeGridEntry(l.externalData);l.externalData=null;}if(this.findBody(l)){this.collBody.splice(this.collBody.indexOf(l),1);}};k.prototype.removeAllCollisionBodies=function(){for(var m=0;m<this.collBody.length;m++){var l=this.collBody[m];if(l.externalData!=null){l.externalData.collisionBody=null;b.removeGridEntry(l.externalData);}}collBody=[];};k.prototype.collisionSkinMoved=function(l){var o=l.externalData;if(o==null){return;}var n=this.calcGridIndexForBody(l);if(n==o.gridIndex){return;}var p;var m=this.gridEntries;if(m.length-1>n&&n>=0){p=m[n];}else{p=this.overflowEntries;}b.removeGridEntry(o);b.insertGridEntryAfter(o,p);};k.prototype.getListsToCheck=function(l){var u=[];var m=l.externalData;if(m==null){return null;}var z;var x;var w;var t;var s;var r;var C=this.calcGridForSkin6(l);z=C.i;x=C.j;w=C.k;t=C.fi;s=C.fj;r=C.fk;if(z==-1){u=this.gridEntries.concat();u.push(this.overflowEntries);return u;}u.push(this.overflowEntries);var D=l.get_boundingBox().get_sideLengths();var p=1,o=1,n=1;if(t+(D[0]/this.dx)<1){p=0;}if(s+(D[1]/this.dy)<1){o=0;}if(r+(D[2]/this.dz)<1){n=0;}for(var B=-1;B<=p;++B){for(var A=-1;A<=o;++A){for(var y=-1;y<=n;++y){var v=this.calcIndex(this.nx+z+B,this.ny+x+A,this.nz+w+y);if(this.gridEntries.length-1>v&&v>=0){var q=this.gridEntries[v];if(q!=null&&q.next!=null){u.push(q);}}}}}return u;};k.prototype.detectAllCollisions=function(l,s){var m;var q;var n;var t;this._numCollisionsChecks=0;for(var p=0;p<l.length;p++){var r=l[p];if(!r.isActive){continue;}n=r.id;t=r.get_type();var v=this.getListsToCheck(r);for(var o=0;o<v.length;o++){var u=v[o];for(u=u.next;u!=null;u=u.next){if(r==u.collisionBody){continue;}if(u.collisionBody&&u.collisionBody.isActive&&n>u.collisionBody.id){continue;}if(this.checkCollidables(r,u.collisionBody)&&this.detectionFunctors[t+"_"+u.collisionBody.get_type()]!=undefined){m=new d();m.body0=r;m.body1=u.collisionBody;q=this.detectionFunctors[m.body0.get_type()+"_"+m.body1.get_type()];q.collDetect(m,s);this._numCollisionsChecks+=1;}}}}};c.CollisionSystemGrid=k;})(jigLib);(function(a){var b=function(){this._constraintEnabled=false;this.enableConstraint();};b.prototype._satisfied=null;b.prototype._constraintEnabled=null;b.prototype.set_satisfied=function(c){this._satisfied=c;};b.prototype.get_satisfied=function(){return this._satisfied;};b.prototype.preApply=function(c){this._satisfied=false;};b.prototype.apply=function(c){return false;};b.prototype.enableConstraint=function(){if(this._constraintEnabled){return;}this._constraintEnabled=true;a.PhysicsSystem.getInstance().addConstraint(this);};b.prototype.disableConstraint=function(){if(!this._constraintEnabled){return;}this._constraintEnabled=false;a.PhysicsSystem.getInstance().removeConstraint(this);};b.prototype.get_constraintEnabled=function(){return this._constraintEnabled;};a.JConstraint=b;})(jigLib);(function(b){var e=b.Vector3DUtil;var a=b.JMatrix3D;var c=b.JNumber3D;var d=function(h,i,f,g,j){if(!j){j=1;}this.Super();this._body0=h;this._body0Pos=i;this._body1=f;this._body1Pos=g;this._maxDistance=j;h.addConstraint(this);f.addConstraint(this);};b.extend(d,b.JConstraint);d.prototype._maxVelMag=20;d.prototype._minVelForProcessing=0.01;d.prototype._body0=null;d.prototype._body1=null;d.prototype._body0Pos=null;d.prototype._body1Pos=null;d.prototype._maxDistance=null;d.prototype.r0=null;d.prototype.r1=null;d.prototype._worldPos=null;d.prototype._currentRelPos0=null;d.prototype.preApply=function(h){this.set_satisfied(false);this.r0=this._body0Pos.slice(0);this.r1=this._body1Pos.slice(0);a.multiplyVector(this._body0.get_currentState().get_orientation(),this.r0);a.multiplyVector(this._body1.get_currentState().get_orientation(),this.r1);var g=e.add(this._body0.get_currentState().position,this.r0);var f=e.add(this._body1.get_currentState().position,this.r1);this._worldPos=c.getScaleVector(e.add(g,f),0.5);this._currentRelPos0=e.subtract(g,f);};d.prototype.apply=function(g){this.set_satisfied(true);if(!this._body0.isActive&&!this._body1.isActive){return false;}var l=this._body0.getVelocity(this.r0);var k=this._body1.getVelocity(this.r1);var n=e.add(this._currentRelPos0,c.getScaleVector(e.subtract(l,k),g));var m=n.slice(0);var s=e.get_length(m);if(s<=c.NUM_TINY){return false;}if(s>this._maxDistance){m=c.getScaleVector(m,this._maxDistance/s);}var q=c.getDivideVector(e.subtract(m,this._currentRelPos0),g);var f=e.subtract(e.subtract(l,k),q);var j=e.get_length(f);if(j>this._maxVelMag){f=c.getScaleVector(f,this._maxVelMag/j);j=this._maxVelMag;}else{if(j<this._minVelForProcessing){return false;}}var p=c.getDivideVector(f,j);var r=e.crossProduct(this.r0,p);a.multiplyVector(this._body0.get_worldInvInertia(),r);var o=e.crossProduct(this.r1,p);a.multiplyVector(this._body1.get_worldInvInertia(),o);var i=this._body0.get_invMass()+this._body1.get_invMass()+e.dotProduct(p,e.crossProduct(r,this.r0))+e.dotProduct(p,e.crossProduct(o,this.r1));if(i<c.NUM_TINY){return false;}var h=c.getScaleVector(p,-j/i);this._body0.applyWorldImpulse(h,this._worldPos);this._body1.applyWorldImpulse(c.getScaleVector(h,-1),this._worldPos);this._body0.setConstraintsAndCollisionsUnsatisfied();this._body1.setConstraintsAndCollisionsUnsatisfied();this.set_satisfied(true);return true;};b.JConstraintMaxDistance=d;})(jigLib);(function(c){var e=c.Vector3DUtil;var b=c.JMatrix3D;var d=c.JNumber3D;var a=function(i,k,g,h,j,f){this.Super();this._body0=i;this._body0Pos=k;this._body1=g;this._body1Pos=h;this._allowedDistance=(j)?j:1;this._timescale=(f)?f:1;if(this._timescale<d.NUM_TINY){_timescale=d.NUM_TINY;}i.addConstraint(this);g.addConstraint(this);};c.extend(a,c.JConstraint);a.prototype._maxVelMag=20;a.prototype._minVelForProcessing=0.01;a.prototype._body0=null;a.prototype._body1=null;a.prototype._body0Pos=null;a.prototype._body1Pos=null;a.prototype._timescale=null;a.prototype._allowedDistance=null;a.prototype.r0=null;a.prototype.r1=null;a.prototype._worldPos=null;a.prototype._vrExtra=null;a.prototype.preApply=function(j){this.set_satisfied(false);this.r0=this._body0Pos.slice(0);b.multiplyVector(this._body0.get_currentState().get_orientation(),this.r0);this.r1=this._body1Pos.slice(0);b.multiplyVector(this._body1.get_currentState().get_orientation(),this.r1);var g=e.add(this._body0.get_currentState().position,this.r0);var f=e.add(this._body1.get_currentState().position,this.r1);this._worldPos=d.getScaleVector(e.add(g,f),0.5);var i=e.subtract(g,f);var h=e.get_length(i);if(h>this._allowedDistance){this._vrExtra=d.getScaleVector(i,(h-this._allowedDistance)/(h*Math.max(this._timescale,j)));}else{this._vrExtra=[0,0,0,0];}};a.prototype.apply=function(h){this.set_satisfied(true);if(!this._body0.isActive&&!this._body1.isActive){return false;}var m=this._body0.getVelocity(this.r0);var l=this._body1.getVelocity(this.r1);var f=e.add(this._vrExtra,e.subtract(m,l));var k=e.get_length(f);if(k<this._minVelForProcessing){return false;}if(k>this._maxVelMag){f=d.getScaleVector(f,this._maxVelMag/k);k=this._maxVelMag;}var n=d.getDivideVector(f,k);var p=e.crossProduct(this.r0,n);b.multiplyVector(this._body0.get_worldInvInertia(),p);var o=e.crossProduct(this.r1,n);b.multiplyVector(this._body1.get_worldInvInertia(),o);var j=this._body0.get_invMass()+this._body1.get_invMass()+e.dotProduct(n,e.crossProduct(p,this.r0))+e.dotProduct(n,e.crossProduct(o,this.r1));if(j<d.NUM_TINY){return false;}var i=d.getScaleVector(n,-k/j);var g=d.getScaleVector(i,-1);this._body0.applyWorldImpulse(i,this._worldPos);this._body1.applyWorldImpulse(g,this._worldPos);this._body0.setConstraintsAndCollisionsUnsatisfied();this._body1.setConstraintsAndCollisionsUnsatisfied();this.set_satisfied(true);return true;};c.JConstraintPoint=a;})(jigLib);(function(c){var e=c.Vector3DUtil;var b=c.JMatrix3D;var d=c.JNumber3D;var a=function(f,g,h){this.Super();this._body=f;this._pointOnBody=g;this._worldPosition=h;f.addConstraint(this);};c.extend(a,c.JConstraint);a.prototype.minVelForProcessing=0.001;a.prototype.allowedDeviation=0.01;a.prototype.timescale=4;a.prototype._body=null;a.prototype._pointOnBody=null;a.prototype._worldPosition=null;a.prototype.set_worldPosition=function(f){this._worldPosition=f;};a.prototype.get_worldPosition=function(){return this._worldPosition;};a.prototype.apply=function(f){this.set_satisfied(true);var k=this._pointOnBody.slice(0);b.multiplyVector(this._body.get_currentState().get_orientation(),k);k=e.add(k,this._body.get_currentState().position);var m=e.subtract(k,this._body.get_currentState().position);var q=e.add(this._body.get_currentState().linVelocity,e.crossProduct(this._body.get_currentState().rotVelocity,m));var g;var p;var j=e.subtract(k,this._worldPosition);var r=e.get_length(j);if(r>this.allowedDeviation){p=d.getDivideVector(j,r);g=d.getScaleVector(p,(this.allowedDeviation-r)/(this.timescale*f));}else{g=[0,0,0,0];}var o=e.subtract(q,g);var l=e.get_length(o);if(l<this.minVelForProcessing){return false;}o=d.getDivideVector(o,l);var n=e.crossProduct(m,o);b.multiplyVector(this._body.get_worldInvInertia(),n);var i=this._body.get_invMass()+e.dotProduct(o,e.crossProduct(n,m));if(i<d.NUM_TINY){return false;}var h=-l/i;this._body.applyWorldImpulse(d.getScaleVector(o,h),k);this._body.setConstraintsAndCollisionsUnsatisfied();this.set_satisfied(true);return true;};c.JConstraintWorldPoint=a;})(jigLib);(function(c){var f=c.Vector3DUtil;var b=c.JMatrix3D;var d=c.JNumber3D;var e=c.JConstraintMaxDistance;var a=c.JConstraintPoint;var g=function(u,r,x,C,l,o,i,I,k){this._body0=u;this._body1=r;this._hingeAxis=x.slice(0);this._hingePosRel0=C.slice(0);this._usingLimit=false;this._hingeEnabled=false;this._broken=false;this._damping=k;this._extraTorque=0;f.normalize(this._hingeAxis);var j=f.add(this._body0.get_currentState().position,f.subtract(this._hingePosRel0,this._body1.get_currentState().position));var q=f.add(this._hingePosRel0,d.getScaleVector(this._hingeAxis,l));var p=f.subtract(this._hingePosRel0,d.getScaleVector(this._hingeAxis,l));var F=f.add(j,d.getScaleVector(this._hingeAxis,l));var D=f.subtract(j,d.getScaleVector(this._hingeAxis,l));var t=1/20;var A=0.005;var m=I*l;this.sidePointConstraints=[];this.sidePointConstraints[0]=new e(this._body0,q,this._body1,F,m);this.sidePointConstraints[1]=new e(this._body0,p,this._body1,D,m);this.midPointConstraint=new a(this._body0,this._hingePosRel0,this._body1,j,A,t);if(o<=this.MAX_HINGE_ANGLE_LIMIT){var h=f.Y_AXIS;if(f.dotProduct(h,this._hingeAxis)>0.1){h[0]=1;h[1]=0;h[2]=0;}var w=f.crossProduct(this._hingeAxis,h);h=f.crossProduct(w,this._hingeAxis);f.normalize(h);var E=10*l;var B=d.getScaleVector(h,E);var H=0.5*(o-i);var z=B.slice(0);b.multiplyVector(b.getRotationMatrix(this._hingeAxis[0],this._hingeAxis[1],this._hingeAxis[2],-H),z);var v=0.5*(o+i);var s=E*2*Math.sin(0.5*v*Math.PI/180);var G=f.add(this._body1.get_currentState().position,this._hingePosRel0);var n=f.add(G,f.subtract(B,this._body0.get_currentState().position));var y=f.add(G,f.subtract(z,this._body1.get_currentState().position));this.maxDistanceConstraint=new e(this._body0,n,this._body1,y,s);this._usingLimit=true;}if(this._damping<=0){this._damping=-1;}else{this._damping=d.getLimiteNumber(this._damping,0,1);}this.enableHinge();};c.extend(g,c.PhysicsController);g.prototype.MAX_HINGE_ANGLE_LIMIT=150;g.prototype._hingeAxis=null;g.prototype._hingePosRel0=null;g.prototype._body0=null;g.prototype._body1=null;g.prototype._usingLimit=null;g.prototype._hingeEnabled=null;g.prototype._broken=null;g.prototype._damping=null;g.prototype._extraTorque=null;g.prototype.sidePointConstraints=null;g.prototype.midPointConstraint=null;g.prototype.maxDistanceConstraint=null;g.prototype.enableHinge=function(){if(this._hingeEnabled){return;}this.midPointConstraint.enableConstraint();this.sidePointConstraints[0].enableConstraint();this.sidePointConstraints[1].enableConstraint();if(this._usingLimit&&!this._broken){this.maxDistanceConstraint.enableConstraint();}this.enableController();this._hingeEnabled=true;};g.prototype.disableHinge=function(){if(!this._hingeEnabled){return;}this.midPointConstraint.disableConstraint();this.sidePointConstraints[0].disableConstraint();this.sidePointConstraints[1].disableConstraint();if(this._usingLimit&&!this._broken){this.maxDistanceConstraint.disableConstraint();}this.disableController();this._hingeEnabled=false;};g.prototype.breakHinge=function(){if(this._broken){return;}if(this._usingLimit){this.maxDistanceConstraint.disableConstraint();}this._broken=true;};g.prototype.mendHinge=function(){if(!this._broken){return;}if(this._usingLimit){this.maxDistanceConstraint.enableConstraint();}this._broken=false;};g.prototype.setExtraTorque=function(h){this._extraTorque=h;};g.prototype.getHingeEnabled=function(){return this._hingeEnabled;};g.prototype.isBroken=function(){return this._broken;};g.prototype.getHingePosRel0=function(){return this._hingePosRel0;};g.prototype.updateController=function(i){if(this._damping>0){var j=f.subtract(this._body1.get_currentState().rotVelocity,this._body0.get_currentState().rotVelocity);f.normalize(j);var o=f.dotProduct(this._body0.get_currentState().rotVelocity,j);var n=f.dotProduct(this._body1.get_currentState().rotVelocity,j);var l=0.5*(o+n);var h=1-this._damping;var q=l+(o-l)*h;var p=l+(n-l)*h;var m=f.add(this._body0.get_currentState().rotVelocity,d.getScaleVector(j,q-o));var k=f.add(this._body1.get_currentState().rotVelocity,d.getScaleVector(j,p-n));this._body0.setAngVel(m);this._body1.setAngVel(k);}if(this._extraTorque!=0){var r=this._hingeAxis.slice(0);b.multiplyVector(this._body0.get_currentState().get_orientation(),r);r=d.getScaleVector(r,this._extraTorque);this._body0.addWorldTorque(r);this._body1.addWorldTorque(d.getScaleVector(r,-1));}};c.HingeJoint=g;})(jigLib);(function(d){var k=d.Vector3DUtil;var i=d.JConfig;var j=d.CollPointInfo;var e=d.CollisionSystemBrute;var l=d.CollisionSystemGrid;var h=d.ContactData;var f=d.JMatrix3D;var b=d.JNumber3D;var c=d.BodyPair;var a=d.CachedImpulse;var g=function(){this.setSolverType(i.solverType);this._doingIntegration=false;this._bodies=[];this._collisions=[];this._effects=[];this._activeBodies=[];this._constraints=[];this._controllers=[];this._cachedContacts=[];this._collisionSystem=new e();this.setGravity(b.getScaleVector(k.Y_AXIS,-10));};g.prototype._currentPhysicsSystem=null;g.prototype._maxVelMag=0.5;g.prototype._minVelForProcessing=0.001;g.prototype._bodies=null;g.prototype._activeBodies=null;g.prototype._collisions=null;g.prototype._constraints=null;g.prototype._controllers=null;g.prototype._effects=null;g.prototype._gravityAxis=null;g.prototype._gravity=null;g.prototype._doingIntegration=null;g.prototype.preProcessCollisionFn=function(){};g.prototype.preProcessContactFn=function(){};g.prototype.processCollisionFn=function(){};g.prototype.processContactFn=function(){};g.prototype._cachedContacts=null;g.prototype._collisionSystem=null;g.getInstance=function(){if(!g._currentPhysicsSystem){g._currentPhysicsSystem=new g();}return g._currentPhysicsSystem;};g.prototype.getAllExternalForces=function(o){for(var n=0,p=this._bodies.length;n<p;n++){this._bodies[n].addExternalForces(o);}for(var n=0,m=this._controllers.length;n<m;n++){this._controllers[n].updateController(o);}};g.prototype.setCollisionSystem=function(p,s,r,q,o,n,m,v,u,t){if(s==undefined){s=0;}if(r==undefined){r=0;}if(q==undefined){q=0;}if(o==undefined){o=20;}if(n==undefined){n=20;}if(m==undefined){m=20;}if(v==undefined){v=200;}if(u==undefined){u=200;}if(t==undefined){t=200;}if(p){this._collisionSystem=new l(s,r,q,o,n,m,v,u,t);}else{this._collisionSystem=new e();}};g.prototype.getCollisionSystem=function(){return this._collisionSystem;};g.prototype.setGravity=function(m){this._gravity=m;if(this._gravity[0]==this._gravity[1]&&this._gravity[1]==this._gravity[2]){this._gravityAxis=-1;}this._gravityAxis=0;if(Math.abs(this._gravity[1])>Math.abs(this._gravity[2])){this._gravityAxis=1;}if(Math.abs(this._gravity[2])>Math.abs(this._gravity[this._gravityAxis])){this._gravityAxis=2;}};g.prototype.get_gravity=function(){return this._gravity;};g.prototype.get_gravityAxis=function(){return this._gravityAxis;};g.prototype.get_bodies=function(){return this._bodies;};g.prototype.addBody=function(m){if(!this.findBody(m)){this._bodies.push(m);this._collisionSystem.addCollisionBody(m);}};g.prototype.removeBody=function(m){if(this.findBody(m)){this._bodies.splice(this._bodies.indexOf(m),1);this._collisionSystem.removeCollisionBody(m);}};g.prototype.removeAllBodies=function(){this._bodies=[];this._collisionSystem.removeAllCollisionBodies();};g.prototype.addConstraint=function(m){if(!this.findConstraint(m)){this._constraints.push(m);}};g.prototype.removeConstraint=function(m){if(this.findConstraint(m)){this._constraints.splice(this._constraints.indexOf(m),1);}};g.prototype.removeAllConstraints=function(){this._constraints=[];};g.prototype.addEffect=function(m){if(!this.findEffect(m)){this._effects.push(m);}};g.prototype.removeEffect=function(m){if(this.findEffect(m)){this._effects.splice(this._effects.indexOf(m),1);}};g.prototype.removeAllEffects=function(){this._effects=[];};g.prototype.addController=function(m){if(!this.findController(m)){this._controllers.push(m);}};g.prototype.removeController=function(m){if(this.findController(m)){this._controllers.splice(this._controllers.indexOf(m),1);}};g.prototype.removeAllControllers=function(){this._controllers=[];};g.prototype.setSolverType=function(m){switch(m){case"FAST":this.preProcessCollisionFn=this.preProcessCollisionFast;this.preProcessContactFn=this.preProcessCollisionFast;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollision;return;case"NORMAL":this.preProcessCollisionFn=this.preProcessCollisionNormal;this.preProcessContactFn=this.preProcessCollisionNormal;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollision;return;case"ACCUMULATED":this.preProcessCollisionFn=this.preProcessCollisionAccumulated;this.preProcessContactFn=this.preProcessCollisionAccumulated;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollisionAccumulated;return;default:this.preProcessCollisionFn=this.preProcessCollisionNormal;this.preProcessContactFn=this.preProcessCollisionNormal;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollision;return;}};g.prototype.findBody=function(m){var n=this._bodies.length-1;if(n>0){do{if(m==this._bodies[n]){return true;}}while(n--);}return false;};g.prototype.findConstraint=function(n){var m=this._constraints.length-1;if(m>0){do{if(n==this._constraints[m]){return true;}}while(m--);}return false;};g.prototype.findEffect=function(n){var m=this._effects.length-1;if(m>0){do{if(n==this._effects[m]){return true;}}while(m--);}return false;};g.prototype.findController=function(m){var n=this._controllers.length-1;if(n>0){do{if(m==this._controllers[n]){return true;}}while(n--);}return false;};g.prototype.preProcessCollisionFast=function(y,o){y.satisfied=false;var n=y.objInfo.body0;var m=y.objInfo.body1;var t=y.dirToBody;var A=i.numPenetrationRelaxationTimesteps*o;var x=0;var z;var r;var q=y.pointInfo.length;var s=b.NUM_TINY;if(q>1){var w=[0,0,0,0];var u=[0,0,0,0];var C=0;for(var p=0;p<q;p++){z=y.pointInfo[p];w=k.add(w,z.r0);u=k.add(u,z.r1);C+=z.initialPenetration;}w=b.getDivideVector(w,q);u=b.getDivideVector(u,q);C/=q;var B=new j();B.r0=w;B.r1=u;B.initialPenetration=C;y.pointInfo=[B];}z=y.pointInfo[0];if(!n.get_movable()){z.denominator=0;}else{r=k.crossProduct(z.r0,t);f.multiplyVector(n.get_worldInvInertia(),r);z.denominator=n.get_invMass()+k.dotProduct(t,k.crossProduct(r,z.r0));}if(m.get_movable()){r=k.crossProduct(z.r1,t);f.multiplyVector(m.get_worldInvInertia(),r);z.denominator+=(m.get_invMass()+k.dotProduct(t,k.crossProduct(r,z.r1)));}if(z.denominator<s){z.denominator=s;}if(z.initialPenetration>i.allowedPenetration){z.minSeparationVel=(z.initialPenetration-i.allowedPenetration)/A;}else{x=-0.1*(z.initialPenetration-i.allowedPenetration)/i.allowedPenetration;if(x<s){x=s;}else{if(x>1){x=1;}}var v=(o>s)?o:s;z.minSeparationVel=x*(z.initialPenetration-i.allowedPenetration)/v;}if(z.minSeparationVel>this._maxVelMag){z.minSeparationVel=this._maxVelMag;}};g.prototype.preProcessCollisionNormal=function(v,o){v.satisfied=false;var n=v.objInfo.body0;var m=v.objInfo.body1;var s=v.dirToBody;var x=i.numPenetrationRelaxationTimesteps*o;var u=0;var w;var r;var q=v.pointInfo.length;for(var p=0;p<q;p++){w=v.pointInfo[p];if(!n.get_movable()){w.denominator=0;}else{r=k.crossProduct(w.r0,s);f.multiplyVector(n.get_worldInvInertia(),r);w.denominator=n.get_invMass()+k.dotProduct(s,k.crossProduct(r,w.r0));}if(m.get_movable()){r=k.crossProduct(w.r1,s);f.multiplyVector(m.get_worldInvInertia(),r);w.denominator+=(m.get_invMass()+k.dotProduct(s,k.crossProduct(r,w.r1)));}if(w.denominator<b.NUM_TINY){w.denominator=b.NUM_TINY;}if(w.initialPenetration>i.allowedPenetration){w.minSeparationVel=(w.initialPenetration-i.allowedPenetration)/x;}else{u=-0.1*(w.initialPenetration-i.allowedPenetration)/i.allowedPenetration;if(u<b.NUM_TINY){u=b.NUM_TINY;}else{if(u>1){u=1;}}var t=(o>b.NUM_TINY)?o:b.NUM_TINY;w.minSeparationVel=u*(w.initialPenetration-i.allowedPenetration)/t;}if(w.minSeparationVel>this._maxVelMag){w.minSeparationVel=this._maxVelMag;}}};g.prototype.preProcessCollisionAccumulated=function(r,z){r.satisfied=false;var y=r.objInfo.body0;var w=r.objInfo.body1;var s=r.dirToBody;var x=i.numPenetrationRelaxationTimesteps*z;var q;var u;var I;var F=0;var G=b.NUM_TINY;var v=i.allowedPenetration;var E=r.pointInfo.length;for(var D=0;D<E;D++){u=r.pointInfo[D];I=u.initialPenetration-v;if(!y.get_movable()){u.denominator=0;}else{q=k.crossProduct(u.r0,s);f.multiplyVector(y.get_worldInvInertia(),q);u.denominator=y.get_invMass()+k.dotProduct(s,k.crossProduct(q,u.r0));}if(w.get_movable()){q=k.crossProduct(u.r1,s);f.multiplyVector(w.get_worldInvInertia(),q);u.denominator+=(w.get_invMass()+k.dotProduct(s,k.crossProduct(q,u.r1)));}if(u.denominator<G){u.denominator=G;}if(u.initialPenetration>v){u.minSeparationVel=I/x;}else{F=-0.1*I/v;if(F<G){F=G;}else{if(F>1){F=1;}}var C=(z>G)?z:G;u.minSeparationVel=F*I/C;}u.accumulatedNormalImpulse=0;u.accumulatedNormalImpulseAux=0;u.accumulatedFrictionImpulse=[0,0,0,0];var p=0.04;var H=new c(y,w,[0,0,0,0],[0,0,0,0]);for(var B=0,o=this._cachedContacts.length;B<o;B++){var m=this._cachedContacts[B];var A=m.pair;if(H.body0!=A.body0||H.body1==A.body1){continue;}var n=(A.body0==y)?k.get_lengthSquared(k.subtract(A.r,u.r0)):k.get_lengthSquared(k.subtract(A.r,u.r1));if(n<p){p=n;u.accumulatedNormalImpulse=this._cachedContacts[B].impulse.normalImpulse;u.accumulatedNormalImpulseAux=this._cachedContacts[B].impulse.normalImpulseAux;u.accumulatedFrictionImpulse=this._cachedContacts[B].impulse.frictionImpulse;if(this._cachedContacts[B].pair.body0!=y){u.accumulatedFrictionImpulse=b.getScaleVector(u.accumulatedFrictionImpulse,-1);}}}var t;if(u.accumulatedNormalImpulse!=0){t=b.getScaleVector(s,u.accumulatedNormalImpulse);t=k.add(t,u.accumulatedFrictionImpulse);y.applyBodyWorldImpulse(t,u.r0);w.applyBodyWorldImpulse(b.getScaleVector(t,-1),u.r1);}if(u.accumulatedNormalImpulseAux!=0){t=b.getScaleVector(s,u.accumulatedNormalImpulseAux);y.applyBodyWorldImpulseAux(t,u.r0);w.applyBodyWorldImpulseAux(b.getScaleVector(t,-1),u.r1);}}};g.prototype.processCollision=function(s,F){s.satisfied=true;var C=s.objInfo.body0;var B=s.objInfo.body1;var w=false;var u=s.dirToBody;var I=0;var J=0;var o=0;var E=0;var y;var v;var t;var z;var A=[0,0,0,0];var H=s.pointInfo.length;for(var G=0;G<H;G++){z=s.pointInfo[G];v=C.getVelocity(z.r0);t=B.getVelocity(z.r1);J=k.dotProduct(k.subtract(v,t),u);if(J>z.minSeparationVel){continue;}o=-1*s.mat.get_restitution()*J;if(o<this._minVelForProcessing){o=z.minSeparationVel;}I=o-J;if(I<=this._minVelForProcessing){continue;}E=I/z.denominator;y=b.getScaleVector(u,E);if(k.getSum(y)>0){A=k.add(A,y);C.applyBodyWorldImpulse(y,z.r0);B.applyBodyWorldImpulse(b.getScaleVector(y,-1),z.r1);w=true;}var q;var D=v.slice(0);if(B.get_movable()){D=k.subtract(v,t);}var r=k.subtract(D,b.getScaleVector(u,k.dotProduct(D,u)));var x=k.get_length(r);if(x>this._minVelForProcessing){var p=b.getDivideVector(r,-x);var m=0;if(C.get_movable()){q=k.crossProduct(z.r0,p);f.multiplyVector(C.get_worldInvInertia(),q);m=C.get_invMass()+k.dotProduct(p,k.crossProduct(q,z.r0));}if(B.get_movable()){q=k.crossProduct(z.r1,p);f.multiplyVector(B.get_worldInvInertia(),q);m+=(B.get_invMass()+k.dotProduct(p,k.crossProduct(q,z.r1)));}if(m>b.NUM_TINY){var n=x/m;p=b.getScaleVector(p,n);C.applyBodyWorldImpulse(p,z.r0);B.applyBodyWorldImpulse(b.getScaleVector(p,-1),z.r1);}}}if(w){C.setConstraintsAndCollisionsUnsatisfied();B.setConstraintsAndCollisionsUnsatisfied();C.dispatchCollisionEvent(B,A);B.dispatchCollisionEvent(C,b.getScaleVector(A,-1));}return w;};g.prototype.processCollisionAccumulated=function(s,K){s.satisfied=true;var x=false;var v=s.dirToBody;var H=s.objInfo.body0;var G=s.objInfo.body1;var Q=0;var S=0;var J=0;var A;var w;var u;var B;var C=[0,0,0,0];var P=s.pointInfo.length;for(var M=0;M<P;M++){B=s.pointInfo[M];w=H.getVelocity(B.r0);u=G.getVelocity(B.r1);S=k.dotProduct(k.subtract(w,u),v);Q=-S;if(B.minSeparationVel<0){Q+=B.minSeparationVel;}if(Math.abs(Q)>this._minVelForProcessing){J=Q/B.denominator;var E=B.accumulatedNormalImpulse;var L=(E+J);if(L<0){L=0;}B.accumulatedNormalImpulse=L;var t=L-E;A=b.getScaleVector(v,t);if(k.getSum(A)>0){C=k.add(C,A);H.applyBodyWorldImpulse(A,B.r0);G.applyBodyWorldImpulse(b.getScaleVector(A,-1),B.r1);x=true;}}w=H.getVelocityAux(B.r0);u=G.getVelocityAux(B.r1);S=k.dotProduct(k.subtract(w,u),v);Q=-S;if(B.minSeparationVel>0){Q+=B.minSeparationVel;}if(Math.abs(Q)>this._minVelForProcessing){J=Q/B.denominator;E=B.accumulatedNormalImpulseAux;var F=B.accumulatedNormalImpulseAux+J;if(F<0){F=0;}B.accumulatedNormalImpulseAux=F;t=F-E;A=b.getScaleVector(v,t);if(k.getSum(A)>0){C=k.add(C,A);H.applyBodyWorldImpulseAux(A,B.r0);G.applyBodyWorldImpulseAux(b.getScaleVector(A,-1),B.r1);x=true;}}if(B.accumulatedNormalImpulse>0){w=H.getVelocity(B.r0);u=G.getVelocity(B.r1);var q;var I=k.subtract(w,u);var r=k.subtract(I,b.getScaleVector(v,k.dotProduct(I,v)));var z=k.get_length(r);if(z>this._minVelForProcessing){var p=b.getScaleVector(b.getDivideVector(r,z),-1);var n=0;if(H.get_movable()){q=k.crossProduct(B.r0,p);f.multiplyVector(H.get_worldInvInertia(),q);n=H.invMass+k.dotProduct(p,k.crossProduct(q,B.r0));}if(G.get_movable()){q=k.crossProduct(B.r1,p);f.multiplyVector(G.get_worldInvInertia(),q);n+=(G.invMass+k.dotProduct(p,k.crossProduct(q,B.r1)));}if(n>b.NUM_TINY){var o=z/n;var m=b.getScaleVector(p,o);var R=B.accumulatedFrictionImpulse.slice(0);B.accumulatedFrictionImpulse=k.add(B.accumulatedFrictionImpulse,m);var O=k.get_length(B.accumulatedFrictionImpulse);var D=s.mat.friction*B.accumulatedNormalImpulse;if(O>b.NUM_TINY&&O>D){B.accumulatedFrictionImpulse=b.getScaleVector(B.accumulatedFrictionImpulse,D/O);}var y=k.subtract(B.accumulatedFrictionImpulse,R);H.applyBodyWorldImpulse(y,B.r0);G.applyBodyWorldImpulse(b.getScaleVector(y,-1),B.r1);}}}}if(x){H.setConstraintsAndCollisionsUnsatisfied();G.setConstraintsAndCollisionsUnsatisfied();H.dispatchCollisionEvent(G,C);G.dispatchCollisionEvent(H,b.getScaleVector(C,-1));}return x;};g.prototype.sortPositionX=function(n,m){if(n.get_currentState().position[0]<m.get_currentState().position[0]){return -1;}else{if(n.get_currentState().position[0]>m.get_currentState().position[0]){return 1;}else{return 0;}}};g.prototype.sortPositionY=function(n,m){if(n.get_currentState().position[1]<m.get_currentState().position[1]){return -1;}else{if(n.get_currentState().position[1]>m.get_currentState().position[1]){return 1;}else{return 0;}}};g.prototype.sortPositionZ=function(n,m){if(n.get_currentState().position[2]<m.get_currentState().position[2]){return -1;}else{if(n.get_currentState().position[2]>m.get_currentState().position[2]){return 1;}else{return 0;}}};g.prototype.doShockStep=function(p){if(Math.abs(this._gravity[0])>Math.abs(this._gravity[1])&&Math.abs(this._gravity[0])>Math.abs(this._gravity[2])){this._bodies=this._bodies.sort(this.sortPositionX);this._collisionSystem.collBody=this._collisionSystem.collBody.sort(this.sortPositionX);}else{if(Math.abs(this._gravity[1])>Math.abs(this._gravity[2])&&Math.abs(this._gravity[1])>Math.abs(this._gravity[0])){this._bodies=this._bodies.sort(this.sortPositionY);this._collisionSystem.collBody=this._collisionSystem.collBody.sort(this.sortPositionY);}else{if(Math.abs(this._gravity[2])>Math.abs(this._gravity[0])&&Math.abs(this._gravity[2])>Math.abs(this._gravity[1])){this._bodies=this._bodies.sort(this.sortPositionZ);this._collisionSystem.collBody=this._collisionSystem.collBody.sort(this.sortPositionZ);}}}var q;var m;var r=true;var s=[];var o;var n;while(r){r=false;for(var u=0;u<this._bodies.length;u++){var v=this._bodies[u];if(v.get_movable()&&v.get_doShockProcessing()){if(v.collisions.length==0||!v.isActive){v.internalSetImmovable();}else{m=false;s=v.collisions;for(var t=0;t<s.length;t++){q=s[t];o=q.objInfo.body0;n=q.objInfo.body1;if((o==v&&!n.get_movable())||(n==v&&!o.get_movable())){this.preProcessCollisionFast(q,p);this.processCollision(q,p);m=true;}}if(m){v.internalSetImmovable();r=true;}}}}}for(var u=0;u<this._bodies.length;u++){v=this._bodies[u];v.internalRestoreImmovable();s=v.collisions;for(var t=0;t<s.length;t++){q=s[t];this.preProcessCollisionFn(q,p);this.processCollisionFn(q,p);}}};g.prototype.updateContactCache=function(){this._cachedContacts=[];var r;var t;var m;for(var p=0,n=this._collisions.length;p<n;p++){var s=this._collisions[p];for(var o=0,q=s.pointInfo.length;o<q;o++){r=s.pointInfo[o];t=(s.objInfo.body0.id>s.objInfo.body1.id)?r.accumulatedFrictionImpulse:b.getScaleVector(r.accumulatedFrictionImpulse,-1);
m=new h();m.pair=new c(s.objInfo.body0,s.objInfo.body1,r.r0,r.r1);m.impulse=new a(r.accumulatedNormalImpulse,r.accumulatedNormalImpulseAux,r.accumulatedFrictionImpulse);this._cachedContacts.push(m);}}};g.prototype.handleAllConstraints=function(m,v,x){var y=this._collisions.length;var u;var q;for(var r=0,w=this._constraints.length;r<w;r++){this._constraints[r].preApply(m);}if(x){for(var r=0,w=this._collisions.length;r<w;r++){this.preProcessContactFn(this._collisions[r],m);this._collisions[r].mat.set_restitution(0);this._collisions[r].satisfied=false;}}else{for(var r=0,w=this._collisions.length;r<w;r++){this.preProcessCollisionFn(this._collisions[r],m);}}var t;var o;var s;for(var n=0;n<v;n++){o=false;for(var r=0,w=this._collisions.length;r<w;r++){u=this._collisions[r];if(!u.satisfied){if(x){t=this.processContactFn(u,m);o=o||t;}else{t=this.processCollisionFn(u,m);o=o||t;}}}for(var r=0,w=this._constraints.length;r<w;r++){var q=this._constraints[r];if(!q.get_satisfied()){t=q.apply(m);o=o||t;}}this.tryToActivateAllFrozenObjects();if(x){s=this._collisions.length;for(var p=y;p<s;p++){this._collisions[p].mat.set_restitution(0);this._collisions[p].satisfied=false;this.preProcessContactFn(this._collisions[p],m);}}else{s=this._collisions.length;for(p=y;p<s;p++){this.preProcessCollisionFn(this._collisions[p],m);}}y=this._collisions.length;if(!o){break;}}};g.prototype.handleAllEffects=function(){var n;var m=this._effects.length-1;if(m<0){return;}do{n=this._effects[m];if(n.enabled){n.Apply();}}while(m--);};g.prototype.activateObject=function(o){if(!o.get_movable()||o.isActive){return;}o.setActive();this._activeBodies.push(o);var q=this._collisions.length;this._collisionSystem.detectCollisions(o,this._collisions);var n;var r;for(var p=q,m=this._collisions.length;p<m;p++){n=this._collisions[p].objInfo.body0;r=this._collisions[p].dirToBody;if(n==o){n=this._collisions[p].objInfo.body1;r=b.getScaleVector(this._collisions[p].dirToBody,-1);}if(!n.isActive&&k.dotProduct(n.get_force(),r)<-b.NUM_TINY){this.activateObject(n);}}};g.prototype.dampAllActiveBodies=function(){for(var m=0,n=this._activeBodies.length;m<n;m++){_activeBody=this._activeBodies[m];_activeBody.dampForDeactivation();}};g.prototype.tryToActivateAllFrozenObjects=function(){for(var m=0,o=this._bodies.length;m<o;m++){var n=this._bodies[m];if(!n.isActive){if(n.getShouldBeActive()){this.activateObject(n);}else{if(n.getVelChanged()){n.setVelocity([0,0,0,0]);n.setAngVel([0,0,0,0]);n.clearVelChanged();}}}}};g.prototype.activateAllFrozenObjectsLeftHanging=function(){var m;for(var o=0,r=this._bodies.length;o<r;o++){var q=this._bodies[o];if(q.isActive){q.doMovementActivations();if(q.collisions.length>0){for(var n=0,p=q.collisions.length;n<p;n++){m=q.collisions[n].objInfo.body0;if(m==q){m=q.collisions[n].objInfo.body1;}if(!m.isActive){q.addMovementActivation(q.get_currentState().position,m);}}}}}};g.prototype.updateAllVelocities=function(n){for(var m=0,o=this._activeBodies.length;m<o;m++){_activeBody=this._activeBodies[m];_activeBody.updateVelocity(n);}};g.prototype.updateAllPositions=function(n){for(var m=0,o=this._activeBodies.length;m<o;m++){_activeBody=this._activeBodies[m];_activeBody.updatePositionWithAux(n);}};g.prototype.notifyAllPostPhysics=function(n){for(var m=0,o=this._bodies.length;m<o;m++){_body=this._bodies[m];_body.postPhysics(n);}};g.prototype.updateAllObject3D=function(){for(var m=0,n=this._bodies.length;m<n;m++){_body=this._bodies[m];_body.updateObject3D();}};g.prototype.limitAllVelocities=function(){for(var m=0,n=this._activeBodies.length;m<n;m++){_activeBody=this._activeBodies[m];_activeBody.limitVel();_activeBody.limitAngVel();}};g.prototype.tryToFreezeAllObjects=function(n){for(var m=0,o=this._activeBodies.length;m<o;m++){_activeBody=this._activeBodies[m];_activeBody.tryToFreeze(n);}};g.prototype.detectAllCollisions=function(n){for(var m=0,o=this._activeBodies.length;m<o;m++){_activeBody=this._activeBodies[m];_activeBody.storeState();}this.updateAllVelocities(n);this.updateAllPositions(n);for(var m=0,p=this._bodies.length;m<p;m++){_body=this._bodies[m];_body.collisions=[];}this._collisions=[];this._collisionSystem.detectAllCollisions(this._activeBodies,this._collisions);for(var m=0,o=this._activeBodies.length;m<o;m++){_activeBody=this._activeBodies[m];_activeBody.restoreState();}};g.prototype.copyAllCurrentStatesToOld=function(){for(var m=0,n=this._bodies.length;m<n;m++){_body=this._bodies[m];if(_body.isActive||_body.getVelChanged()){_body.copyCurrentStateToOld();}}};g.prototype.findAllActiveBodies=function(){this._activeBodies=[];for(var m=0,o=this._bodies.length;m<o;m++){var n=this._bodies[m];if(n.isActive){this._activeBodies.push(n);}}};g.prototype.integrate=function(n){this._doingIntegration=true;this.findAllActiveBodies();this.copyAllCurrentStatesToOld();this.getAllExternalForces(n);this.handleAllEffects();this.detectAllCollisions(n);this.handleAllConstraints(n,i.numCollisionIterations,false);this.updateAllVelocities(n);this.handleAllConstraints(n,i.numContactIterations,true);if(i.doShockStep){this.doShockStep(n);}this.dampAllActiveBodies();this.tryToFreezeAllObjects(n);this.activateAllFrozenObjectsLeftHanging();this.limitAllVelocities();this.updateAllPositions(n);this.notifyAllPostPhysics(n);this.updateAllObject3D();if(i.solverType=="ACCUMULATED"){this.updateContactCache();}for(var m=0,o=this._bodies.length;m<o;m++){_body=this._bodies[m];_body.clearForces();}this._doingIntegration=false;};d.PhysicsSystem=g;})(jigLib);(function(e){var j=e.Vector3DUtil;var a=e.JNumber3D;var b=e.JChassis;var d=e.JWheel;var f=e.PhysicsSystem;var c=Math,i=c.abs,h=c.sqrt;var g=function(k){this._chassis=new b(this,k);this._wheels=[];this._steerWheels=[];this._destSteering=this._destAccelerate=this._steering=this._accelerate=this._HBrake=0;this.setCar();};g.prototype._maxSteerAngle=null;g.prototype._steerRate=null;g.prototype._driveTorque=null;g.prototype._destSteering=null;g.prototype._destAccelerate=null;g.prototype._steering=null;g.prototype._accelerate=null;g.prototype._HBrake=null;g.prototype._chassis=null;g.prototype._wheels=null;g.prototype._steerWheels=null;g.prototype.setCar=function(m,l,k){if(m==null){m=45;}if(l==null){l=4;}if(k==null){k=500;}this._maxSteerAngle=m;this._steerRate=l;this._driveTorque=k;};g.prototype.setupWheel=function(y,o,t,w,m,D,C,p,s,z){if(t==null){t=2;}if(w==null){w=2;}if(m==null){m=3;}if(D==null){D=10;}if(C==null){C=0.5;}if(p==null){p=0.5;}if(s==null){s=1;}if(z==null){z=1;}var n=f.getInstance().get_gravity().slice(0);var v=this._chassis.get_mass();var q=0.25*v;var A=j.get_length(n);j.normalize(n);var k=a.getScaleVector(n,-1);var u=q*A/(C*m);var r=0.015*D*D*v;var l=p/2;var x=A*q;var B=new d(this);B.name=y;B.setup(o,k,u,m,r,D,t,w,l,s,z,x);this._wheels.push(B);};g.prototype.setAccelerate=function(k){this._destAccelerate=k;};g.prototype.setSteer=function(p,o){this._destSteering=o;this._steerWheels=[];var m=null;for(var n=0,k=p.length;n<k;n++){m=this.getWheel(p[n]);if(m){this._steerWheels.push(m);}}};g.prototype.findWheel=function(m){for(var n=0,k=this._wheels.length;n<k;n++){if(this._wheels[n].name==m){return true;}}return false;};g.prototype.getWheel=function(k){for(var l=0;l<this._wheels.length;l++){if(this._wheels[l].name==k){return this._wheels[l];}}return null;};g.prototype.setHBrake=function(k){this._HBrake=k;};g.prototype.addExternalForces=function(l){for(var k=0,m=this._wheels.length;k<m;k++){this._wheels[k].addForcesToCar(l);}};g.prototype.postPhysics=function(l){for(var o=0,t=this._wheels.length;o<t;o++){this._wheels[o].update(l);}var k=l;var q=l*this._steerRate;var m=this._destAccelerate-this._accelerate;if(m<-k){m=-k;}else{if(m>k){m=k;}}this._accelerate+=m;var r=this._destSteering-this._steering;if(r<-q){r=-q;}else{if(r>q){r=q;}}this._steering+=r;for(var o=0;o<this._wheels.length;o++){this._wheels[o].addTorque(this._driveTorque*this._accelerate);this._wheels[o].setLock(this._HBrake>0.5);}var n=i(this._maxSteerAngle*this._steering);var p=(this._steering>0)?1:-1;for(var o=0,s=this._steerWheels.length;o<s;o++){this._steerWheels[o].setSteerAngle(p*n);}};g.prototype.getNumWheelsOnFloor=function(m){var l=0;for(var k=0,n=this._wheels.length;k<n;k++){if(this._wheels[k].getOnFloor()){l++;}}return l;};e.JCar=g;})(jigLib);(function(b){var a=b.JBox;var c=function(e,g,f,h,d){if(f==null){f=40;}if(h==null){h=70;}if(d==null){d=30;}this.Super(g,f,h,d);this._car=e;};b.extend(c,b.JBox);c.prototype._car=null;c.prototype.addExternalForces=function(d){this.clearForces();this.addGravity();this._car.addExternalForces(d);};c.prototype.postPhysics=function(d){this._car.postPhysics(d);};b.JChassis=c;})(jigLib);(function(e){var n=e.Vector3DUtil;var g=e.JMatrix3D;var a=e.JNumber3D;var o=e.JSegment;var i=e.JConfig;var h=e.PhysicsSystem;var b=Math,f=b.PI,d=b.min,j=b.max,l=b.cos,m=b.abs,k=b.sqrt;var c=function(p){this._car=p;};c.prototype.name=null;c.prototype.noslipVel=0.2;c.prototype.slipVel=0.4;c.prototype.slipFactor=0.7;c.prototype.smallVel=3;c.prototype._car=null;c.prototype._pos=null;c.prototype._axisUp=null;c.prototype._spring=null;c.prototype._travel=null;c.prototype._inertia=null;c.prototype._radius=null;c.prototype._sideFriction=null;c.prototype._fwdFriction=null;c.prototype._damping=null;c.prototype._numRays=null;c.prototype._angVel=null;c.prototype._steerAngle=null;c.prototype._torque=null;c.prototype._driveTorque=null;c.prototype._axisAngle=null;c.prototype._displacement=null;c.prototype._upSpeed=null;c.prototype._rotDamping=null;c.prototype._normalForce=null;c.prototype._locked=null;c.prototype._lastDisplacement=null;c.prototype._lastOnFloor=null;c.prototype._angVelForGrip=null;c.prototype.worldPos=null;c.prototype.worldAxis=null;c.prototype.wheelFwd=null;c.prototype.wheelUp=null;c.prototype.wheelLeft=null;c.prototype.wheelRayEnd=null;c.prototype.wheelRay=null;c.prototype.groundUp=null;c.prototype.groundLeft=null;c.prototype.groundFwd=null;c.prototype.wheelPointVel=null;c.prototype.rimVel=null;c.prototype.worldVel=null;c.prototype.wheelCentreVel=null;c.prototype._collSystem=null;c.prototype.setup=function(x,u,z,q,v,w,r,t,s,y,A,p){if(z==null){z=0;}if(q==null){q=0;}if(v==null){v=0;}if(w==null){w=0;}if(r==null){r=0;}if(t==null){t=0;}if(s==null){s=0;}if(y==null){y=0;}if(A==null){A=0;}if(p==null){p=0;}this._pos=x;this._axisUp=u;this._spring=z;this._travel=q;this._inertia=v;this._radius=w;this._sideFriction=r;this._fwdFriction=t;this._damping=s;this._numRays=y;this._drive=A;this._normalForce=p;this._torque=0;this.reset();};c.prototype.addTorque=function(p){this._driveTorque+=p;};c.prototype.setLock=function(p){this._locked=p;};c.prototype.setSteerAngle=function(p){this._steerAngle=p;};c.prototype.getSteerAngle=function(){return this._steerAngle;};c.prototype.getPos=function(){return this._pos;};c.prototype.getLocalAxisUp=function(){return this._axisUp;};c.prototype.getActualPos=function(){return n.add(this._pos,a.getScaleVector(this._axisUp,this._displacement));};c.prototype.getRadius=function(){return this._radius;};c.prototype.getDisplacement=function(){return this._displacement;};c.prototype.getAxisAngle=function(){return this._axisAngle;};c.prototype.getRollAngle=function(){return 0.1*this._angVel*180/f;};c.prototype.setRotationDamping=function(p){this._rotDamping=p;};c.prototype.getRotationDamping=function(){return this._rotDamping;};c.prototype.getOnFloor=function(){return this._lastOnFloor;};c.prototype.addForcesToCar=function(O){var q=[0,0,0,0];this._lastDisplacement=this._displacement;this._displacement=0;var X=this._car._chassis;worldPos=this._pos.slice(0);g.multiplyVector(X.get_currentState().get_orientation(),worldPos);worldPos=n.add(X.get_currentState().position,worldPos);worldAxis=this._axisUp.slice(0);g.multiplyVector(X.get_currentState().get_orientation(),worldAxis);wheelFwd=X.get_currentState().getOrientationCols()[2].slice(0);g.multiplyVector(g.getRotationMatrix(worldAxis[0],worldAxis[1],worldAxis[2],this._steerAngle/180*2*Math.PI),wheelFwd);wheelUp=worldAxis;wheelLeft=n.crossProduct(wheelUp,wheelFwd);n.normalize(wheelLeft);var W=2*this._radius+this._travel;wheelRayEnd=n.subtract(worldPos,a.getScaleVector(worldAxis,this._radius));wheelRay=new o(n.add(wheelRayEnd,a.getScaleVector(worldAxis,W)),a.getScaleVector(worldAxis,-W));if(this._collSystem==null){this._collSystem=h.getInstance().getCollisionSystem();}var U=10;var s=d(this._numRays,U);var w=[];var S=[];var A=(2*this._radius)/(s+1);var V=A;this._lastOnFloor=false;var y;var H;var C=0;var K=0;var p=null;for(K=0;K<s;K++){w[K]={};y=(V+K*A)-this._radius;H=this._radius*(1-l(90*(y/this._radius)*f/180));p=wheelRay.clone();p.origin=n.add(p.origin,n.add(a.getScaleVector(wheelFwd,y),a.getScaleVector(wheelUp,H)));if(this._collSystem.segmentIntersect(w[K],p,X)){this._lastOnFloor=true;if(w[K].fracOut<w[C].fracOut){C=K;}}S[K]=p;}if(!this._lastOnFloor){return false;}var u=w[C].fracOut;var N=w[C].posOut;var L=w[C].bodyOut;var Q=worldAxis.slice(0);if(s>1){for(K=0;K<s;K++){var F=w[K].fracOut;if(F<=1){Q=n.add(Q,a.getScaleVector(n.subtract(worldPos,S[K].getEnd()),1-F));}}n.normalize(Q);}else{Q=w[C].normalOut;}wheelFwd=n.crossProduct(wheelLeft,Q);this._displacement=W*(1-u);if(this._displacement<0){this._displacement=0;}var P=X.get_mass();var E=P/4;var r=L.get_friction();var J=X.getVelocity(this._pos);var x=this._displacement;if(this._displacement>this._travel){this._displacement=this._travel;var v=n.dotProduct(J,Q)/O*E;v=v*2*L.get_restitution()/10;z=a.getScaleVector(Q,-v);q=n.add(q,z);}z=a.getScaleVector(this._axisUp,this._spring*this._displacement+this._upSpeed*this._damping);q=n.add(q,z);groundUp=Q;groundLeft=n.crossProduct(Q,wheelFwd);n.normalize(groundLeft);groundFwd=n.crossProduct(groundLeft,groundUp);var R=a.getScaleVector(n.crossProduct(groundLeft,n.subtract(N,worldPos)),-this._angVel);var t=a.getScaleVector(groundFwd,n.dotProduct(J,groundFwd));var B=this._fwdFriction*r;var z=a.getScaleVector(n.subtract(R,t),E/O/this._radius*B);var G=n.get_length(z);if(G>this._normalForce*B){z=a.getScaleVector(z,this._normalForce*B/G);}q=n.add(q,z);this._torque-=n.dotProduct(n.subtract(R,t),groundFwd)/this._radius*E/O;this._angVelForGrip=n.dotProduct(J,groundFwd)/this._radius;var D=n.dotProduct(J,groundLeft);var B=this._sideFriction*r;var T=a.getScaleVector(groundLeft,-D*B);var z=a.getScaleVector(T,E/O/this._radius);var G=n.get_length(z);if(G>this._normalForce*B){z=a.getScaleVector(z,this._normalForce*B/G);}q=n.add(q,z);X.addWorldForce(q,N);if(L.get_movable()){var I=500;var M=I*L.get_mass();if(n.get_lengthSquared(q)>(M*M)){q=a.getScaleVector(q,M/n.get_length(q));}L.addWorldForce(a.getScaleVector(q,-1),N);}return true;};c.prototype.update=function(q){if(q<=0){return;}var p=this._angVel;this._upSpeed=(this._displacement-this._lastDisplacement)/j(q,a.NUM_TINY);if(this._locked){this._angVel=0;this._torque=0;}else{this._angVel+=(this._torque*q/this._inertia);this._torque=0;if(((p>this._angVelForGrip)&&(this._angVel<this._angVelForGrip))||((p<this._angVelForGrip)&&(this._angVel>this._angVelForGrip))){this._angVel=this._angVelForGrip;}this._angVel+=this._driveTorque*q/this._inertia*this._drive;this._driveTorque=0;if(this._angVel<-100){this._angVel=-100;}else{if(this._angVel>100){this._angVel=100;}}this._angVel*=this._rotDamping;this._axisAngle+=(this._angVel*q*180/f);}};c.prototype.reset=function(){this._angVel=0;this._steerAngle=0;this._torque=0;this._driveTorque=0;this._axisAngle=0;this._displacement=0;this._upSpeed=0;this._locked=false;this._lastDisplacement=0;this._lastOnFloor=false;this._angVelForGrip=0;this._rotDamping=0.99;};e.JWheel=c;})(jigLib);