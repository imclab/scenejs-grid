<!DOCTYPE html>
<html lang="en">
<head>
    <title>SceneJS.Engine</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            background-color: #000000;
            margin: 0px;
            overflow: auto;
            height: 100%;
        }

        #info {
            position: absolute;
            top: 0px;
            width: 100%;
            color: #ffffff;
            padding: 5px;
            font-family: Monospace;
            font-size: 13px;
            text-align: center;
        }

        #theCanvas {
            width: 100%;
            height: 100%; /*position: fixed;*/

        }

        #footer {
        /*position: relative;*/
            width: 100%;
            height: 20px;
            color: #ffffff;
            padding: 10px;
            font-family: Monospace;
            font-size: 13px;
            text-align: left;
            clear: both;
        }

        a {
            color: #ffffff;
        }

        a:hover {
            color: #0080ff;
        }
    </style>
</head>
<body>

<link href="css/jquery.terminal.css" rel="stylesheet"/>

<div id="container"></div>
<!--<div id="info">-->
<!--<a href="http://github.com/xeolabs/scenejs" target="_blank">SceneJS.Engine<br/>-->
<!--</div>-->

<div id="tilda"></div>

<canvas id="theCanvas"></canvas>

<div id="footer">
    <span>SceneJS Engine&nbsp;</span><span id="status">SceneJS Engine&nbsp;</span>
</div>

<script src="js/lib/require.js"></script>
<script src="js/lib/jquery/jquery-lib.1.7.1.min.js"></script>
<script src="js/lib/jquery/jquery.mousewheel-min.js"></script>
<script src="js/lib/jquery/jquery.terminal-min.js"></script>

<script src="js/lib/scenejs/scenejs.js"></script>
<script src="js/lib/scenejs/scenejs.box.js"></script>
<script src="js/lib/scenejs/scenejs.sphere.js"></script>


<!--[if IE]>
<style>
body {
    margin: 0;
    padding: 0;
}
.tilda {
    position: absolute;
}
</style>
<script>
jQuery(document).ready(function($) {
   $(window).scroll(function() {
      $('.tilda').each(function() {
         $(this).css({top: $('body').attr('scrollTop')});
      });
   });
});
</script>
<![endif]-->

<script>

String.prototype.strip = function(char) {
    return this.replace(new RegExp("^" + char + "*"), '').
            replace(new RegExp(char + "*$"), '');
};


$.extend_if_has = function(desc, source, array) {
    for (var i = array.length; i--;) {
        if (typeof source[array[i]] != 'undefined') {
            desc[array[i]] = source[array[i]];
        }
    }
    return desc;
};


(function($) {
    $.fn.tilda = function(eval, options) {

        if ($('body').data('tilda')) {
            return $('body').data('tilda').terminal;
        }

        this.addClass('tilda');

        options = options || {};

        eval = eval || function(command, term) {
            term.echo("you don't set eval for tilda");
        };

        var settings = {
            prompt: 'ready> ',
            name: 'SceneJS Grid',
            height: "90%",
            enabled: false,
            greetings: 'SceneJS Grid Console V0.1.0.0\n' +
                       '(C) 2012 Lindsay Kay\n' +
                       'lindsay.kay@xeolabs.com\n\n'
        };

        if (options) {
            $.extend(settings, options);
        }

        this.append('<div class="td"></div>');

        var self = this;

        var td = this.find('.td');

        self.terminal = td.terminal(eval, settings);

        var focus = false;

        $(document.documentElement).keypress(function(e) {
            if (e.which == 96) {
                self.slideToggle('fast');
                self.terminal.set_command('');
                self.terminal.focus(focus = !focus);
                self.terminal.attr({
                    scrollTop: self.terminal.attr("scrollHeight")
                });
            }
        });

        $('body').data('tilda', this);

        this.hide();

        return self;
    };
})(jQuery);

//--------------------------------------------------------------------------

jQuery(document).ready(
        function($) {

            initEngine(
                    function(grid) {

                        initTerminal(grid, $);
                    });

        });

/**
 * Bootstraps the grid
 */
function initEngine(ok) {

    requirejs.config({

        //By default load any module IDs from js/lib
        baseUrl: 'js/lib',

        //except, if the module ID starts with "app",
        //load it from the js/app directory. paths
        //config is relative to the baseUrl, and
        //never includes a ".js" extension since
        //the paths config could be for a directory.
        paths: {
            app: '../app'
        }
    });

    require(['app/grid'], // Load the grid
            function (grid) {

                window.grid = grid; // Make grid available to boot script

                bindEngineTaskIndicator(grid);

                grid.send({ // Load native modules
                    action: "module.load",
                    modules: ["url/url"]
                },
                        function() {

                            /* Get URL params - we're getting them off the hash so that we can
                             * do this sort of thing:
                             *
                             * http://htmlpreview.github.com/?https://raw.github.com/xeolabs/.../index.html#script=tankDemo
                             */
                            grid.send({
                                action: "url.getHashParams"
                            },
                                    function (data) {

                                        var script = data["script"];

                                        if (script) { // Load boot script
                                            require(["../../content/scripts/" + script],
                                                    function() {
                                                        ok(grid); // Booted off script
                                                    });
                                        } else {
                                            ok(grid); // Done
                                        }
                                    });
                        });
            });
}

/* Indicates when background tasks are running inside the grid
 */
function bindEngineTaskIndicator(grid) {

    var numTasks = 0;

    var tasks = {};

    grid.onEvent("taskstarted",
            function(params) {

                var taskId = params.taskId;
                var description = params.description;

                numTasks++;

                tasks[taskId] = "[task running]: " + description;

                showTasks();
            });

    grid.onEvent("taskdone",
            function(params) {

                var taskId = params.taskId;

                numTasks--;

                delete tasks[taskId];

                showTasks();
            });

    function showTasks() {

        var str = [];

        for (var taskId in tasks) {
            str.push(tasks[taskId]);
        }

        $("#status").text(str.join(""));
    }
}

/* Initialises the terminal and binds grid output and errors notifications
 * so that they are display in the terminal
 */
function initTerminal(grid, $) {

    var dataEcho = false;

    $('#tilda').tilda(
            function(command, terminal) {

                if (!dataEcho) {

                    grid.onEvent("data",
                            function (params) { // Echo action responses
                                if (params) {
                                    terminal.echo(JSON.stringify(params, null, 4));
                                }
                            });

                    grid.onEvent("error",
                            function (params) { // Echo action responses
                                if (params) {
                                    terminal.echo(JSON.stringify(params, null, 4)).css("color", "red");
                                }
                            });

                    dataEcho = true;
                }

                eval(command);
            });
}

</script>
</body>
</html>