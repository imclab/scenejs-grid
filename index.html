<!DOCTYPE html>
<html lang="en">
<head>
    <title>SceneJS Grid - A Modular World Manager</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            background-color: #000000;
            margin: 0px;
            overflow: auto;
            height: 100%;
        }

        #info {
            position: absolute;
            top: 0px;
            width: 100%;
            color: #ffffff;
            padding: 5px;
            font-family: Monospace;
            font-size: 13px;
            text-align: center;
        }

        #theCanvas {
            width: 100%;
            height: 100%; /*position: fixed;*/

        }

        #footer {
        /*position: relative;*/
            width: 100%;
            height: 20px;
            color: #ffffff;
            padding: 10px;
            font-family: Monospace;
            font-size: 13px;
            text-align: left;
            clear: both;
        }

        a {
            color: #ffffff;
        }

        a:hover {
            color: #0080ff;
        }

        #modal {
            font-family: Monospace;
            display: none;
            background: #202020;
            border: solid gray 1px;
            width: 600px;
            height: 400px;
            padding: 20px;
        }

        #modal h1 {

            font-size: 32px;
            color: #ffffff;
        }

        #modal h2 {
            font-family: Monospace;
            font-size: 16px;
            color: #ffffff;
            padding-bottom: 20px;
        }

        #modal p {
            font-family: Monospace;
            font-size: 12px;
        }

        #modal a {
            color: #ccff66;
        }

        #modal a:hover {
            color: #ffffff;
        }

        #modal-boot-script {
            color: #ffffff;
            padding-top: 10px;
        }

        #modal-message {
            font-family: Monospace;
            font-size: 16px;
            color: #ffffff;
            padding-top: 10px;
        }

        #modal-message h3.wait {
            color: #ff6600;
        }

        #modal-message h3.ready {
            color: #66ff00;
        }

        #modal ul {
            color: #ffffff;
        }

        #modal li {
            color: #66ff00;
            padding-bottom: 7px;
        }

        #modal .spinner {
            padding-top: 30px;
        }
    </style>
</head>
<body>

<a href="https://github.com/xeolabs/scenejs-grid" target="_blank"><img
        style="position: absolute; top: 0; right: 0; border: 0;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
        alt="Fork me on GitHub"></a>

<link href="css/jquery.terminal.css" rel="stylesheet"/>

<div id="container"></div>
<!--<div id="info">-->
<!--<a href="http://github.com/xeolabs/scenejs" target="_blank">SceneJS.Engine<br/>-->
<!--</div>-->

<div id="tilda"></div>

<canvas id="theCanvas"></canvas>

<div id="modal">
    <h1>scenejs grid</h1>

    <h2>a modular world engine</h2>

    <ul>
        <li>the grid is an extensible world engine that lives at <a
                href="https://github.com/xeolabs/scenejs-grid" target="_blank">GitHub</a></li>

        <li>it's built on <a href="http://scenejs.org" target="_blank">SceneJS</a>, and is served straight out of the
            repository
        </li>

        <li>you can contribute to the grid by forking the repository and adding modules and scripts - then we'll merge
            them and they will be available here
        </li>
        <li>type '~' to open a command shell to speak to the grid
        </li>
        <li>read the documentation <a
                href="https://github.com/xeolabs/scenejs-grid" target="_blank">here</a>
        </li>
    </ul>
    <!--<ul>-->
    <!--<li>blog page</li>-->
    <!--<li>fork at github</li>-->
    <!--<li>type '~' to open console</li>-->
    <!--</ul>-->

    <div id="modal-boot-script">
        <p>using boot script: <span id="modal-boot-script-name"></span></p>
    </div>

    <div id="modal-message">
        <h3 class="wait">loading the grid, just a moment..</h3>
    </div>


    <!--<div id="modal-wait-or-go">-->
    <!--<img class="spinner" src="images/spinner.gif" alt="">-->
    <!--</div>-->
</div>

<div id="footer">
    <!--<span>SceneJS Engine&nbsp;</span><span id="status">SceneJS Engine&nbsp;</span>-->
</div>

<script src="js/lib/require.js"></script>

<script src="js/lib/jquery/jquery-lib.1.7.1.min.js"></script>
<script src="js/lib/jquery/jquery.mousewheel-min.js"></script>
<script src="js/lib/jquery/jquery.terminal-min.js"></script>
<script src="js/lib/jquery/jquery.bpopup-0.7.0.min.js"></script>


<!--[if IE]>
<style>
body {
    margin: 0;
    padding: 0;
}
.tilda {
    position: absolute;
}
</style>
<script>
jQuery(document).ready(function($) {
   $(window).scroll(function() {
      $('.tilda').each(function() {
         $(this).css({top: $('body').attr('scrollTop')});
      });
   });
});
</script>
<![endif]-->

<script>

String.prototype.strip = function(char) {
    return this.replace(new RegExp("^" + char + "*"), '').
            replace(new RegExp(char + "*$"), '');
};


$.extend_if_has = function(desc, source, array) {
    for (var i = array.length; i--;) {
        if (typeof source[array[i]] != 'undefined') {
            desc[array[i]] = source[array[i]];
        }
    }
    return desc;
};


(function($) {
    $.fn.tilda = function(eval, options) {

        if ($('body').data('tilda')) {
            return $('body').data('tilda').terminal;
        }

        this.addClass('tilda');

        options = options || {};

        eval = eval || function(command, term) {
            term.echo("you don't set eval for tilda");
        };

        var settings = {
            prompt: 'ready> ',
            name: 'SceneJS Grid',
            height: "90%",
            enabled: false,
            greetings: 'SceneJS Grid Console V0.1.0.0\n' +
                       '(C) 2012 Lindsay Kay\n' +
                       'lindsay.kay@xeolabs.com\n\n'
        };

        if (options) {
            $.extend(settings, options);
        }

        this.append('<div class="td"></div>');

        var self = this;

        var td = this.find('.td');


        self.terminal = td.terminal(eval, settings);

        var focus = false;

        $(document.documentElement).keypress(
                function(e) {
                    if (e.which == 96) {
                        self.slideToggle('fast');
                        self.terminal.set_command('');
                        self.terminal.focus(focus = !focus);
                        self.terminal.attr({
                            scrollTop: self.terminal.attr("scrollHeight")
                        });
                    }
                });

        $('body').data('tilda', this);

        this.hide();

        return self;
    };
})(jQuery);

//--------------------------------------------------------------------------

jQuery(document).ready(
        function($) {

            $("body").click(false);

            $("#modal").bPopup({
                //  modalClose: false
            });

            initEngine(
                    function(grid) {

                        initTerminal(grid, $);

                        $("#modal-message").html("<h3 class='ready'>ready - click to start</h3>");

                        $("body").unbind('click');

                        $("#modal").click(
                                function() {
                                    $("#modal").bPopup().close();
                                });
                    });

        });

/**
 * Bootstraps the grid
 */
function initEngine(ok) {

    /* Get selected boot script name and path off URL hash. We use the hash so that the full URL to the
     * engine instance can be used a parameter for web service like this:
     * http://htmlpreview.github.com/?https://raw.github.com/xeolabs/scenejs-grid/master/index.html#script=demos/teapot
     */
    var urlHashParams = getURLHashParams();
    var bootScriptName = urlHashParams["script"];
    var bootScriptPath;

    /* Tell user which script we're booting off, if any
     */
    if (bootScriptName) {
        bootScriptPath = "content/scripts/" + bootScriptName + ".js";
        $("#modal-boot-script-name").html("<a href='" + bootScriptPath + "' target='_blank'>" + bootScriptName + ".js</a>");
    } else {
        $("#modal-boot-script-name").html("(no script selected)");
    }

    /* Configure RequireJS
     */
    requirejs.config({

        //By default load any module IDs from js/lib
        baseUrl: 'js/lib',

        //except, if the module ID starts with "app",
        //load it from the js/app directory. paths
        //config is relative to the baseUrl, and
        //never includes a ".js" extension since
        //the paths config could be for a directory.
        paths: {
            app: '../app'
        }
    });


    /* We'll load SceneJS libs using require.js so that the
     * loading dialog can keep user entertained while they load
     */
    require([ // SceneJS core
        'scenejs/scenejs'
    ],
            function() {

                require([  // SceneJS plugins, which depend on SceneJS core
                    'scenejs/scenejs.box',  // TODO: these are loaded even if not needed - should be loaded on demand
                    'scenejs/scenejs.sphere',
                    'scenejs/scenejs.teapot'
                ],
                        function() {

                            require([ // The grid engine
                                'app/grid',
                                'app/modules'
                            ],
                                    function (grid) {

                                        window.grid = grid; // Make grid available to boot scripts

                                        bindGridErrors(grid);

                                        bindEngineTaskIndicator(grid);

                                        /* Load boot script
                                         */
                                        if (bootScriptName) {

                                            require(["../../content/scripts/" + bootScriptName],
                                                    function() {
                                                        ok(grid); // Booted off script
                                                    });
                                        } else {
                                            ok(grid); // Done
                                        }
                                    });
                        });
            });
}

/* Handle errors from the grid
 */
function bindGridErrors(grid) {

    grid.onEvent(
            "error",
            function(error) {
                alert(JSON.stringify(error));
            });
}

/* Indicates when background tasks are running inside the grid
 */
function bindEngineTaskIndicator(grid) {

    var numTasks = 0;

    var tasks = {};

    grid.onEvent("taskstarted",
            function(params) {

                var taskId = params.taskId;
                var description = params.description;

                numTasks++;

                tasks[taskId] = "[task running]: " + description;

                showTasks();
            });

    grid.onEvent("taskdone",
            function(params) {

                var taskId = params.taskId;

                numTasks--;

                delete tasks[taskId];

                showTasks();
            });

    function showTasks() {

        var str = [];

        for (var taskId in tasks) {
            str.push(tasks[taskId]);
        }

        $("#status").text(str.join(""));
    }
}

/* Initialises the terminal and binds grid output and errors notifications
 * so that they are display in the terminal
 */
function initTerminal(grid, $) {

    var dataEcho = false;

    $('#tilda').tilda(
            function(command, terminal) {

                if (!dataEcho) {

                    grid.onEvent("data",
                            function (params) { // Echo action responses
                                if (params) {
                                    terminal.echo(JSON.stringify(params, null, 4)).css("color", "green");
                                }
                            });

                    grid.onEvent("error",
                            function (params) { // Echo action responses
                                if (params) {
                                    terminal.echo(JSON.stringify(params, null, 4)).css("color", "red");
                                }
                            });

                    requirejs.onError = function (err) {

                        if (err.requireType === 'timeout') {

                            var msg = "load timeout: " + err.requireModules + "\nhttps://github.com/xeolabs/scenejs-grid/wiki/Module-load-timeout";

                            terminal.echo(msg).css("color", "red");

                        } else {
                            terminal.echo("unhandled exception thrown by Require.JS:").css("color", "red");
                            terminal.echo(JSON.stringify(err, null, 4)).css("color", "red");
                        }
                    };

                    dataEcho = true;
                }

                //try {
                eval(command);
                //                } catch (e) {
                //                    terminal.echo("uncaught exception: " + (e.message || e) + " - check browser console").css("color", "red");
                //                }
            });
}


function getURLHashParams() {

    var hashParams = {};

    var e;
    var a = /\+/g;  // Regex for replacing addition symbol with a space
    var r = /([^&;=]+)=?([^&;]*)/g;
    var d = function (s) {
        return decodeURIComponent(s.replace(a, " "));
    };
    var q = window.location.hash.substring(1);

    while (e = r.exec(q)) {
        hashParams[d(e[1])] = d(e[2]);
    }

    return hashParams;
}

</script>
</body>
</html>